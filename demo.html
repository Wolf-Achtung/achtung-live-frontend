<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Demo | achtung.live â€“ Teste den Airbag fÃ¼r digitale Kommunikation">
  <meta name="robots" content="index,follow">
  <meta name="theme-color" content="#800000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="achtung.live">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <title>Demo | achtung.live</title>
</head>
<body>
  <!-- PWA Install Prompt (hidden by default) -->
  <div id="pwaInstallPrompt" class="pwa-install-prompt" style="display:none;">
    <span class="pwa-icon">ğŸ“±</span>
    <span class="pwa-text" data-i18n="pwa.installHint">App installieren fÃ¼r Offline-Nutzung</span>
    <button class="pwa-install-btn" onclick="installPWA()">Installieren</button>
    <button class="pwa-close-btn" onclick="dismissPWAPrompt()">&times;</button>
  </div>

  <!-- Offline Indicator -->
  <div id="offlineIndicator" class="offline-indicator" style="display:none;">
    <span class="offline-icon">ğŸ“´</span>
    <span class="offline-text">Offline - EingeschrÃ¤nkte Funktionen</span>
  </div>

  <!-- Accessibility Toolbar -->
  <div class="accessibility-toolbar" role="toolbar" aria-label="Barrierefreiheit-Einstellungen">
    <div class="a11y-group">
      <span class="a11y-label" data-i18n="a11y.font">Schrift:</span>
      <button class="a11y-btn" onclick="changeFontSize(-1)" aria-label="Schrift verkleinern" title="Kleinere Schrift">A-</button>
      <button class="a11y-btn" onclick="changeFontSize(0)" aria-label="Standard SchriftgrÃ¶ÃŸe" title="Standard">A</button>
      <button class="a11y-btn" onclick="changeFontSize(1)" aria-label="Schrift vergrÃ¶ÃŸern" title="GrÃ¶ÃŸere Schrift">A+</button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="contrastToggle" onclick="toggleHighContrast()" aria-label="Hoher Kontrast umschalten" title="Hoher Kontrast">
        <span class="a11y-icon">â—</span>
        <span class="a11y-text" data-i18n="a11y.contrast">Kontrast</span>
      </button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="simpleLangToggle" onclick="toggleSimpleLanguage()" aria-label="Einfache Sprache umschalten" title="Einfache Sprache fÃ¼r besseres VerstÃ¤ndnis">
        <span class="a11y-icon">ğŸ“–</span>
        <span class="a11y-text" data-i18n="a11y.simpleLang">Einfache Sprache</span>
      </button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="realtimeToggle" onclick="toggleRealtime()" aria-label="Live-PrÃ¼fung umschalten" title="Text wird wÃ¤hrend des Tippens geprÃ¼ft">
        <span class="a11y-icon">âš¡</span>
        <span class="a11y-text" data-i18n="a11y.liveCheck">Live-PrÃ¼fung</span>
      </button>
    </div>
    <!-- Language Switcher -->
    <div class="a11y-group lang-switcher">
      <button class="a11y-btn lang-btn active" data-lang="de" onclick="switchLanguage('de')" title="Deutsch">
        <span class="lang-flag">ğŸ‡©ğŸ‡ª</span>
        <span class="lang-code">DE</span>
      </button>
      <button class="a11y-btn lang-btn" data-lang="en" onclick="switchLanguage('en')" title="English">
        <span class="lang-flag">ğŸ‡¬ğŸ‡§</span>
        <span class="lang-code">EN</span>
      </button>
      <button class="a11y-btn lang-btn" data-lang="fr" onclick="switchLanguage('fr')" title="FranÃ§ais">
        <span class="lang-flag">ğŸ‡«ğŸ‡·</span>
        <span class="lang-code">FR</span>
      </button>
      <button class="a11y-btn lang-btn" data-lang="es" onclick="switchLanguage('es')" title="EspaÃ±ol">
        <span class="lang-flag">ğŸ‡ªğŸ‡¸</span>
        <span class="lang-code">ES</span>
      </button>
      <button class="a11y-btn lang-btn" data-lang="it" onclick="switchLanguage('it')" title="Italiano">
        <span class="lang-flag">ğŸ‡®ğŸ‡¹</span>
        <span class="lang-code">IT</span>
      </button>
    </div>
  </div>

  <!-- Logout Button (nur sichtbar wenn eingeloggt) -->
  <button id="logoutBtn" class="logout-button" style="display:none;" onclick="achtungAuth.logout()" aria-label="Abmelden">Abmelden</button>

  <header role="banner">
    <h1><span class="achtung-logo">[achtung.live]</span></h1>
    <p class="claim" id="mainClaim" data-i18n="header.tagline">Der Airbag fÃ¼r digitale Kommunikation</p>
    <!-- Simple language version (hidden by default) -->
    <p class="claim simple-lang" id="mainClaimSimple" data-i18n="header.taglineSimple" style="display:none;">Wir helfen dir, keine privaten Daten zu teilen.</p>
  </header>


  <!-- GeschÃ¼tzter Inhalt -->
  <main class="main-content protected-content" role="main">
    <!-- API Status Indicator -->
    <div id="apiStatus" class="api-status" role="status" aria-live="polite"></div>

    <!-- Live Check Indicator -->
    <div id="liveCheckIndicator" class="live-check-indicator" style="display:none;" role="status" aria-live="polite">
      <span class="live-dot"></span>
      <span class="live-text">Live-PrÃ¼fung aktiv</span>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist" aria-label="Analyse-Modus wÃ¤hlen">
      <button class="tab-btn active" data-tab="single" role="tab" aria-selected="true" aria-controls="singleTab" data-i18n="tabs.single">Einzeltext</button>
      <button class="tab-btn" data-tab="batch" role="tab" aria-selected="false" aria-controls="batchTab" data-i18n="tabs.batch">Batch-Analyse</button>
      <button class="tab-btn" data-tab="document" role="tab" aria-selected="false" aria-controls="documentTab" data-i18n="tabs.document">Dokument</button>
    </div>

    <!-- Single Text Tab -->
    <div id="singleTab" class="tab-content active" role="tabpanel" aria-labelledby="single-tab">
      <h2 id="formTitle">Jetzt live testen!</h2>
      <p class="simple-lang form-description" id="formDescSimple" style="display:none;">
        Schreibe deinen Text unten. Wir sagen dir, ob private Daten drin sind.
      </p>
      <form id="demoForm" aria-describedby="formTitle">
        <label for="demoText" class="sr-only">Dein Text zur PrÃ¼fung</label>
        <textarea id="demoText" placeholder="Schreibe hier deinen Text und lass ihn direkt Ã¼berprÃ¼fen..." rows="6" required aria-label="Text eingeben zur Datenschutz-PrÃ¼fung"></textarea>

        <!-- Live Preview (for real-time checking) -->
        <div id="livePreview" class="live-preview" style="display:none;" role="status" aria-live="polite">
          <div class="live-preview-header">
            <span class="live-preview-icon">ğŸ”</span>
            <span class="live-preview-title">Live-Vorschau</span>
          </div>
          <div id="livePreviewContent" class="live-preview-content"></div>
        </div>

        <!-- Kontext-Auswahl -->
        <div class="context-selector">
          <label for="contextSelect">Wo soll dieser Text verwendet werden?</label>
          <select id="contextSelect" aria-describedby="contextHelp">
            <option value="private">Privater Chat (1:1)</option>
            <option value="whatsapp">WhatsApp Gruppe</option>
            <option value="email">E-Mail</option>
            <option value="linkedin">LinkedIn / Beruflich</option>
            <option value="public">Ã–ffentlicher Post (Social Media)</option>
          </select>
          <span id="contextHelp" class="simple-lang context-help" style="display:none;">
            WÃ¤hle aus, wo du den Text posten mÃ¶chtest. Das hilft uns, besser zu prÃ¼fen.
          </span>
        </div>

        <div class="datenschutz-hinweis">
          <input type="checkbox" id="privacyPolicyDemo" required aria-describedby="privacyHelp">
          <label for="privacyPolicyDemo">Ich akzeptiere die <a href="#" onclick="openModal('datenschutzModal'); return false;">DatenschutzerklÃ¤rung</a>.</label>
          <span id="privacyHelp" class="simple-lang" style="display:none;">Du musst das ankreuzen, damit wir deinen Text prÃ¼fen dÃ¼rfen.</span>
        </div>
        <button type="submit" aria-label="Text auf sensible Daten prÃ¼fen">Text analysieren</button>
      </form>

      <!-- Risk Dashboard -->
      <div id="riskDashboard" style="display:none;" role="region" aria-label="Analyse-Ergebnisse"></div>
    </div>

    <!-- Batch Analysis Tab -->
    <div id="batchTab" class="tab-content" role="tabpanel" aria-labelledby="batch-tab">
      <h2>Batch-Analyse</h2>
      <p class="batch-description">Analysiere mehrere Texte gleichzeitig (max. 20 Texte)</p>
      <p class="simple-lang batch-description-simple" style="display:none;">PrÃ¼fe viele Texte auf einmal. Maximal 20 StÃ¼ck.</p>

      <form id="batchForm">
        <div class="batch-input-area">
          <div class="batch-textarea-container">
            <textarea id="batchTexts" placeholder="FÃ¼ge mehrere Texte ein, getrennt durch eine Leerzeile (2x Enter)..." rows="8"></textarea>
            <div class="batch-counter">
              <span id="textCount">0</span> / 20 Texte
            </div>
          </div>

          <div class="batch-divider">
            <span>oder</span>
          </div>

          <div class="batch-upload-area" id="dropZone">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">Datei hierher ziehen</div>
            <div class="upload-subtext">oder klicken zum AuswÃ¤hlen (.txt, .csv)</div>
            <input type="file" id="batchFile" accept=".txt,.csv" hidden>
          </div>
        </div>

        <div class="datenschutz-hinweis">
          <input type="checkbox" id="privacyPolicyBatch" required>
          <label for="privacyPolicyBatch">Ich akzeptiere die <a href="#" onclick="openModal('datenschutzModal'); return false;">DatenschutzerklÃ¤rung</a>.</label>
        </div>

        <button type="submit" id="batchSubmitBtn">
          <span class="btn-text">Alle Texte analysieren</span>
          <span class="btn-loading" style="display:none;">Analysiere...</span>
        </button>
      </form>

      <!-- Batch Results -->
      <div id="batchResults" style="display:none;"></div>
    </div>

    <!-- Document Analysis Tab -->
    <div id="documentTab" class="tab-content" role="tabpanel" aria-labelledby="document-tab">
      <h2 data-i18n="document.title">Dokument-Analyse</h2>
      <p class="doc-description" data-i18n="document.description">Lade ein Bild oder PDF hoch zur Analyse</p>
      <p class="simple-lang doc-description-simple" style="display:none;" data-i18n="document.descriptionSimple">Lade ein Foto oder PDF hoch. Wir prÃ¼fen den Text darin.</p>

      <form id="documentForm">
        <div class="document-upload-area" id="docDropZone">
          <div class="upload-icon">ğŸ“„</div>
          <div class="upload-text" data-i18n="document.dropzone">Bild oder PDF hierher ziehen</div>
          <div class="upload-subtext" data-i18n="document.dropzoneHint">oder klicken zum AuswÃ¤hlen (PNG, JPG, PDF)</div>
          <div class="upload-maxsize" data-i18n="document.maxSize">Maximal 10 MB fÃ¼r Bilder, 25 MB fÃ¼r PDFs</div>
          <input type="file" id="documentFile" accept="image/png,image/jpeg,image/webp,application/pdf" hidden>
        </div>

        <!-- Document Preview -->
        <div id="documentPreview" class="document-preview" style="display:none;">
          <div class="doc-preview-header">
            <span class="doc-preview-name" id="docFileName"></span>
            <span class="doc-preview-size" id="docFileSize"></span>
            <button type="button" class="doc-remove-btn" onclick="removeDocument()">&times;</button>
          </div>
          <div class="doc-preview-content">
            <img id="docPreviewImage" class="doc-preview-img" style="display:none;" alt="Dokument-Vorschau">
            <div id="docPreviewPdf" class="doc-preview-pdf" style="display:none;">
              <span class="pdf-icon">ğŸ“‘</span>
              <span class="pdf-text">PDF-Dokument</span>
            </div>
          </div>
        </div>

        <!-- OCR Options -->
        <div class="ocr-options" id="ocrOptions" style="display:none;">
          <label class="ocr-option">
            <input type="checkbox" id="enableOcr" checked>
            <span>Text erkennen (OCR)</span>
          </label>
          <label class="ocr-option">
            <input type="checkbox" id="enableSentiment">
            <span>Stimmungsanalyse</span>
          </label>
        </div>

        <div class="datenschutz-hinweis">
          <input type="checkbox" id="privacyPolicyDoc" required>
          <label for="privacyPolicyDoc">Ich akzeptiere die <a href="#" onclick="openModal('datenschutzModal'); return false;">DatenschutzerklÃ¤rung</a>.</label>
        </div>

        <button type="submit" id="docSubmitBtn" disabled>
          <span class="btn-text" data-i18n="form.submit">Dokument analysieren</span>
          <span class="btn-loading" style="display:none;" data-i18n="document.analyzing">Analysiere...</span>
        </button>
      </form>

      <!-- Document Results -->
      <div id="documentResults" style="display:none;">
        <div class="doc-results-container">
          <!-- Extracted Text Section -->
          <div class="doc-extracted-text" id="extractedTextSection" style="display:none;">
            <div class="extracted-header">
              <span class="extracted-title" data-i18n="document.extractedText">Erkannter Text</span>
              <span class="extracted-confidence" id="ocrConfidence"></span>
            </div>
            <div class="extracted-content" id="extractedText"></div>
          </div>

          <!-- Sentiment Section -->
          <div class="doc-sentiment" id="sentimentSection" style="display:none;">
            <div class="sentiment-header" data-i18n="document.sentiment">Stimmung</div>
            <div class="sentiment-result" id="sentimentResult"></div>
          </div>

          <!-- Risk Dashboard for Document -->
          <div id="docRiskDashboard"></div>
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="openModal('caseModal')">Fallbeispiele ansehen</button>
    </div>
  </main>

  <!-- Hinweis vor Authentifizierung -->
  <main class="main-content auth-required">
    <h2>Demo-Zugang</h2>
    <p>Die Live-Demo ist passwortgeschÃ¼tzt.</p>
    <p>Bitte gib das Passwort ein, um fortzufahren.</p>
  </main>

  <!-- Popup fÃ¼r Datenschutz -->
  <div id="datenschutzModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('datenschutzModal')">&times;</span>
      <iframe src="datenschutz-popup2.html" style="width:100%; height:400px; border:none;"></iframe>
    </div>
  </div>

  <!-- Popup fÃ¼r Fallbeispiele -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('caseModal')">&times;</span>

      <div class="case-study-container">
        <div class="case-study-box active">
          <h3>Fallbeispiel: Kreditkartendaten unbewusst geteilt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Meine Kreditkartennummer lautet: 3948673029486</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Teile sensible Bankdaten wie IBANs oder Kreditkartennummern niemals Ã¶ffentlich.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Ich sende dir meine Zahlungsdaten separat Ã¼ber einen sicheren Kanal.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Nutze verschlÃ¼sselte Messenger wie Signal oder sichere KanÃ¤le deiner Bank.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Standortdaten Ã¶ffentlich geteilt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Bin gerade im Urlaub in Italien</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Standortinformationen verraten, wo du bist - und wo nicht...</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Bis bald â€“ ich melde mich wieder mit Neuigkeiten!</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Poste Urlaubs-Updates erst nach deiner RÃ¼ckkehr.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Screenshot mit Patientendaten</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">(Screenshot) Diagnosebericht meiner Ã„rztin fÃ¼r die Krankenkasse</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Fotos von Dokumenten kÃ¶nnen vertrauliche Gesundheitsdaten enthalten.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Bitte sichere Ãœbertragungswege fÃ¼r Dokumente verwenden.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Nutze verschlÃ¼sselte Ãœbermittlung, keine Messenger-Screenshots.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Arbeitgeber namentlich erwÃ¤hnt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Mein Chef bei der XY AG ist total unfÃ¤hig...</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Nennungen von Firmen und Namen kÃ¶nnen rechtliche Folgen haben.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Ich habe in meinem Job aktuell Herausforderungen mit der FÃ¼hrungskultur.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Personen anonymisieren â€“ Fokus auf die Sache!</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Messenger-Screenshot mit Klarnamen</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">(Screenshot) WhatsApp-Chat mit vollem Namen sichtbar</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Screenshots kÃ¶nnen persÃ¶nliche Daten offenlegen.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Anonymisierte Screenshots oder Zitate verwenden.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Namen und Profilbilder vorher unkenntlich machen.</div>
        </div>
      </div>

      <div class="case-study-nav">
        <button onclick="changeCase(-1)">ZurÃ¼ck</button>
        <button onclick="changeCase(1)">Weiter</button>
      </div>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="closeModal('caseModal')">SchlieÃŸen</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="europe">Aus Europa. FÃ¼r Alle.</div>

    <div class="schutztext">
      [<span style="color: #800000;">achtung.live</span>] schÃ¼tzt, was zÃ¤hlt: unsere digitale Kommunikation. <br> In Echtzeit. Ohne Tracking. DSGVO & EU AI-Act-konform.
    </div>

    <nav class="footer-nav">
      <a href="info.html">Info</a> â€¢
      <a href="gefahr.html">Gefahr</a> â€¢
      <a href="demo.html" class="demo-highlight">Demo</a> â€¢
      <a href="ki-hinweis.html">KI-Hinweis</a> â€¢
      <a href="datenschutz.html">Datenschutz</a> â€¢
      <a href="kontakt.html">Kontakt</a> â€¢
      <a href="impressum.html">Impressum</a>
    </nav>

    <div class="copyright">
      Â© 2025 achtung.live
    </div>
  </footer>

  <!-- Authentifizierungs-Script -->
  <script src="auth.js"></script>

  <script>
    // ========================================
    // API Konfiguration
    // ========================================
    const API_BASE = "/.netlify/functions";
    const API_ANALYZE_URL = `${API_BASE}/analyze`;
    const API_REWRITE_URL = `${API_BASE}/rewrite`;
    const API_BATCH_URL = `${API_BASE}/analyze-batch`;
    const API_HEALTH_URL = `${API_BASE}/health`;

    // Kategorie-Metadaten fÃ¼r das Dashboard (Phase 2: 25+ Kategorien)
    const CATEGORY_META = {
      // Finanzen
      iban: { label: "IBAN/Bankdaten", icon: "ğŸ¦", group: "financial" },
      credit_card: { label: "Kreditkarte", icon: "ğŸ’³", group: "financial" },
      bic: { label: "BIC/SWIFT", icon: "ğŸ›ï¸", group: "financial" },
      account_number: { label: "Kontonummer", icon: "ğŸ’°", group: "financial" },

      // Identifikation
      national_id: { label: "Personalausweis", icon: "ğŸªª", group: "identity" },
      passport: { label: "Reisepass", icon: "ğŸ“•", group: "identity" },
      tax_id: { label: "Steuer-ID", icon: "ğŸ“‹", group: "identity" },
      social_security: { label: "Sozialversicherung", icon: "ğŸ†”", group: "identity" },
      drivers_license: { label: "FÃ¼hrerschein", icon: "ğŸš—", group: "identity" },

      // Gesundheit
      health_insurance: { label: "Krankenversicherung", icon: "ğŸ¥", group: "health" },
      medical_record: { label: "Medizinische Daten", icon: "ğŸ’Š", group: "health" },
      health: { label: "Gesundheitsdaten", icon: "ğŸ©º", group: "health" },

      // Digital
      ip_address: { label: "IP-Adresse", icon: "ğŸŒ", group: "digital" },
      mac_address: { label: "MAC-Adresse", icon: "ğŸ“¡", group: "digital" },
      username: { label: "Benutzername", icon: "ğŸ‘¤", group: "digital" },
      password: { label: "Passwort", icon: "ğŸ”‘", group: "digital" },
      api_key: { label: "API-SchlÃ¼ssel", icon: "ğŸ”", group: "digital" },

      // PersÃ¶nlich
      name: { label: "Personenname", icon: "ğŸ‘¤", group: "personal" },
      phone: { label: "Telefonnummer", icon: "ğŸ“±", group: "personal" },
      email: { label: "E-Mail-Adresse", icon: "ğŸ“§", group: "personal" },
      address: { label: "Postadresse", icon: "ğŸ“", group: "personal" },
      date_of_birth: { label: "Geburtsdatum", icon: "ğŸ‚", group: "personal" },
      age: { label: "Alter", icon: "ğŸ”¢", group: "personal" },
      gender: { label: "Geschlecht", icon: "âš§ï¸", group: "personal" },
      religion: { label: "Religion", icon: "ğŸ›", group: "personal" },
      political: { label: "Politische Meinung", icon: "ğŸ—³ï¸", group: "personal" },
      sexual_orientation: { label: "Sexuelle Orientierung", icon: "ğŸ³ï¸â€ğŸŒˆ", group: "personal" },

      // Biometrisch
      biometric: { label: "Biometrische Daten", icon: "ğŸ‘ï¸", group: "biometric" },
      photo: { label: "Erkennbares Foto", icon: "ğŸ“¸", group: "biometric" },

      // Standort
      gps_coordinates: { label: "GPS-Koordinaten", icon: "ğŸ›°ï¸", group: "location" },
      license_plate: { label: "Kfz-Kennzeichen", icon: "ğŸš˜", group: "location" },
      location: { label: "Standort", icon: "ğŸ“", group: "location" },
      vacation: { label: "Abwesenheit/Urlaub", icon: "âœˆï¸", group: "location" },

      // Semantisch (GPT-erkannt)
      child: { label: "Kinderdaten", icon: "ğŸ‘¶", group: "semantic" },
      emotion: { label: "Emotionen", icon: "ğŸ˜¤", group: "semantic" },
      employer: { label: "Arbeitgeber", icon: "ğŸ¢", group: "semantic" },
      legal: { label: "Rechtlich heikel", icon: "âš–ï¸", group: "semantic" },

      // Fallback
      date: { label: "Datum/Termin", icon: "ğŸ“…", group: "other" },
      generic: { label: "Sensible Daten", icon: "âš ï¸", group: "other" }
    };

    // Kontext-Warnungen
    const CONTEXT_WARNINGS = {
      whatsapp: "WhatsApp-Nachrichten kÃ¶nnen leicht weitergeleitet oder als Screenshot geteilt werden.",
      public: "Ã–ffentliche Posts sind fÃ¼r jeden sichtbar und kÃ¶nnen von Suchmaschinen indexiert werden.",
      linkedin: "Berufliche Netzwerke werden oft von Arbeitgebern und Recruitern durchsucht.",
      email: "E-Mails kÃ¶nnen weitergeleitet werden und verbleiben oft auf Servern.",
      private: null
    };

    // ========================================
    // Modal Funktionen
    // ========================================
    function openModal(id) {
      document.getElementById(id).style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // Fallbeispiele Navigation
    let currentCase = 0;
    const cases = document.querySelectorAll('.case-study-box');

    function changeCase(dir) {
      cases[currentCase].classList.remove('active');
      currentCase = (currentCase + dir + cases.length) % cases.length;
      cases[currentCase].classList.add('active');
    }

    // ========================================
    // Risk Dashboard Rendering
    // ========================================

    // Zeigt den Loading-Zustand
    function showLoading() {
      const dashboard = document.getElementById('riskDashboard');
      dashboard.style.display = 'block';
      dashboard.innerHTML = `
        <div class="risk-dashboard">
          <div class="dashboard-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Analysiere deinen Text...</div>
          </div>
        </div>
      `;
    }

    // Berechnet Risk Score aus Kategorien (Fallback wenn Backend alt)
    function calculateRiskScore(categories) {
      if (!categories || categories.length === 0) return 100;

      let score = 100;
      for (const cat of categories) {
        switch (cat.severity) {
          case 'critical': score -= 35; break;
          case 'high': score -= 20; break;
          case 'medium': score -= 10; break;
          case 'low': score -= 5; break;
          default: score -= 15;
        }
      }
      return Math.max(0, score);
    }

    // Ermittelt Risk Level aus Score
    function getRiskLevel(score) {
      if (score >= 80) return 'safe';
      if (score >= 50) return 'warning';
      return 'danger';
    }

    // Status-Text fÃ¼r Risk Level
    function getStatusText(level) {
      switch (level) {
        case 'safe': return 'âœ“ SICHER';
        case 'warning': return 'âš  ACHTUNG';
        case 'danger': return 'âœ— GEFAHR';
        default: return 'UNBEKANNT';
      }
    }

    // Markiert sensible Stellen im Text (komplett neu geschrieben)
    function markText(text, categories) {
      if (!categories || categories.length === 0) return escapeHtml(text);

      // Sammle alle Markierungen mit korrekten Positionen
      const marks = categories
        .map(cat => {
          let start, end;
          if (cat.position && typeof cat.position.start === 'number') {
            start = cat.position.start;
            end = cat.position.end;
          } else if (cat.match) {
            start = text.indexOf(cat.match);
            end = start >= 0 ? start + cat.match.length : -1;
          } else {
            return null;
          }
          if (start < 0 || end <= start || end > text.length) return null;
          return { start, end, severity: cat.severity || 'medium', message: cat.message };
        })
        .filter(m => m !== null)
        .sort((a, b) => a.start - b.start);

      // Entferne Ã¼berlappende Markierungen (behalte die mit hÃ¶herer Severity)
      const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
      const filtered = [];
      for (const mark of marks) {
        const lastMark = filtered[filtered.length - 1];
        if (lastMark && mark.start < lastMark.end) {
          // Ãœberlappung: behalte die mit hÃ¶herer Severity
          if ((severityOrder[mark.severity] || 0) > (severityOrder[lastMark.severity] || 0)) {
            filtered[filtered.length - 1] = mark;
          }
          // Sonst ignorieren
        } else {
          filtered.push(mark);
        }
      }

      // Baue den String von links nach rechts auf
      let result = '';
      let lastEnd = 0;

      for (const mark of filtered) {
        // Text vor der Markierung (escaped)
        if (mark.start > lastEnd) {
          result += escapeHtml(text.substring(lastEnd, mark.start));
        }
        // Markierter Text
        const matchText = text.substring(mark.start, mark.end);
        result += `<span class="text-mark ${mark.severity}">${escapeHtml(matchText)}</span>`;
        lastEnd = mark.end;
      }

      // Rest des Textes nach der letzten Markierung
      if (lastEnd < text.length) {
        result += escapeHtml(text.substring(lastEnd));
      }

      return result;
    }

    // HTML Escape Helper
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Rendert das komplette Dashboard
    function renderDashboard(data, originalText, context) {
      const dashboard = document.getElementById('riskDashboard');

      // Normalisiere Daten (unterstÃ¼tzt altes und neues API-Format)
      const normalized = normalizeApiResponse(data, originalText);

      // Kontext-Warnung hinzufÃ¼gen
      if (!normalized.contextWarning && CONTEXT_WARNINGS[context]) {
        normalized.contextWarning = CONTEXT_WARNINGS[context];
      }

      const { riskScore, riskLevel, categories, summary, contextWarning, rewrite } = normalized;

      // Wenn alles sicher ist
      if (categories.length === 0) {
        dashboard.innerHTML = `
          <div class="risk-dashboard">
            <div class="all-safe-message">
              <div class="all-safe-icon">ğŸ›¡ï¸</div>
              <div class="all-safe-title">Alles sicher!</div>
              <div class="all-safe-text">Keine sensiblen Daten in deinem Text erkannt.<br>Du kannst ihn bedenkenlos senden.</div>
            </div>
            ${contextWarning ? `
              <div class="context-warning">
                <span class="context-warning-icon">ğŸ’¡</span>
                <span>${escapeHtml(contextWarning)}</span>
              </div>
            ` : ''}
          </div>
        `;
        return;
      }

      // VollstÃ¤ndiges Dashboard rendern
      dashboard.innerHTML = `
        <div class="risk-dashboard">
          <!-- Privacy Score -->
          <div class="privacy-score-section">
            <div class="privacy-score-label">Privacy Score</div>
            <div class="privacy-score-circle ${riskLevel}">
              <span class="privacy-score-number">${riskScore}</span>
              <span class="privacy-score-max">/ 100</span>
            </div>
            <div class="privacy-score-status ${riskLevel}">${getStatusText(riskLevel)}</div>
            <div class="privacy-score-summary">${escapeHtml(summary)}</div>
          </div>

          <!-- Kategorie-Badges -->
          <div class="risk-categories">
            ${categories.map(cat => {
              const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
              return `<span class="risk-category-badge ${cat.severity || 'medium'}">
                ${meta.icon} ${meta.label}
              </span>`;
            }).join('')}
          </div>

          <!-- Markierter Text -->
          <div class="marked-text-section">
            <div class="marked-text-label">Dein Text mit Markierungen</div>
            <div class="marked-text-container">${markText(originalText, categories)}</div>
          </div>

          <!-- Findings Liste -->
          <div class="findings-section">
            <div class="findings-list">
              ${categories.map(cat => {
                const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                return `
                  <div class="finding-item ${cat.severity || 'medium'}">
                    <div class="finding-icon">${meta.icon}</div>
                    <div class="finding-content">
                      <div class="finding-title">${meta.label}</div>
                      ${cat.match ? `<div class="finding-match">"${escapeHtml(cat.match.substring(0, 50))}${cat.match.length > 50 ? '...' : ''}"</div>` : ''}
                      <div class="finding-message">${escapeHtml(cat.message || 'Sensible Information erkannt')}</div>
                      ${cat.suggestion ? `<div class="finding-suggestion">${escapeHtml(cat.suggestion)}</div>` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Kontext-Warnung -->
          ${contextWarning ? `
            <div class="context-warning">
              <span class="context-warning-icon">ğŸ’¡</span>
              <span>${escapeHtml(contextWarning)}</span>
            </div>
          ` : ''}

          <!-- Smart Rewrite Section -->
          <div class="rewrite-section">
            <div class="rewrite-header">
              <span class="rewrite-icon">âœ¨</span>
              <span class="rewrite-title">Smart Rewrite</span>
            </div>

            <!-- Rewrite Mode Selection -->
            <div class="rewrite-mode-selector">
              <button class="rewrite-mode-btn active" data-mode="anonymize" onclick="selectRewriteMode('anonymize')">
                <span class="mode-icon">ğŸ·ï¸</span>
                <span class="mode-label">Anonymisieren</span>
                <span class="mode-desc">[NAME], [IBAN]...</span>
              </button>
              <button class="rewrite-mode-btn" data-mode="redact" onclick="selectRewriteMode('redact')">
                <span class="mode-icon">â–ˆ</span>
                <span class="mode-label">Zensieren</span>
                <span class="mode-desc">[ZENSIERT]</span>
              </button>
              <button class="rewrite-mode-btn" data-mode="pseudonymize" onclick="selectRewriteMode('pseudonymize')">
                <span class="mode-icon">ğŸ­</span>
                <span class="mode-label">Pseudonymisieren</span>
                <span class="mode-desc">Fake-Daten</span>
              </button>
            </div>

            <button class="rewrite-generate-btn" onclick="generateRewrite()">
              <span class="btn-icon">âš¡</span>
              <span class="btn-text">Text neu schreiben</span>
              <span class="btn-loading" style="display:none;">Generiere...</span>
            </button>

            <!-- Rewrite Result (initially hidden, shown after generation) -->
            <div id="rewriteResult" class="rewrite-result" style="display:none;">
              <div class="rewrite-container">
                <div class="rewrite-text" id="rewriteText"></div>
              </div>
              <div class="rewrite-changes" id="rewriteChanges"></div>
              <div class="rewrite-actions">
                <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
                  ğŸ“‹ Text kopieren
                </button>
                <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
                  â†©ï¸ In Textfeld Ã¼bernehmen
                </button>
              </div>
            </div>

            <!-- Show existing rewrite if available from API -->
            ${rewrite ? `
              <div class="rewrite-result">
                <div class="rewrite-container">
                  <div class="rewrite-text" id="rewriteTextInitial">${escapeHtml(rewrite.suggestion || rewrite.rewritten || '')}</div>
                </div>
                ${rewrite.changes && rewrite.changes.length > 0 ? `
                  <div class="rewrite-changes">
                    ${rewrite.changes.map(change => {
                      const changeText = typeof change === 'string' ? change : `${change.original} â†’ ${change.replacement}`;
                      return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
                    }).join('')}
                  </div>
                ` : ''}
                <div class="rewrite-actions">
                  <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
                    ğŸ“‹ Text kopieren
                  </button>
                  <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
                    â†©ï¸ In Textfeld Ã¼bernehmen
                  </button>
                </div>
              </div>
            ` : ''}
          </div>

          <!-- Provider Info (if available) -->
          ${data.meta ? `
            <div class="provider-info">
              <span class="provider-badge">${data.meta.provider || 'AI'}</span>
              <span class="provider-model">${data.meta.model || ''}</span>
              <span class="provider-time">${data.meta.processingTime ? `${data.meta.processingTime}ms` : ''}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Generiert korrekten deutschen Summary-Text
    function generateSummary(categories) {
      if (!categories || categories.length === 0) {
        return 'Keine Risiken erkannt';
      }

      // ZÃ¤hle nach Severity
      const counts = { critical: 0, high: 0, medium: 0, low: 0 };
      for (const cat of categories) {
        const sev = cat.severity || 'medium';
        counts[sev] = (counts[sev] || 0) + 1;
      }

      const parts = [];
      if (counts.critical > 0) {
        parts.push(`${counts.critical} kritische${counts.critical === 1 ? 's' : ''}`);
      }
      if (counts.high > 0) {
        parts.push(`${counts.high} hohe${counts.high === 1 ? 's' : ''}`);
      }
      if (counts.medium > 0) {
        parts.push(`${counts.medium} mittlere${counts.medium === 1 ? 's' : ''}`);
      }
      if (counts.low > 0) {
        parts.push(`${counts.low} geringe${counts.low === 1 ? 's' : ''}`);
      }

      if (parts.length === 0) {
        return `${categories.length} ${categories.length === 1 ? 'Risiko' : 'Risiken'} erkannt`;
      }

      const total = categories.length;
      return `${parts.join(', ')} ${total === 1 ? 'Risiko' : 'Risiken'} erkannt`;
    }

    // Normalisiert API-Response (unterstÃ¼tzt altes und neues Format)
    function normalizeApiResponse(data, originalText) {
      // Neues API v2 Format
      if (data.riskScore !== undefined && data.categories) {
        // Ãœberschreibe Summary mit korrektem Deutsch
        return {
          ...data,
          summary: generateSummary(data.categories)
        };
      }

      // Altes Format mit feedback Array
      if (data.feedback && Array.isArray(data.feedback)) {
        const categories = data.feedback.map((msg, i) => ({
          type: detectCategoryFromMessage(msg),
          severity: 'medium',
          message: msg,
          match: extractMatchFromMessage(msg, originalText)
        }));

        const riskScore = calculateRiskScore(categories);

        return {
          riskScore,
          riskLevel: getRiskLevel(riskScore),
          categories,
          summary: generateSummary(categories),
          rewrite: null
        };
      }

      // Altes Format mit detected_data etc.
      if (data.detected_data || data.risk_level) {
        const categories = [];
        if (data.detected_data && data.detected_data !== 'Keine') {
          categories.push({
            type: 'generic',
            severity: data.risk_level === 'hoch' ? 'critical' : 'medium',
            message: data.explanation || data.detected_data,
            suggestion: data.tip
          });
        }

        const riskScore = calculateRiskScore(categories);

        return {
          riskScore,
          riskLevel: getRiskLevel(riskScore),
          categories,
          summary: data.detected_data || 'Analyse abgeschlossen',
          rewrite: null
        };
      }

      // Fallback: Keine Risiken
      return {
        riskScore: 100,
        riskLevel: 'safe',
        categories: [],
        summary: 'Keine sensiblen Daten erkannt',
        rewrite: null
      };
    }

    // Erkennt Kategorie aus Nachrichtentext
    function detectCategoryFromMessage(msg) {
      const lower = msg.toLowerCase();
      if (lower.includes('iban') || lower.includes('bank') || lower.includes('konto')) return 'iban';
      if (lower.includes('kreditkarte') || lower.includes('kartennummer')) return 'credit_card';
      if (lower.includes('telefon') || lower.includes('handy') || lower.includes('nummer')) return 'phone';
      if (lower.includes('e-mail') || lower.includes('email')) return 'email';
      if (lower.includes('adresse') || lower.includes('straÃŸe') || lower.includes('wohnort')) return 'address';
      if (lower.includes('passwort') || lower.includes('kennwort')) return 'password';
      if (lower.includes('gesundheit') || lower.includes('krankheit') || lower.includes('arzt') || lower.includes('diagnose')) return 'health';
      if (lower.includes('kind') || lower.includes('sohn') || lower.includes('tochter') || lower.includes('schule')) return 'child';
      if (lower.includes('standort') || lower.includes('urlaub') || lower.includes('reise') || lower.includes('nicht zuhause')) return 'vacation';
      if (lower.includes('wÃ¼tend') || lower.includes('emotion') || lower.includes('Ã¤rger') || lower.includes('hass')) return 'emotion';
      if (lower.includes('chef') || lower.includes('arbeitgeber') || lower.includes('firma') || lower.includes('kollege')) return 'employer';
      if (lower.includes('beleidigung') || lower.includes('drohung') || lower.includes('rechtlich')) return 'legal';
      if (lower.includes('name') || lower.includes('person')) return 'name';
      return 'generic';
    }

    // Extrahiert Match aus Nachricht (einfache Heuristik)
    function extractMatchFromMessage(msg, originalText) {
      // Versuche Text in AnfÃ¼hrungszeichen zu finden
      const quoted = msg.match(/"([^"]+)"/);
      if (quoted) return quoted[1];

      // Sonst null
      return null;
    }

    // ========================================
    // Rewrite Funktionen (Phase 2)
    // ========================================

    let currentRewriteMode = 'anonymize';
    let lastAnalyzedText = '';

    function selectRewriteMode(mode) {
      currentRewriteMode = mode;
      document.querySelectorAll('.rewrite-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }

    async function generateRewrite(originalText) {
      const text = originalText || lastAnalyzedText || document.getElementById('demoText').value;
      if (!text) return;

      const btn = document.querySelector('.rewrite-generate-btn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      btn.disabled = true;

      try {
        const response = await fetch(API_REWRITE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: text,
            mode: currentRewriteMode
          })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();

        // Show result
        const resultDiv = document.getElementById('rewriteResult');
        const rewriteTextDiv = document.getElementById('rewriteText');
        const changesDiv = document.getElementById('rewriteChanges');

        if (data.rewritten) {
          rewriteTextDiv.textContent = data.rewritten;

          // Show changes
          if (data.changes && data.changes.length > 0) {
            changesDiv.innerHTML = data.changes.map(change => {
              const changeText = typeof change === 'string' ? change : `${change.original} â†’ ${change.replacement}`;
              return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
            }).join('');
          } else {
            changesDiv.innerHTML = '';
          }

          resultDiv.style.display = 'block';
        }

      } catch (error) {
        console.error('Rewrite error:', error);
        alert('Fehler beim Rewrite: ' + error.message);
      } finally {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function copyRewrite() {
      const text = document.getElementById('rewriteText')?.innerText ||
                   document.getElementById('rewriteTextInitial')?.innerText;
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          const btn = event.target.closest('button');
          const originalHTML = btn.innerHTML;
          btn.innerHTML = 'âœ“ Kopiert!';
          btn.classList.add('copy-success');
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('copy-success');
          }, 2000);
        });
      }
    }

    function useRewrite() {
      const text = document.getElementById('rewriteText')?.innerText ||
                   document.getElementById('rewriteTextInitial')?.innerText;
      if (text) {
        document.getElementById('demoText').value = text;
        // Scroll zum Textfeld
        document.getElementById('demoText').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('demoText').focus();
      }
    }

    // ========================================
    // Tab Navigation
    // ========================================

    function initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab;

          // Update buttons
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabId + 'Tab').classList.add('active');
        });
      });
    }

    // ========================================
    // Batch Analyse (Phase 2)
    // ========================================

    function initBatchAnalysis() {
      const textarea = document.getElementById('batchTexts');
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('batchFile');
      const form = document.getElementById('batchForm');

      // Count texts as user types
      if (textarea) {
        textarea.addEventListener('input', () => {
          const texts = parseTexts(textarea.value);
          document.getElementById('textCount').textContent = texts.length;
        });
      }

      // Drag & Drop
      if (dropZone) {
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const file = e.dataTransfer.files[0];
          if (file) handleFile(file);
        });
      }

      // File input change
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleFile(file);
        });
      }

      // Form submit
      if (form) {
        form.addEventListener('submit', handleBatchSubmit);
      }
    }

    function parseTexts(input) {
      if (!input || !input.trim()) return [];
      // Split by double newline (empty line)
      return input.split(/\n\s*\n/)
        .map(t => t.trim())
        .filter(t => t.length > 0)
        .slice(0, 20); // Max 20 texts
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        let texts = [];

        if (file.name.endsWith('.csv')) {
          // Parse CSV (assume one text per line)
          texts = content.split('\n').filter(t => t.trim());
        } else {
          // Parse TXT (double newline separated)
          texts = parseTexts(content);
        }

        document.getElementById('batchTexts').value = texts.join('\n\n');
        document.getElementById('textCount').textContent = Math.min(texts.length, 20);
      };
      reader.readAsText(file);
    }

    async function handleBatchSubmit(e) {
      e.preventDefault();

      const texts = parseTexts(document.getElementById('batchTexts').value);
      if (texts.length === 0) {
        alert('Bitte mindestens einen Text eingeben.');
        return;
      }

      const btn = document.getElementById('batchSubmitBtn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      btn.disabled = true;

      try {
        const response = await fetch(API_BATCH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            texts: texts.map((text, i) => ({ id: `text-${i}`, text }))
          })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();
        renderBatchResults(data, texts);

      } catch (error) {
        console.error('Batch error:', error);
        document.getElementById('batchResults').innerHTML = `
          <div class="batch-error">
            <span class="error-icon">âš ï¸</span>
            <span>Fehler: ${escapeHtml(error.message)}</span>
          </div>
        `;
        document.getElementById('batchResults').style.display = 'block';
      } finally {
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function renderBatchResults(data, originalTexts) {
      const resultsDiv = document.getElementById('batchResults');

      // Calculate summary from results if not provided
      const results = data.results || [];
      const totalTexts = results.length;

      // Calculate average score
      const scores = results
        .filter(r => r.success !== false && r.analysis?.riskScore !== undefined)
        .map(r => r.analysis.riskScore);
      const averageScore = scores.length > 0
        ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
        : 100;

      // Calculate total risks
      const totalRisks = results.reduce((sum, r) =>
        sum + (r.analysis?.categories?.length || 0), 0);

      resultsDiv.innerHTML = `
        <div class="batch-results-container">
          <!-- Summary -->
          <div class="batch-summary">
            <div class="batch-summary-item">
              <span class="summary-number">${totalTexts}</span>
              <span class="summary-label">Texte analysiert</span>
            </div>
            <div class="batch-summary-item">
              <span class="summary-number ${averageScore >= 80 ? 'safe' : averageScore >= 50 ? 'warning' : 'danger'}">
                ${averageScore}
              </span>
              <span class="summary-label">Durchschn. Score</span>
            </div>
            <div class="batch-summary-item">
              <span class="summary-number">${totalRisks}</span>
              <span class="summary-label">Risiken gesamt</span>
            </div>
          </div>

          <!-- Individual Results -->
          <div class="batch-results-list">
            ${results.map((result, i) => {
              const text = originalTexts[i] || '';
              const preview = text.substring(0, 100) + (text.length > 100 ? '...' : '');
              const analysis = result.analysis || {};
              const riskScore = analysis.riskScore ?? 100;
              const level = getRiskLevel(riskScore);
              const riskCount = analysis.categories?.length || 0;

              return `
                <div class="batch-result-item ${level}">
                  <div class="result-header">
                    <span class="result-number">#${i + 1}</span>
                    <span class="result-score ${level}">${riskScore}/100</span>
                  </div>
                  <div class="result-preview">${escapeHtml(preview)}</div>
                  ${riskCount > 0 ? `
                    <div class="result-risks">
                      ${analysis.categories.slice(0, 3).map(cat => {
                        const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                        return `<span class="risk-mini-badge ${cat.severity || 'medium'}">${meta.icon}</span>`;
                      }).join('')}
                      ${riskCount > 3 ? `<span class="risk-more">+${riskCount - 3}</span>` : ''}
                    </div>
                  ` : '<div class="result-safe">âœ“ Sicher</div>'}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      resultsDiv.style.display = 'block';
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // ========================================
    // Health Check & API Status
    // ========================================

    async function checkApiHealth() {
      const statusDiv = document.getElementById('apiStatus');
      if (!statusDiv) return;

      try {
        const response = await fetch(API_HEALTH_URL);
        const data = await response.json();

        // Accept various healthy status values
        const isHealthy = data.status === 'healthy' ||
                          data.status === 'ok' ||
                          data.status === 'up' ||
                          response.ok;

        if (isHealthy) {
          const providerInfo = data.providers || {};
          const quickCheck = data.quickCheck || {};
          const openaiOk = providerInfo.openai?.status === 'ok' || providerInfo.openai?.available;
          const anthropicOk = providerInfo.anthropic?.status === 'ok' || providerInfo.anthropic?.available;

          // Build provider badges
          let providerBadges = '';
          if (openaiOk) providerBadges += '<span class="provider-badge openai">OpenAI</span>';
          if (anthropicOk) providerBadges += '<span class="provider-badge anthropic">Claude</span>';

          // Build quick check info
          let quickCheckInfo = '';
          if (quickCheck.enabled) {
            quickCheckInfo = `
              <span class="quick-check-badge" title="Live-PrÃ¼fung: ${quickCheck.patternsLoaded || 27} Patterns, Cache: ${quickCheck.cacheHitRate || '0%'}">
                âš¡ Live
              </span>
            `;
          }

          statusDiv.innerHTML = `
            <span class="status-dot healthy"></span>
            <span class="status-text">API v${data.version || '3.0'}</span>
            <span class="status-badges">
              ${providerBadges}
              ${quickCheckInfo}
            </span>
          `;
          statusDiv.className = 'api-status healthy';
        } else if (data.status === 'degraded') {
          statusDiv.innerHTML = `
            <span class="status-dot degraded"></span>
            <span class="status-text">EingeschrÃ¤nkt</span>
          `;
          statusDiv.className = 'api-status degraded';
        } else {
          statusDiv.innerHTML = `
            <span class="status-dot degraded"></span>
            <span class="status-text">Status: ${data.status || 'unbekannt'}</span>
          `;
          statusDiv.className = 'api-status degraded';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <span class="status-dot offline"></span>
          <span class="status-text">API Offline</span>
        `;
        statusDiv.className = 'api-status offline';
      }
    }

    // ========================================
    // Formular Handler
    // ========================================

    document.getElementById("demoForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const text = document.getElementById("demoText").value;
      const context = document.getElementById("contextSelect").value;

      // Store for rewrite function
      lastAnalyzedText = text;

      showLoading();

      try {
        const response = await fetch(API_ANALYZE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, context })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();
        renderDashboard(data, text, context);

        // Scroll zum Dashboard
        document.getElementById('riskDashboard').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        const dashboard = document.getElementById('riskDashboard');
        dashboard.innerHTML = `
          <div class="risk-dashboard">
            <div style="padding: 40px 20px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
              <div style="font-size: 18px; font-weight: 600; color: #dc3545; margin-bottom: 10px;">
                Fehler bei der Analyse
              </div>
              <div style="font-size: 14px; color: #6c757d;">
                ${escapeHtml(err.message)}<br>
                <small>Bitte versuche es spÃ¤ter erneut.</small>
              </div>
            </div>
          </div>
        `;
      }
    });

    // ========================================
    // Event Listener
    // ========================================

    // SchlieÃŸen bei Klick auÃŸerhalb des Modals
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };

    // ========================================
    // Phase 3: Accessibility Functions
    // ========================================

    let currentFontSize = 0; // -2 to +2 scale
    let highContrastMode = false;
    let simpleLanguageMode = false;
    let realtimeMode = false;
    let realtimeTimeout = null;

    // Font Size Control
    function changeFontSize(dir) {
      if (dir === 0) {
        currentFontSize = 0;
      } else {
        currentFontSize = Math.max(-2, Math.min(2, currentFontSize + dir));
      }

      // Base font size is 16px
      const baseFontSize = 16;
      const fontSizeMap = {
        '-2': 12,
        '-1': 14,
        '0': 16,
        '1': 18,
        '2': 22
      };

      document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';

      // Update button states
      document.querySelectorAll('.a11y-group .a11y-btn').forEach((btn, i) => {
        if (i < 3) { // Only the font size buttons
          btn.classList.toggle('active',
            (i === 0 && currentFontSize < 0) ||
            (i === 1 && currentFontSize === 0) ||
            (i === 2 && currentFontSize > 0)
          );
        }
      });

      // Save preference
      localStorage.setItem('achtung-fontSize', currentFontSize);
    }

    // High Contrast Mode
    function toggleHighContrast() {
      highContrastMode = !highContrastMode;
      document.body.classList.toggle('high-contrast', highContrastMode);
      document.getElementById('contrastToggle').classList.toggle('active', highContrastMode);

      // Save preference
      localStorage.setItem('achtung-highContrast', highContrastMode);
    }

    // Simple Language Mode
    function toggleSimpleLanguage() {
      simpleLanguageMode = !simpleLanguageMode;
      document.body.classList.toggle('simple-language', simpleLanguageMode);
      document.getElementById('simpleLangToggle').classList.toggle('active', simpleLanguageMode);

      // Show/hide simple language elements
      document.querySelectorAll('.simple-lang').forEach(el => {
        el.style.display = simpleLanguageMode ? 'block' : 'none';
      });

      // Update main claim
      document.getElementById('mainClaim').style.display = simpleLanguageMode ? 'none' : 'block';
      document.getElementById('mainClaimSimple').style.display = simpleLanguageMode ? 'block' : 'none';

      // Save preference
      localStorage.setItem('achtung-simpleLanguage', simpleLanguageMode);
    }

    // Real-Time Checking
    function toggleRealtime() {
      realtimeMode = !realtimeMode;
      document.getElementById('realtimeToggle').classList.toggle('active', realtimeMode);
      document.getElementById('liveCheckIndicator').style.display = realtimeMode ? 'flex' : 'none';
      document.getElementById('livePreview').style.display = realtimeMode ? 'block' : 'none';

      if (realtimeMode) {
        // Add input listener for real-time checking
        document.getElementById('demoText').addEventListener('input', handleRealtimeInput);
        // Initial check if there's text
        const currentText = document.getElementById('demoText').value;
        if (currentText.trim().length > 10) {
          handleRealtimeInput();
        }
      } else {
        document.getElementById('demoText').removeEventListener('input', handleRealtimeInput);
        document.getElementById('livePreviewContent').innerHTML = '';
      }

      // Save preference
      localStorage.setItem('achtung-realtime', realtimeMode);
    }

    // Debounced real-time input handler
    function handleRealtimeInput() {
      clearTimeout(realtimeTimeout);

      const text = document.getElementById('demoText').value;
      const previewContent = document.getElementById('livePreviewContent');

      if (text.trim().length < 10) {
        previewContent.innerHTML = '<span class="live-hint">Mindestens 10 Zeichen fÃ¼r Live-PrÃ¼fung...</span>';
        return;
      }

      // Show checking indicator
      previewContent.innerHTML = '<span class="live-checking"><span class="live-spinner"></span> PrÃ¼fe...</span>';

      // Debounce: Wait 800ms after typing stops
      realtimeTimeout = setTimeout(async () => {
        try {
          const response = await fetch(API_ANALYZE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: text,
              context: document.getElementById('contextSelect').value,
              options: { quickCheck: true }
            })
          });

          if (!response.ok) throw new Error('API Error');

          const data = await response.json();
          renderLivePreview(data, text);

        } catch (error) {
          previewContent.innerHTML = '<span class="live-error">PrÃ¼fung fehlgeschlagen</span>';
        }
      }, 800);
    }

    // Render live preview results
    function renderLivePreview(data, text) {
      const previewContent = document.getElementById('livePreviewContent');
      const normalized = normalizeApiResponse(data, text);
      const meta = data.meta || {};
      const processingTime = meta.processingTime ? `${meta.processingTime}ms` : '';
      const cached = meta.cached ? ' (cached)' : '';

      if (normalized.categories.length === 0) {
        previewContent.innerHTML = `
          <div class="live-safe">
            <span class="live-safe-icon">âœ“</span>
            <span class="live-safe-text">Keine Risiken erkannt</span>
            ${processingTime ? `<span class="live-time">${processingTime}${cached}</span>` : ''}
          </div>
        `;
      } else {
        const riskCount = normalized.categories.length;
        const highestSeverity = normalized.categories.reduce((highest, cat) => {
          const order = { critical: 4, high: 3, medium: 2, low: 1 };
          return order[cat.severity] > order[highest] ? cat.severity : highest;
        }, 'low');

        previewContent.innerHTML = `
          <div class="live-warning ${highestSeverity}">
            <span class="live-warning-icon">âš ï¸</span>
            <span class="live-warning-text">${riskCount} ${riskCount === 1 ? 'Risiko' : 'Risiken'} erkannt</span>
            ${processingTime ? `<span class="live-time">${processingTime}${cached}</span>` : ''}
            <div class="live-categories">
              ${normalized.categories.slice(0, 3).map(cat => {
                const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                return `<span class="live-category ${cat.severity}">${meta.icon}</span>`;
              }).join('')}
              ${riskCount > 3 ? `<span class="live-more">+${riskCount - 3}</span>` : ''}
            </div>
          </div>
        `;
      }
    }

    // Load saved accessibility preferences
    function loadAccessibilityPreferences() {
      // Font size
      const savedFontSize = localStorage.getItem('achtung-fontSize');
      if (savedFontSize !== null) {
        currentFontSize = parseInt(savedFontSize);
        changeFontSize(0); // Apply without changing
        currentFontSize = parseInt(savedFontSize); // Restore
        const fontSizeMap = { '-2': 12, '-1': 14, '0': 16, '1': 18, '2': 22 };
        document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';
      }

      // High contrast
      if (localStorage.getItem('achtung-highContrast') === 'true') {
        toggleHighContrast();
      }

      // Simple language
      if (localStorage.getItem('achtung-simpleLanguage') === 'true') {
        toggleSimpleLanguage();
      }

      // Real-time (don't auto-enable on page load for performance)
    }

    // ========================================
    // Screen Reader Announcements
    // ========================================

    function announceToScreenReader(message) {
      const announcer = document.createElement('div');
      announcer.setAttribute('role', 'status');
      announcer.setAttribute('aria-live', 'polite');
      announcer.setAttribute('aria-atomic', 'true');
      announcer.className = 'sr-only';
      announcer.textContent = message;
      document.body.appendChild(announcer);
      setTimeout(() => announcer.remove(), 1000);
    }

    // ========================================
    // Phase 4: Internationalization (i18n)
    // ========================================

    let currentLang = 'de';
    let translations = {};

    async function loadTranslations(lang) {
      try {
        const response = await fetch(`/locales/${lang}.json`);
        if (!response.ok) throw new Error('Translation not found');
        return await response.json();
      } catch (error) {
        console.warn(`Failed to load ${lang} translations:`, error);
        return null;
      }
    }

    async function switchLanguage(lang) {
      // Load translations if not cached
      if (!translations[lang]) {
        translations[lang] = await loadTranslations(lang);
      }

      if (!translations[lang]) {
        console.error(`Translations for ${lang} not available`);
        return;
      }

      currentLang = lang;
      document.documentElement.lang = lang;

      // Update UI with translations
      applyTranslations(translations[lang]);

      // Update language buttons
      document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === lang);
      });

      // Save preference
      localStorage.setItem('achtung-lang', lang);
    }

    function applyTranslations(t) {
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        const value = getNestedValue(t, key);
        if (value) {
          el.textContent = value;
        }
      });

      // Update placeholders
      const demoText = document.getElementById('demoText');
      if (demoText && t.form?.placeholder) {
        demoText.placeholder = t.form.placeholder;
      }

      const batchTexts = document.getElementById('batchTexts');
      if (batchTexts && t.batch?.placeholder) {
        batchTexts.placeholder = t.batch.placeholder;
      }
    }

    function getNestedValue(obj, path) {
      return path.split('.').reduce((current, key) => current?.[key], obj);
    }

    function t(key, replacements = {}) {
      const lang = translations[currentLang] || translations['de'];
      let value = getNestedValue(lang, key) || key;

      // Replace placeholders like {count}
      Object.entries(replacements).forEach(([k, v]) => {
        value = value.replace(`{${k}}`, v);
      });

      return value;
    }

    // ========================================
    // Phase 4: Document Upload & Analysis
    // ========================================

    let selectedDocument = null;
    const API_DOCUMENT_URL = `${API_BASE}/analyze-document`;

    function initDocumentUpload() {
      const dropZone = document.getElementById('docDropZone');
      const fileInput = document.getElementById('documentFile');
      const form = document.getElementById('documentForm');

      if (!dropZone || !fileInput) return;

      // Click to select
      dropZone.addEventListener('click', () => fileInput.click());

      // Drag & drop
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
      });

      dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
      });

      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        const file = e.dataTransfer.files[0];
        if (file) handleDocumentSelect(file);
      });

      // File input change
      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleDocumentSelect(file);
      });

      // Form submit
      if (form) {
        form.addEventListener('submit', handleDocumentSubmit);
      }
    }

    function handleDocumentSelect(file) {
      const maxImageSize = 10 * 1024 * 1024; // 10 MB
      const maxPdfSize = 25 * 1024 * 1024; // 25 MB
      const isImage = file.type.startsWith('image/');
      const isPdf = file.type === 'application/pdf';

      if (!isImage && !isPdf) {
        alert('Bitte nur Bilder (PNG, JPG) oder PDFs hochladen.');
        return;
      }

      const maxSize = isImage ? maxImageSize : maxPdfSize;
      if (file.size > maxSize) {
        alert(`Datei zu groÃŸ. Maximum: ${maxSize / 1024 / 1024} MB`);
        return;
      }

      selectedDocument = file;

      // Show preview
      const preview = document.getElementById('documentPreview');
      const fileName = document.getElementById('docFileName');
      const fileSize = document.getElementById('docFileSize');
      const previewImage = document.getElementById('docPreviewImage');
      const previewPdf = document.getElementById('docPreviewPdf');
      const ocrOptions = document.getElementById('ocrOptions');
      const submitBtn = document.getElementById('docSubmitBtn');

      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);

      if (isImage) {
        const reader = new FileReader();
        reader.onload = (e) => {
          previewImage.src = e.target.result;
          previewImage.style.display = 'block';
          previewPdf.style.display = 'none';
        };
        reader.readAsDataURL(file);
      } else {
        previewImage.style.display = 'none';
        previewPdf.style.display = 'flex';
      }

      preview.style.display = 'block';
      ocrOptions.style.display = 'flex';
      submitBtn.disabled = false;

      // Hide upload zone text
      document.getElementById('docDropZone').classList.add('has-file');
    }

    function removeDocument() {
      selectedDocument = null;
      document.getElementById('documentPreview').style.display = 'none';
      document.getElementById('ocrOptions').style.display = 'none';
      document.getElementById('docSubmitBtn').disabled = true;
      document.getElementById('docDropZone').classList.remove('has-file');
      document.getElementById('documentFile').value = '';
    }

    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    async function handleDocumentSubmit(e) {
      e.preventDefault();

      if (!selectedDocument) {
        alert('Bitte zuerst ein Dokument auswÃ¤hlen.');
        return;
      }

      const btn = document.getElementById('docSubmitBtn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      btn.disabled = true;

      try {
        const formData = new FormData();
        formData.append('file', selectedDocument);
        formData.append('lang', currentLang);
        formData.append('options', JSON.stringify({
          ocr: document.getElementById('enableOcr').checked,
          sentiment: document.getElementById('enableSentiment').checked
        }));

        const response = await fetch(API_DOCUMENT_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();
        renderDocumentResults(data);

      } catch (error) {
        console.error('Document analysis error:', error);
        document.getElementById('documentResults').innerHTML = `
          <div class="doc-error">
            <span class="error-icon">âš ï¸</span>
            <span>${t('errors.analysisError')}: ${error.message}</span>
          </div>
        `;
        document.getElementById('documentResults').style.display = 'block';
      } finally {
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function renderDocumentResults(data) {
      const resultsDiv = document.getElementById('documentResults');
      const extractedSection = document.getElementById('extractedTextSection');
      const sentimentSection = document.getElementById('sentimentSection');
      const riskDashboard = document.getElementById('docRiskDashboard');

      // Show extracted text if available
      if (data.document?.extractedText) {
        document.getElementById('extractedText').textContent = data.document.extractedText;
        if (data.document.ocrConfidence) {
          document.getElementById('ocrConfidence').textContent =
            `${Math.round(data.document.ocrConfidence * 100)}% ${t('document.confidence')}`;
        }
        extractedSection.style.display = 'block';
      } else {
        extractedSection.style.display = 'none';
      }

      // Show sentiment if available
      if (data.sentiment) {
        const sentimentResult = document.getElementById('sentimentResult');
        const sentimentLabels = {
          positive: { icon: 'ğŸ˜Š', text: t('document.sentimentPositive'), class: 'positive' },
          neutral: { icon: 'ğŸ˜', text: t('document.sentimentNeutral'), class: 'neutral' },
          negative: { icon: 'ğŸ˜Ÿ', text: t('document.sentimentNegative'), class: 'negative' }
        };
        const s = sentimentLabels[data.sentiment.label] || sentimentLabels.neutral;

        sentimentResult.innerHTML = `
          <span class="sentiment-icon">${s.icon}</span>
          <span class="sentiment-label ${s.class}">${s.text}</span>
          <span class="sentiment-score">${(data.sentiment.score * 100).toFixed(0)}%</span>
        `;
        sentimentSection.style.display = 'block';
      } else {
        sentimentSection.style.display = 'none';
      }

      // Render risk dashboard using existing function
      if (data.categories && data.categories.length > 0) {
        // Re-use existing dashboard rendering
        const dashboardHtml = generateDashboardHtml(data, data.document?.extractedText || '');
        riskDashboard.innerHTML = dashboardHtml;
      } else {
        riskDashboard.innerHTML = `
          <div class="all-safe-message">
            <div class="all-safe-icon">ğŸ›¡ï¸</div>
            <div class="all-safe-title">${t('results.safe')}</div>
            <div class="all-safe-text">${t('results.safeText')}</div>
          </div>
        `;
      }

      resultsDiv.style.display = 'block';
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function generateDashboardHtml(data, text) {
      const normalized = normalizeApiResponse(data, text);
      const { riskScore, riskLevel, categories } = normalized;

      return `
        <div class="privacy-score-section">
          <div class="privacy-score-label">${t('results.privacyScore')}</div>
          <div class="privacy-score-circle ${riskLevel}">
            <span class="privacy-score-number">${riskScore}</span>
            <span class="privacy-score-max">/ 100</span>
          </div>
          <div class="privacy-score-status ${riskLevel}">${getStatusText(riskLevel)}</div>
        </div>
        <div class="risk-categories">
          ${categories.map(cat => {
            const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
            return `<span class="risk-category-badge ${cat.severity || 'medium'}">
              ${meta.icon} ${t('categories.' + cat.type) || meta.label}
            </span>`;
          }).join('')}
        </div>
      `;
    }

    // ========================================
    // Phase 4: PWA Support
    // ========================================

    let deferredPrompt = null;

    function initPWA() {
      // Register service worker
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js')
          .then(registration => {
            console.log('Service Worker registered:', registration.scope);

            // Check for updates
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  showUpdatePrompt();
                }
              });
            });
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      }

      // Listen for install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallPrompt();
      });

      // Track install
      window.addEventListener('appinstalled', () => {
        console.log('PWA installed');
        hideInstallPrompt();
        deferredPrompt = null;
      });

      // Online/offline detection
      window.addEventListener('online', updateOnlineStatus);
      window.addEventListener('offline', updateOnlineStatus);
      updateOnlineStatus();
    }

    function showInstallPrompt() {
      const prompt = document.getElementById('pwaInstallPrompt');
      if (prompt && !localStorage.getItem('achtung-pwa-dismissed')) {
        prompt.style.display = 'flex';
      }
    }

    function hideInstallPrompt() {
      const prompt = document.getElementById('pwaInstallPrompt');
      if (prompt) {
        prompt.style.display = 'none';
      }
    }

    function dismissPWAPrompt() {
      hideInstallPrompt();
      localStorage.setItem('achtung-pwa-dismissed', 'true');
    }

    async function installPWA() {
      if (!deferredPrompt) return;

      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;

      if (outcome === 'accepted') {
        console.log('User accepted PWA install');
      }

      deferredPrompt = null;
      hideInstallPrompt();
    }

    function showUpdatePrompt() {
      // Could show a toast notification here
      console.log('New version available');
    }

    function updateOnlineStatus() {
      const indicator = document.getElementById('offlineIndicator');
      if (indicator) {
        indicator.style.display = navigator.onLine ? 'none' : 'flex';
      }

      // Update API status when coming back online
      if (navigator.onLine) {
        checkApiHealth();
        // Re-cache patterns when coming back online
        cacheOfflinePatterns();
      }
    }

    // ========================================
    // Offline Pattern Caching
    // ========================================

    let offlinePatterns = null;
    const API_PATTERNS_URL = `${API_BASE}/patterns-offline`;
    const API_PING_URL = `${API_BASE}/ping`;

    async function cacheOfflinePatterns() {
      try {
        const response = await fetch(`${API_PATTERNS_URL}?lang=${currentLang}`);
        if (response.ok) {
          offlinePatterns = await response.json();
          localStorage.setItem('achtung-offline-patterns', JSON.stringify(offlinePatterns));
          console.log('[PWA] Offline patterns cached:', offlinePatterns.patterns?.length || 0, 'patterns');

          // Tell service worker to cache this
          if (navigator.serviceWorker?.controller) {
            navigator.serviceWorker.controller.postMessage({
              type: 'CACHE_PATTERNS',
              payload: { url: `${API_PATTERNS_URL}?lang=${currentLang}` }
            });
          }
        }
      } catch (error) {
        console.log('[PWA] Could not cache patterns:', error.message);
        // Try to load from localStorage
        const cached = localStorage.getItem('achtung-offline-patterns');
        if (cached) {
          offlinePatterns = JSON.parse(cached);
        }
      }
    }

    // Offline analysis using cached patterns (fallback when API unavailable)
    function analyzeOffline(text) {
      if (!offlinePatterns?.patterns) {
        return { error: 'No offline patterns available' };
      }

      const categories = [];
      const patterns = offlinePatterns.patterns;

      for (const [type, config] of Object.entries(patterns)) {
        try {
          const regex = new RegExp(config.regex, config.flags || 'gi');
          const matches = text.match(regex);
          if (matches) {
            matches.forEach(match => {
              categories.push({
                type,
                severity: config.severity || 'medium',
                match,
                message: config.message || 'Sensitive data detected',
                position: {
                  start: text.indexOf(match),
                  end: text.indexOf(match) + match.length
                }
              });
            });
          }
        } catch (e) {
          // Skip invalid regex
        }
      }

      const riskScore = calculateRiskScore(categories);

      return {
        riskScore,
        riskLevel: getRiskLevel(riskScore),
        categories,
        summary: `${categories.length} potential risks detected (offline)`,
        meta: {
          mode: 'offline',
          patternsUsed: Object.keys(patterns).length
        }
      };
    }

    // Quick ping to check if API is reachable
    async function pingApi() {
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);

        const response = await fetch(API_PING_URL, {
          method: 'GET',
          signal: controller.signal
        });

        clearTimeout(timeoutId);
        return response.ok;
      } catch (error) {
        return false;
      }
    }

    // ========================================
    // Initialize Everything
    // ========================================

    document.addEventListener('DOMContentLoaded', async function() {
      // Initialize Phase 2 features
      initTabs();
      initBatchAnalysis();
      checkApiHealth();

      // Initialize Phase 3 accessibility features
      loadAccessibilityPreferences();

      // Initialize Phase 4 features
      initDocumentUpload();
      initPWA();

      // Load saved language preference
      const savedLang = localStorage.getItem('achtung-lang') || 'de';
      translations[savedLang] = await loadTranslations(savedLang);
      if (savedLang !== 'de') {
        switchLanguage(savedLang);
      } else {
        // Load DE translations for t() function
        translations['de'] = await loadTranslations('de');
      }

      // Cache offline patterns for PWA
      cacheOfflinePatterns();

      // Check health every 60 seconds
      setInterval(checkApiHealth, 60000);

      if (typeof achtungAuth !== 'undefined') {
        if (achtungAuth.isAuthenticated()) {
          document.querySelectorAll('.protected-content').forEach(el => {
            el.style.display = 'block';
          });
          document.querySelectorAll('.auth-required').forEach(el => {
            el.style.display = 'none';
          });
          document.getElementById('logoutBtn').style.display = 'block';
        } else {
          achtungAuth.protectPage();
        }
      }
    });
  </script>
</body>
</html>
