<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Demo | achtung.live ‚Äì Teste den Airbag f√ºr digitale Kommunikation">
  <meta name="robots" content="index,follow">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <title>Demo | achtung.live</title>
</head>
<body>
  <!-- Accessibility Toolbar -->
  <div class="accessibility-toolbar" role="toolbar" aria-label="Barrierefreiheit-Einstellungen">
    <div class="a11y-group">
      <span class="a11y-label">Schrift:</span>
      <button class="a11y-btn" onclick="changeFontSize(-1)" aria-label="Schrift verkleinern" title="Kleinere Schrift">A-</button>
      <button class="a11y-btn" onclick="changeFontSize(0)" aria-label="Standard Schriftgr√∂√üe" title="Standard">A</button>
      <button class="a11y-btn" onclick="changeFontSize(1)" aria-label="Schrift vergr√∂√üern" title="Gr√∂√üere Schrift">A+</button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="contrastToggle" onclick="toggleHighContrast()" aria-label="Hoher Kontrast umschalten" title="Hoher Kontrast">
        <span class="a11y-icon">‚óê</span>
        <span class="a11y-text">Kontrast</span>
      </button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="simpleLangToggle" onclick="toggleSimpleLanguage()" aria-label="Einfache Sprache umschalten" title="Einfache Sprache f√ºr besseres Verst√§ndnis">
        <span class="a11y-icon">üìñ</span>
        <span class="a11y-text">Einfache Sprache</span>
      </button>
    </div>
    <div class="a11y-group">
      <button class="a11y-btn" id="realtimeToggle" onclick="toggleRealtime()" aria-label="Live-Pr√ºfung umschalten" title="Text wird w√§hrend des Tippens gepr√ºft">
        <span class="a11y-icon">‚ö°</span>
        <span class="a11y-text">Live-Pr√ºfung</span>
      </button>
    </div>
  </div>

  <!-- Logout Button (nur sichtbar wenn eingeloggt) -->
  <button id="logoutBtn" class="logout-button" style="display:none;" onclick="achtungAuth.logout()" aria-label="Abmelden">Abmelden</button>

  <header role="banner">
    <h1><span class="achtung-logo">[achtung.live]</span></h1>
    <p class="claim" id="mainClaim">Der Airbag f√ºr digitale Kommunikation</p>
    <!-- Simple language version (hidden by default) -->
    <p class="claim simple-lang" id="mainClaimSimple" style="display:none;">Wir helfen dir, keine privaten Daten zu teilen.</p>
  </header>

  <!-- Gesch√ºtzter Inhalt -->
  <main class="main-content protected-content" role="main">
    <!-- API Status Indicator -->
    <div id="apiStatus" class="api-status" role="status" aria-live="polite"></div>

    <!-- Live Check Indicator -->
    <div id="liveCheckIndicator" class="live-check-indicator" style="display:none;" role="status" aria-live="polite">
      <span class="live-dot"></span>
      <span class="live-text">Live-Pr√ºfung aktiv</span>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav" role="tablist" aria-label="Analyse-Modus w√§hlen">
      <button class="tab-btn active" data-tab="single" role="tab" aria-selected="true" aria-controls="singleTab">Einzeltext</button>
      <button class="tab-btn" data-tab="batch" role="tab" aria-selected="false" aria-controls="batchTab">Batch-Analyse</button>
    </div>

    <!-- Single Text Tab -->
    <div id="singleTab" class="tab-content active" role="tabpanel" aria-labelledby="single-tab">
      <h2 id="formTitle">Jetzt live testen!</h2>
      <p class="simple-lang form-description" id="formDescSimple" style="display:none;">
        Schreibe deinen Text unten. Wir sagen dir, ob private Daten drin sind.
      </p>
      <form id="demoForm" aria-describedby="formTitle">
        <label for="demoText" class="sr-only">Dein Text zur Pr√ºfung</label>
        <textarea id="demoText" placeholder="Schreibe hier deinen Text und lass ihn direkt √ºberpr√ºfen..." rows="6" required aria-label="Text eingeben zur Datenschutz-Pr√ºfung"></textarea>

        <!-- Live Preview (for real-time checking) -->
        <div id="livePreview" class="live-preview" style="display:none;" role="status" aria-live="polite">
          <div class="live-preview-header">
            <span class="live-preview-icon">üîç</span>
            <span class="live-preview-title">Live-Vorschau</span>
          </div>
          <div id="livePreviewContent" class="live-preview-content"></div>
        </div>

        <!-- Kontext-Auswahl -->
        <div class="context-selector">
          <label for="contextSelect">Wo soll dieser Text verwendet werden?</label>
          <select id="contextSelect" aria-describedby="contextHelp">
            <option value="private">Privater Chat (1:1)</option>
            <option value="whatsapp">WhatsApp Gruppe</option>
            <option value="email">E-Mail</option>
            <option value="linkedin">LinkedIn / Beruflich</option>
            <option value="public">√ñffentlicher Post (Social Media)</option>
          </select>
          <span id="contextHelp" class="simple-lang context-help" style="display:none;">
            W√§hle aus, wo du den Text posten m√∂chtest. Das hilft uns, besser zu pr√ºfen.
          </span>
        </div>

        <div class="datenschutz-hinweis">
          <input type="checkbox" id="privacyPolicyDemo" required aria-describedby="privacyHelp">
          <label for="privacyPolicyDemo">Ich akzeptiere die <a href="#" onclick="openModal('datenschutzModal'); return false;">Datenschutzerkl√§rung</a>.</label>
          <span id="privacyHelp" class="simple-lang" style="display:none;">Du musst das ankreuzen, damit wir deinen Text pr√ºfen d√ºrfen.</span>
        </div>
        <button type="submit" aria-label="Text auf sensible Daten pr√ºfen">Text analysieren</button>
      </form>

      <!-- Risk Dashboard -->
      <div id="riskDashboard" style="display:none;" role="region" aria-label="Analyse-Ergebnisse"></div>
    </div>

    <!-- Batch Analysis Tab -->
    <div id="batchTab" class="tab-content" role="tabpanel" aria-labelledby="batch-tab">
      <h2>Batch-Analyse</h2>
      <p class="batch-description">Analysiere mehrere Texte gleichzeitig (max. 20 Texte)</p>
      <p class="simple-lang batch-description-simple" style="display:none;">Pr√ºfe viele Texte auf einmal. Maximal 20 St√ºck.</p>

      <form id="batchForm">
        <div class="batch-input-area">
          <div class="batch-textarea-container">
            <textarea id="batchTexts" placeholder="F√ºge mehrere Texte ein, getrennt durch eine Leerzeile (2x Enter)..." rows="8"></textarea>
            <div class="batch-counter">
              <span id="textCount">0</span> / 20 Texte
            </div>
          </div>

          <div class="batch-divider">
            <span>oder</span>
          </div>

          <div class="batch-upload-area" id="dropZone">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Datei hierher ziehen</div>
            <div class="upload-subtext">oder klicken zum Ausw√§hlen (.txt, .csv)</div>
            <input type="file" id="batchFile" accept=".txt,.csv" hidden>
          </div>
        </div>

        <div class="datenschutz-hinweis">
          <input type="checkbox" id="privacyPolicyBatch" required>
          <label for="privacyPolicyBatch">Ich akzeptiere die <a href="#" onclick="openModal('datenschutzModal'); return false;">Datenschutzerkl√§rung</a>.</label>
        </div>

        <button type="submit" id="batchSubmitBtn">
          <span class="btn-text">Alle Texte analysieren</span>
          <span class="btn-loading" style="display:none;">Analysiere...</span>
        </button>
      </form>

      <!-- Batch Results -->
      <div id="batchResults" style="display:none;"></div>
    </div>

    <div style="text-align:center; margin-top:40px;">
      <button onclick="openModal('caseModal')">Fallbeispiele ansehen</button>
    </div>
  </main>

  <!-- Hinweis vor Authentifizierung -->
  <main class="main-content auth-required">
    <h2>Demo-Zugang</h2>
    <p>Die Live-Demo ist passwortgesch√ºtzt.</p>
    <p>Bitte gib das Passwort ein, um fortzufahren.</p>
  </main>

  <!-- Popup f√ºr Datenschutz -->
  <div id="datenschutzModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('datenschutzModal')">&times;</span>
      <iframe src="datenschutz-popup2.html" style="width:100%; height:400px; border:none;"></iframe>
    </div>
  </div>

  <!-- Popup f√ºr Fallbeispiele -->
  <div id="caseModal" class="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal('caseModal')">&times;</span>

      <div class="case-study-container">
        <div class="case-study-box active">
          <h3>Fallbeispiel: Kreditkartendaten unbewusst geteilt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Meine Kreditkartennummer lautet: 3948673029486</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Teile sensible Bankdaten wie IBANs oder Kreditkartennummern niemals √∂ffentlich.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Ich sende dir meine Zahlungsdaten separat √ºber einen sicheren Kanal.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Nutze verschl√ºsselte Messenger wie Signal oder sichere Kan√§le deiner Bank.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Standortdaten √∂ffentlich geteilt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Bin gerade im Urlaub in Italien</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Standortinformationen verraten, wo du bist - und wo nicht...</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Bis bald ‚Äì ich melde mich wieder mit Neuigkeiten!</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Poste Urlaubs-Updates erst nach deiner R√ºckkehr.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Screenshot mit Patientendaten</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">(Screenshot) Diagnosebericht meiner √Ñrztin f√ºr die Krankenkasse</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Fotos von Dokumenten k√∂nnen vertrauliche Gesundheitsdaten enthalten.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Bitte sichere √úbertragungswege f√ºr Dokumente verwenden.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Nutze verschl√ºsselte √úbermittlung, keine Messenger-Screenshots.</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Arbeitgeber namentlich erw√§hnt</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">Mein Chef bei der XY AG ist total unf√§hig...</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Nennungen von Firmen und Namen k√∂nnen rechtliche Folgen haben.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Ich habe in meinem Job aktuell Herausforderungen mit der F√ºhrungskultur.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Personen anonymisieren ‚Äì Fokus auf die Sache!</div>
        </div>

        <div class="case-study-box">
          <h3>Fallbeispiel: Messenger-Screenshot mit Klarnamen</h3>
          <div class="label">Originaltext eines Nutzers:</div>
          <div class="field">(Screenshot) WhatsApp-Chat mit vollem Namen sichtbar</div>
          <div class="label">achtung.live Feedback:</div>
          <div class="feedback">Screenshots k√∂nnen pers√∂nliche Daten offenlegen.</div>
          <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
          <div class="field">Anonymisierte Screenshots oder Zitate verwenden.</div>
          <div class="label">achtung.live Tipp:</div>
          <div class="hint">Namen und Profilbilder vorher unkenntlich machen.</div>
        </div>
      </div>

      <div class="case-study-nav">
        <button onclick="changeCase(-1)">Zur√ºck</button>
        <button onclick="changeCase(1)">Weiter</button>
      </div>

      <div style="text-align:center; margin-top:20px;">
        <button onclick="closeModal('caseModal')">Schlie√üen</button>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="europe">Aus Europa. F√ºr Alle.</div>

    <div class="schutztext">
      [<span style="color: #800000;">achtung.live</span>] sch√ºtzt, was z√§hlt: unsere digitale Kommunikation. <br> In Echtzeit. Ohne Tracking. DSGVO & EU AI-Act-konform.
    </div>

    <nav class="footer-nav">
      <a href="info.html">Info</a> ‚Ä¢
      <a href="gefahr.html">Gefahr</a> ‚Ä¢
      <a href="demo.html" class="demo-highlight">Demo</a> ‚Ä¢
      <a href="ki-hinweis.html">KI-Hinweis</a> ‚Ä¢
      <a href="datenschutz.html">Datenschutz</a> ‚Ä¢
      <a href="kontakt.html">Kontakt</a> ‚Ä¢
      <a href="impressum.html">Impressum</a>
    </nav>

    <div class="copyright">
      ¬© 2025 achtung.live
    </div>
  </footer>

  <!-- Authentifizierungs-Script -->
  <script src="auth.js"></script>

  <script>
    // ========================================
    // API Konfiguration
    // ========================================
    const API_BASE = "/.netlify/functions";
    const API_ANALYZE_URL = `${API_BASE}/analyze`;
    const API_REWRITE_URL = `${API_BASE}/rewrite`;
    const API_BATCH_URL = `${API_BASE}/analyze-batch`;
    const API_HEALTH_URL = `${API_BASE}/health`;

    // Kategorie-Metadaten f√ºr das Dashboard (Phase 2: 25+ Kategorien)
    const CATEGORY_META = {
      // Finanzen
      iban: { label: "IBAN/Bankdaten", icon: "üè¶", group: "financial" },
      credit_card: { label: "Kreditkarte", icon: "üí≥", group: "financial" },
      bic: { label: "BIC/SWIFT", icon: "üèõÔ∏è", group: "financial" },
      account_number: { label: "Kontonummer", icon: "üí∞", group: "financial" },

      // Identifikation
      national_id: { label: "Personalausweis", icon: "ü™™", group: "identity" },
      passport: { label: "Reisepass", icon: "üìï", group: "identity" },
      tax_id: { label: "Steuer-ID", icon: "üìã", group: "identity" },
      social_security: { label: "Sozialversicherung", icon: "üÜî", group: "identity" },
      drivers_license: { label: "F√ºhrerschein", icon: "üöó", group: "identity" },

      // Gesundheit
      health_insurance: { label: "Krankenversicherung", icon: "üè•", group: "health" },
      medical_record: { label: "Medizinische Daten", icon: "üíä", group: "health" },
      health: { label: "Gesundheitsdaten", icon: "ü©∫", group: "health" },

      // Digital
      ip_address: { label: "IP-Adresse", icon: "üåê", group: "digital" },
      mac_address: { label: "MAC-Adresse", icon: "üì°", group: "digital" },
      username: { label: "Benutzername", icon: "üë§", group: "digital" },
      password: { label: "Passwort", icon: "üîë", group: "digital" },
      api_key: { label: "API-Schl√ºssel", icon: "üîê", group: "digital" },

      // Pers√∂nlich
      name: { label: "Personenname", icon: "üë§", group: "personal" },
      phone: { label: "Telefonnummer", icon: "üì±", group: "personal" },
      email: { label: "E-Mail-Adresse", icon: "üìß", group: "personal" },
      address: { label: "Postadresse", icon: "üìç", group: "personal" },
      date_of_birth: { label: "Geburtsdatum", icon: "üéÇ", group: "personal" },
      age: { label: "Alter", icon: "üî¢", group: "personal" },
      gender: { label: "Geschlecht", icon: "‚ößÔ∏è", group: "personal" },
      religion: { label: "Religion", icon: "üõê", group: "personal" },
      political: { label: "Politische Meinung", icon: "üó≥Ô∏è", group: "personal" },
      sexual_orientation: { label: "Sexuelle Orientierung", icon: "üè≥Ô∏è‚Äçüåà", group: "personal" },

      // Biometrisch
      biometric: { label: "Biometrische Daten", icon: "üëÅÔ∏è", group: "biometric" },
      photo: { label: "Erkennbares Foto", icon: "üì∏", group: "biometric" },

      // Standort
      gps_coordinates: { label: "GPS-Koordinaten", icon: "üõ∞Ô∏è", group: "location" },
      license_plate: { label: "Kfz-Kennzeichen", icon: "üöò", group: "location" },
      location: { label: "Standort", icon: "üìç", group: "location" },
      vacation: { label: "Abwesenheit/Urlaub", icon: "‚úàÔ∏è", group: "location" },

      // Semantisch (GPT-erkannt)
      child: { label: "Kinderdaten", icon: "üë∂", group: "semantic" },
      emotion: { label: "Emotionen", icon: "üò§", group: "semantic" },
      employer: { label: "Arbeitgeber", icon: "üè¢", group: "semantic" },
      legal: { label: "Rechtlich heikel", icon: "‚öñÔ∏è", group: "semantic" },

      // Fallback
      date: { label: "Datum/Termin", icon: "üìÖ", group: "other" },
      generic: { label: "Sensible Daten", icon: "‚ö†Ô∏è", group: "other" }
    };

    // Kontext-Warnungen
    const CONTEXT_WARNINGS = {
      whatsapp: "WhatsApp-Nachrichten k√∂nnen leicht weitergeleitet oder als Screenshot geteilt werden.",
      public: "√ñffentliche Posts sind f√ºr jeden sichtbar und k√∂nnen von Suchmaschinen indexiert werden.",
      linkedin: "Berufliche Netzwerke werden oft von Arbeitgebern und Recruitern durchsucht.",
      email: "E-Mails k√∂nnen weitergeleitet werden und verbleiben oft auf Servern.",
      private: null
    };

    // ========================================
    // Modal Funktionen
    // ========================================
    function openModal(id) {
      document.getElementById(id).style.display = "block";
    }

    function closeModal(id) {
      document.getElementById(id).style.display = "none";
    }

    // Fallbeispiele Navigation
    let currentCase = 0;
    const cases = document.querySelectorAll('.case-study-box');

    function changeCase(dir) {
      cases[currentCase].classList.remove('active');
      currentCase = (currentCase + dir + cases.length) % cases.length;
      cases[currentCase].classList.add('active');
    }

    // ========================================
    // Risk Dashboard Rendering
    // ========================================

    // Zeigt den Loading-Zustand
    function showLoading() {
      const dashboard = document.getElementById('riskDashboard');
      dashboard.style.display = 'block';
      dashboard.innerHTML = `
        <div class="risk-dashboard">
          <div class="dashboard-loading">
            <div class="loading-spinner"></div>
            <div class="loading-text">Analysiere deinen Text...</div>
          </div>
        </div>
      `;
    }

    // Berechnet Risk Score aus Kategorien (Fallback wenn Backend alt)
    function calculateRiskScore(categories) {
      if (!categories || categories.length === 0) return 100;

      let score = 100;
      for (const cat of categories) {
        switch (cat.severity) {
          case 'critical': score -= 35; break;
          case 'high': score -= 20; break;
          case 'medium': score -= 10; break;
          case 'low': score -= 5; break;
          default: score -= 15;
        }
      }
      return Math.max(0, score);
    }

    // Ermittelt Risk Level aus Score
    function getRiskLevel(score) {
      if (score >= 80) return 'safe';
      if (score >= 50) return 'warning';
      return 'danger';
    }

    // Status-Text f√ºr Risk Level
    function getStatusText(level) {
      switch (level) {
        case 'safe': return '‚úì SICHER';
        case 'warning': return '‚ö† ACHTUNG';
        case 'danger': return '‚úó GEFAHR';
        default: return 'UNBEKANNT';
      }
    }

    // Markiert sensible Stellen im Text (komplett neu geschrieben)
    function markText(text, categories) {
      if (!categories || categories.length === 0) return escapeHtml(text);

      // Sammle alle Markierungen mit korrekten Positionen
      const marks = categories
        .map(cat => {
          let start, end;
          if (cat.position && typeof cat.position.start === 'number') {
            start = cat.position.start;
            end = cat.position.end;
          } else if (cat.match) {
            start = text.indexOf(cat.match);
            end = start >= 0 ? start + cat.match.length : -1;
          } else {
            return null;
          }
          if (start < 0 || end <= start || end > text.length) return null;
          return { start, end, severity: cat.severity || 'medium', message: cat.message };
        })
        .filter(m => m !== null)
        .sort((a, b) => a.start - b.start);

      // Entferne √ºberlappende Markierungen (behalte die mit h√∂herer Severity)
      const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
      const filtered = [];
      for (const mark of marks) {
        const lastMark = filtered[filtered.length - 1];
        if (lastMark && mark.start < lastMark.end) {
          // √úberlappung: behalte die mit h√∂herer Severity
          if ((severityOrder[mark.severity] || 0) > (severityOrder[lastMark.severity] || 0)) {
            filtered[filtered.length - 1] = mark;
          }
          // Sonst ignorieren
        } else {
          filtered.push(mark);
        }
      }

      // Baue den String von links nach rechts auf
      let result = '';
      let lastEnd = 0;

      for (const mark of filtered) {
        // Text vor der Markierung (escaped)
        if (mark.start > lastEnd) {
          result += escapeHtml(text.substring(lastEnd, mark.start));
        }
        // Markierter Text
        const matchText = text.substring(mark.start, mark.end);
        result += `<span class="text-mark ${mark.severity}">${escapeHtml(matchText)}</span>`;
        lastEnd = mark.end;
      }

      // Rest des Textes nach der letzten Markierung
      if (lastEnd < text.length) {
        result += escapeHtml(text.substring(lastEnd));
      }

      return result;
    }

    // HTML Escape Helper
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Rendert das komplette Dashboard
    function renderDashboard(data, originalText, context) {
      const dashboard = document.getElementById('riskDashboard');

      // Normalisiere Daten (unterst√ºtzt altes und neues API-Format)
      const normalized = normalizeApiResponse(data, originalText);

      // Kontext-Warnung hinzuf√ºgen
      if (!normalized.contextWarning && CONTEXT_WARNINGS[context]) {
        normalized.contextWarning = CONTEXT_WARNINGS[context];
      }

      const { riskScore, riskLevel, categories, summary, contextWarning, rewrite } = normalized;

      // Wenn alles sicher ist
      if (categories.length === 0) {
        dashboard.innerHTML = `
          <div class="risk-dashboard">
            <div class="all-safe-message">
              <div class="all-safe-icon">üõ°Ô∏è</div>
              <div class="all-safe-title">Alles sicher!</div>
              <div class="all-safe-text">Keine sensiblen Daten in deinem Text erkannt.<br>Du kannst ihn bedenkenlos senden.</div>
            </div>
            ${contextWarning ? `
              <div class="context-warning">
                <span class="context-warning-icon">üí°</span>
                <span>${escapeHtml(contextWarning)}</span>
              </div>
            ` : ''}
          </div>
        `;
        return;
      }

      // Vollst√§ndiges Dashboard rendern
      dashboard.innerHTML = `
        <div class="risk-dashboard">
          <!-- Privacy Score -->
          <div class="privacy-score-section">
            <div class="privacy-score-label">Privacy Score</div>
            <div class="privacy-score-circle ${riskLevel}">
              <span class="privacy-score-number">${riskScore}</span>
              <span class="privacy-score-max">/ 100</span>
            </div>
            <div class="privacy-score-status ${riskLevel}">${getStatusText(riskLevel)}</div>
            <div class="privacy-score-summary">${escapeHtml(summary)}</div>
          </div>

          <!-- Kategorie-Badges -->
          <div class="risk-categories">
            ${categories.map(cat => {
              const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
              return `<span class="risk-category-badge ${cat.severity || 'medium'}">
                ${meta.icon} ${meta.label}
              </span>`;
            }).join('')}
          </div>

          <!-- Markierter Text -->
          <div class="marked-text-section">
            <div class="marked-text-label">Dein Text mit Markierungen</div>
            <div class="marked-text-container">${markText(originalText, categories)}</div>
          </div>

          <!-- Findings Liste -->
          <div class="findings-section">
            <div class="findings-list">
              ${categories.map(cat => {
                const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                return `
                  <div class="finding-item ${cat.severity || 'medium'}">
                    <div class="finding-icon">${meta.icon}</div>
                    <div class="finding-content">
                      <div class="finding-title">${meta.label}</div>
                      ${cat.match ? `<div class="finding-match">"${escapeHtml(cat.match.substring(0, 50))}${cat.match.length > 50 ? '...' : ''}"</div>` : ''}
                      <div class="finding-message">${escapeHtml(cat.message || 'Sensible Information erkannt')}</div>
                      ${cat.suggestion ? `<div class="finding-suggestion">${escapeHtml(cat.suggestion)}</div>` : ''}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>

          <!-- Kontext-Warnung -->
          ${contextWarning ? `
            <div class="context-warning">
              <span class="context-warning-icon">üí°</span>
              <span>${escapeHtml(contextWarning)}</span>
            </div>
          ` : ''}

          <!-- Smart Rewrite Section -->
          <div class="rewrite-section">
            <div class="rewrite-header">
              <span class="rewrite-icon">‚ú®</span>
              <span class="rewrite-title">Smart Rewrite</span>
            </div>

            <!-- Rewrite Mode Selection -->
            <div class="rewrite-mode-selector">
              <button class="rewrite-mode-btn active" data-mode="anonymize" onclick="selectRewriteMode('anonymize')">
                <span class="mode-icon">üè∑Ô∏è</span>
                <span class="mode-label">Anonymisieren</span>
                <span class="mode-desc">[NAME], [IBAN]...</span>
              </button>
              <button class="rewrite-mode-btn" data-mode="redact" onclick="selectRewriteMode('redact')">
                <span class="mode-icon">‚ñà</span>
                <span class="mode-label">Zensieren</span>
                <span class="mode-desc">[ZENSIERT]</span>
              </button>
              <button class="rewrite-mode-btn" data-mode="pseudonymize" onclick="selectRewriteMode('pseudonymize')">
                <span class="mode-icon">üé≠</span>
                <span class="mode-label">Pseudonymisieren</span>
                <span class="mode-desc">Fake-Daten</span>
              </button>
            </div>

            <button class="rewrite-generate-btn" onclick="generateRewrite()">
              <span class="btn-icon">‚ö°</span>
              <span class="btn-text">Text neu schreiben</span>
              <span class="btn-loading" style="display:none;">Generiere...</span>
            </button>

            <!-- Rewrite Result (initially hidden, shown after generation) -->
            <div id="rewriteResult" class="rewrite-result" style="display:none;">
              <div class="rewrite-container">
                <div class="rewrite-text" id="rewriteText"></div>
              </div>
              <div class="rewrite-changes" id="rewriteChanges"></div>
              <div class="rewrite-actions">
                <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
                  üìã Text kopieren
                </button>
                <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
                  ‚Ü©Ô∏è In Textfeld √ºbernehmen
                </button>
              </div>
            </div>

            <!-- Show existing rewrite if available from API -->
            ${rewrite ? `
              <div class="rewrite-result">
                <div class="rewrite-container">
                  <div class="rewrite-text" id="rewriteTextInitial">${escapeHtml(rewrite.suggestion || rewrite.rewritten || '')}</div>
                </div>
                ${rewrite.changes && rewrite.changes.length > 0 ? `
                  <div class="rewrite-changes">
                    ${rewrite.changes.map(change => {
                      const changeText = typeof change === 'string' ? change : `${change.original} ‚Üí ${change.replacement}`;
                      return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
                    }).join('')}
                  </div>
                ` : ''}
                <div class="rewrite-actions">
                  <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
                    üìã Text kopieren
                  </button>
                  <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
                    ‚Ü©Ô∏è In Textfeld √ºbernehmen
                  </button>
                </div>
              </div>
            ` : ''}
          </div>

          <!-- Provider Info (if available) -->
          ${data.meta ? `
            <div class="provider-info">
              <span class="provider-badge">${data.meta.provider || 'AI'}</span>
              <span class="provider-model">${data.meta.model || ''}</span>
              <span class="provider-time">${data.meta.processingTime ? `${data.meta.processingTime}ms` : ''}</span>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Generiert korrekten deutschen Summary-Text
    function generateSummary(categories) {
      if (!categories || categories.length === 0) {
        return 'Keine Risiken erkannt';
      }

      // Z√§hle nach Severity
      const counts = { critical: 0, high: 0, medium: 0, low: 0 };
      for (const cat of categories) {
        const sev = cat.severity || 'medium';
        counts[sev] = (counts[sev] || 0) + 1;
      }

      const parts = [];
      if (counts.critical > 0) {
        parts.push(`${counts.critical} kritische${counts.critical === 1 ? 's' : ''}`);
      }
      if (counts.high > 0) {
        parts.push(`${counts.high} hohe${counts.high === 1 ? 's' : ''}`);
      }
      if (counts.medium > 0) {
        parts.push(`${counts.medium} mittlere${counts.medium === 1 ? 's' : ''}`);
      }
      if (counts.low > 0) {
        parts.push(`${counts.low} geringe${counts.low === 1 ? 's' : ''}`);
      }

      if (parts.length === 0) {
        return `${categories.length} ${categories.length === 1 ? 'Risiko' : 'Risiken'} erkannt`;
      }

      const total = categories.length;
      return `${parts.join(', ')} ${total === 1 ? 'Risiko' : 'Risiken'} erkannt`;
    }

    // Normalisiert API-Response (unterst√ºtzt altes und neues Format)
    function normalizeApiResponse(data, originalText) {
      // Neues API v2 Format
      if (data.riskScore !== undefined && data.categories) {
        // √úberschreibe Summary mit korrektem Deutsch
        return {
          ...data,
          summary: generateSummary(data.categories)
        };
      }

      // Altes Format mit feedback Array
      if (data.feedback && Array.isArray(data.feedback)) {
        const categories = data.feedback.map((msg, i) => ({
          type: detectCategoryFromMessage(msg),
          severity: 'medium',
          message: msg,
          match: extractMatchFromMessage(msg, originalText)
        }));

        const riskScore = calculateRiskScore(categories);

        return {
          riskScore,
          riskLevel: getRiskLevel(riskScore),
          categories,
          summary: generateSummary(categories),
          rewrite: null
        };
      }

      // Altes Format mit detected_data etc.
      if (data.detected_data || data.risk_level) {
        const categories = [];
        if (data.detected_data && data.detected_data !== 'Keine') {
          categories.push({
            type: 'generic',
            severity: data.risk_level === 'hoch' ? 'critical' : 'medium',
            message: data.explanation || data.detected_data,
            suggestion: data.tip
          });
        }

        const riskScore = calculateRiskScore(categories);

        return {
          riskScore,
          riskLevel: getRiskLevel(riskScore),
          categories,
          summary: data.detected_data || 'Analyse abgeschlossen',
          rewrite: null
        };
      }

      // Fallback: Keine Risiken
      return {
        riskScore: 100,
        riskLevel: 'safe',
        categories: [],
        summary: 'Keine sensiblen Daten erkannt',
        rewrite: null
      };
    }

    // Erkennt Kategorie aus Nachrichtentext
    function detectCategoryFromMessage(msg) {
      const lower = msg.toLowerCase();
      if (lower.includes('iban') || lower.includes('bank') || lower.includes('konto')) return 'iban';
      if (lower.includes('kreditkarte') || lower.includes('kartennummer')) return 'credit_card';
      if (lower.includes('telefon') || lower.includes('handy') || lower.includes('nummer')) return 'phone';
      if (lower.includes('e-mail') || lower.includes('email')) return 'email';
      if (lower.includes('adresse') || lower.includes('stra√üe') || lower.includes('wohnort')) return 'address';
      if (lower.includes('passwort') || lower.includes('kennwort')) return 'password';
      if (lower.includes('gesundheit') || lower.includes('krankheit') || lower.includes('arzt') || lower.includes('diagnose')) return 'health';
      if (lower.includes('kind') || lower.includes('sohn') || lower.includes('tochter') || lower.includes('schule')) return 'child';
      if (lower.includes('standort') || lower.includes('urlaub') || lower.includes('reise') || lower.includes('nicht zuhause')) return 'vacation';
      if (lower.includes('w√ºtend') || lower.includes('emotion') || lower.includes('√§rger') || lower.includes('hass')) return 'emotion';
      if (lower.includes('chef') || lower.includes('arbeitgeber') || lower.includes('firma') || lower.includes('kollege')) return 'employer';
      if (lower.includes('beleidigung') || lower.includes('drohung') || lower.includes('rechtlich')) return 'legal';
      if (lower.includes('name') || lower.includes('person')) return 'name';
      return 'generic';
    }

    // Extrahiert Match aus Nachricht (einfache Heuristik)
    function extractMatchFromMessage(msg, originalText) {
      // Versuche Text in Anf√ºhrungszeichen zu finden
      const quoted = msg.match(/"([^"]+)"/);
      if (quoted) return quoted[1];

      // Sonst null
      return null;
    }

    // ========================================
    // Rewrite Funktionen (Phase 2)
    // ========================================

    let currentRewriteMode = 'anonymize';
    let lastAnalyzedText = '';

    function selectRewriteMode(mode) {
      currentRewriteMode = mode;
      document.querySelectorAll('.rewrite-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
      });
    }

    async function generateRewrite(originalText) {
      const text = originalText || lastAnalyzedText || document.getElementById('demoText').value;
      if (!text) return;

      const btn = document.querySelector('.rewrite-generate-btn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      // Show loading state
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      btn.disabled = true;

      try {
        const response = await fetch(API_REWRITE_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            text: text,
            mode: currentRewriteMode
          })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();

        // Show result
        const resultDiv = document.getElementById('rewriteResult');
        const rewriteTextDiv = document.getElementById('rewriteText');
        const changesDiv = document.getElementById('rewriteChanges');

        if (data.rewritten) {
          rewriteTextDiv.textContent = data.rewritten;

          // Show changes
          if (data.changes && data.changes.length > 0) {
            changesDiv.innerHTML = data.changes.map(change => {
              const changeText = typeof change === 'string' ? change : `${change.original} ‚Üí ${change.replacement}`;
              return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
            }).join('');
          } else {
            changesDiv.innerHTML = '';
          }

          resultDiv.style.display = 'block';
        }

      } catch (error) {
        console.error('Rewrite error:', error);
        alert('Fehler beim Rewrite: ' + error.message);
      } finally {
        // Reset button state
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function copyRewrite() {
      const text = document.getElementById('rewriteText')?.innerText ||
                   document.getElementById('rewriteTextInitial')?.innerText;
      if (text) {
        navigator.clipboard.writeText(text).then(() => {
          const btn = event.target.closest('button');
          const originalHTML = btn.innerHTML;
          btn.innerHTML = '‚úì Kopiert!';
          btn.classList.add('copy-success');
          setTimeout(() => {
            btn.innerHTML = originalHTML;
            btn.classList.remove('copy-success');
          }, 2000);
        });
      }
    }

    function useRewrite() {
      const text = document.getElementById('rewriteText')?.innerText ||
                   document.getElementById('rewriteTextInitial')?.innerText;
      if (text) {
        document.getElementById('demoText').value = text;
        // Scroll zum Textfeld
        document.getElementById('demoText').scrollIntoView({ behavior: 'smooth' });
        document.getElementById('demoText').focus();
      }
    }

    // ========================================
    // Tab Navigation
    // ========================================

    function initTabs() {
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const tabId = btn.dataset.tab;

          // Update buttons
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          // Update content
          document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
          });
          document.getElementById(tabId + 'Tab').classList.add('active');
        });
      });
    }

    // ========================================
    // Batch Analyse (Phase 2)
    // ========================================

    function initBatchAnalysis() {
      const textarea = document.getElementById('batchTexts');
      const dropZone = document.getElementById('dropZone');
      const fileInput = document.getElementById('batchFile');
      const form = document.getElementById('batchForm');

      // Count texts as user types
      if (textarea) {
        textarea.addEventListener('input', () => {
          const texts = parseTexts(textarea.value);
          document.getElementById('textCount').textContent = texts.length;
        });
      }

      // Drag & Drop
      if (dropZone) {
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
          e.preventDefault();
          dropZone.classList.add('drag-over');
        });

        dropZone.addEventListener('dragleave', () => {
          dropZone.classList.remove('drag-over');
        });

        dropZone.addEventListener('drop', (e) => {
          e.preventDefault();
          dropZone.classList.remove('drag-over');
          const file = e.dataTransfer.files[0];
          if (file) handleFile(file);
        });
      }

      // File input change
      if (fileInput) {
        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) handleFile(file);
        });
      }

      // Form submit
      if (form) {
        form.addEventListener('submit', handleBatchSubmit);
      }
    }

    function parseTexts(input) {
      if (!input || !input.trim()) return [];
      // Split by double newline (empty line)
      return input.split(/\n\s*\n/)
        .map(t => t.trim())
        .filter(t => t.length > 0)
        .slice(0, 20); // Max 20 texts
    }

    function handleFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const content = e.target.result;
        let texts = [];

        if (file.name.endsWith('.csv')) {
          // Parse CSV (assume one text per line)
          texts = content.split('\n').filter(t => t.trim());
        } else {
          // Parse TXT (double newline separated)
          texts = parseTexts(content);
        }

        document.getElementById('batchTexts').value = texts.join('\n\n');
        document.getElementById('textCount').textContent = Math.min(texts.length, 20);
      };
      reader.readAsText(file);
    }

    async function handleBatchSubmit(e) {
      e.preventDefault();

      const texts = parseTexts(document.getElementById('batchTexts').value);
      if (texts.length === 0) {
        alert('Bitte mindestens einen Text eingeben.');
        return;
      }

      const btn = document.getElementById('batchSubmitBtn');
      const btnText = btn.querySelector('.btn-text');
      const btnLoading = btn.querySelector('.btn-loading');

      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';
      btn.disabled = true;

      try {
        const response = await fetch(API_BATCH_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            texts: texts.map((text, i) => ({ id: `text-${i}`, text }))
          })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();
        renderBatchResults(data, texts);

      } catch (error) {
        console.error('Batch error:', error);
        document.getElementById('batchResults').innerHTML = `
          <div class="batch-error">
            <span class="error-icon">‚ö†Ô∏è</span>
            <span>Fehler: ${escapeHtml(error.message)}</span>
          </div>
        `;
        document.getElementById('batchResults').style.display = 'block';
      } finally {
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
        btn.disabled = false;
      }
    }

    function renderBatchResults(data, originalTexts) {
      const resultsDiv = document.getElementById('batchResults');

      // Calculate summary from results if not provided
      const results = data.results || [];
      const totalTexts = results.length;

      // Calculate average score
      const scores = results
        .filter(r => r.success !== false && r.analysis?.riskScore !== undefined)
        .map(r => r.analysis.riskScore);
      const averageScore = scores.length > 0
        ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
        : 100;

      // Calculate total risks
      const totalRisks = results.reduce((sum, r) =>
        sum + (r.analysis?.categories?.length || 0), 0);

      resultsDiv.innerHTML = `
        <div class="batch-results-container">
          <!-- Summary -->
          <div class="batch-summary">
            <div class="batch-summary-item">
              <span class="summary-number">${totalTexts}</span>
              <span class="summary-label">Texte analysiert</span>
            </div>
            <div class="batch-summary-item">
              <span class="summary-number ${averageScore >= 80 ? 'safe' : averageScore >= 50 ? 'warning' : 'danger'}">
                ${averageScore}
              </span>
              <span class="summary-label">Durchschn. Score</span>
            </div>
            <div class="batch-summary-item">
              <span class="summary-number">${totalRisks}</span>
              <span class="summary-label">Risiken gesamt</span>
            </div>
          </div>

          <!-- Individual Results -->
          <div class="batch-results-list">
            ${results.map((result, i) => {
              const text = originalTexts[i] || '';
              const preview = text.substring(0, 100) + (text.length > 100 ? '...' : '');
              const analysis = result.analysis || {};
              const riskScore = analysis.riskScore ?? 100;
              const level = getRiskLevel(riskScore);
              const riskCount = analysis.categories?.length || 0;

              return `
                <div class="batch-result-item ${level}">
                  <div class="result-header">
                    <span class="result-number">#${i + 1}</span>
                    <span class="result-score ${level}">${riskScore}/100</span>
                  </div>
                  <div class="result-preview">${escapeHtml(preview)}</div>
                  ${riskCount > 0 ? `
                    <div class="result-risks">
                      ${analysis.categories.slice(0, 3).map(cat => {
                        const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                        return `<span class="risk-mini-badge ${cat.severity || 'medium'}">${meta.icon}</span>`;
                      }).join('')}
                      ${riskCount > 3 ? `<span class="risk-more">+${riskCount - 3}</span>` : ''}
                    </div>
                  ` : '<div class="result-safe">‚úì Sicher</div>'}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;

      resultsDiv.style.display = 'block';
      resultsDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // ========================================
    // Health Check & API Status
    // ========================================

    async function checkApiHealth() {
      const statusDiv = document.getElementById('apiStatus');
      if (!statusDiv) return;

      try {
        const response = await fetch(API_HEALTH_URL);
        const data = await response.json();

        // Accept various healthy status values
        const isHealthy = data.status === 'healthy' ||
                          data.status === 'ok' ||
                          data.status === 'up' ||
                          response.ok;

        if (isHealthy) {
          const providerInfo = data.providers || {};
          const openaiOk = providerInfo.openai?.status === 'ok' || providerInfo.openai?.available;
          const anthropicOk = providerInfo.anthropic?.status === 'ok' || providerInfo.anthropic?.available;

          statusDiv.innerHTML = `
            <span class="status-dot healthy"></span>
            <span class="status-text">API Online</span>
            ${(openaiOk || anthropicOk) ? `
              <span class="provider-status">
                ${openaiOk ? 'üü¢ OpenAI' : ''}
                ${anthropicOk ? 'üü¢ Claude' : ''}
              </span>
            ` : ''}
          `;
          statusDiv.className = 'api-status healthy';
        } else if (data.status === 'degraded') {
          statusDiv.innerHTML = `
            <span class="status-dot degraded"></span>
            <span class="status-text">Eingeschr√§nkt</span>
          `;
          statusDiv.className = 'api-status degraded';
        } else {
          statusDiv.innerHTML = `
            <span class="status-dot degraded"></span>
            <span class="status-text">Status: ${data.status || 'unbekannt'}</span>
          `;
          statusDiv.className = 'api-status degraded';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          <span class="status-dot offline"></span>
          <span class="status-text">API Offline</span>
        `;
        statusDiv.className = 'api-status offline';
      }
    }

    // ========================================
    // Formular Handler
    // ========================================

    document.getElementById("demoForm").addEventListener("submit", async function (e) {
      e.preventDefault();
      const text = document.getElementById("demoText").value;
      const context = document.getElementById("contextSelect").value;

      // Store for rewrite function
      lastAnalyzedText = text;

      showLoading();

      try {
        const response = await fetch(API_ANALYZE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text, context })
        });

        if (!response.ok) {
          throw new Error(`Server-Fehler: ${response.status}`);
        }

        const data = await response.json();
        renderDashboard(data, text, context);

        // Scroll zum Dashboard
        document.getElementById('riskDashboard').scrollIntoView({ behavior: 'smooth' });

      } catch (err) {
        const dashboard = document.getElementById('riskDashboard');
        dashboard.innerHTML = `
          <div class="risk-dashboard">
            <div style="padding: 40px 20px; text-align: center;">
              <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
              <div style="font-size: 18px; font-weight: 600; color: #dc3545; margin-bottom: 10px;">
                Fehler bei der Analyse
              </div>
              <div style="font-size: 14px; color: #6c757d;">
                ${escapeHtml(err.message)}<br>
                <small>Bitte versuche es sp√§ter erneut.</small>
              </div>
            </div>
          </div>
        `;
      }
    });

    // ========================================
    // Event Listener
    // ========================================

    // Schlie√üen bei Klick au√üerhalb des Modals
    window.onclick = function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    };

    // ========================================
    // Phase 3: Accessibility Functions
    // ========================================

    let currentFontSize = 0; // -2 to +2 scale
    let highContrastMode = false;
    let simpleLanguageMode = false;
    let realtimeMode = false;
    let realtimeTimeout = null;

    // Font Size Control
    function changeFontSize(dir) {
      if (dir === 0) {
        currentFontSize = 0;
      } else {
        currentFontSize = Math.max(-2, Math.min(2, currentFontSize + dir));
      }

      // Base font size is 16px
      const baseFontSize = 16;
      const fontSizeMap = {
        '-2': 12,
        '-1': 14,
        '0': 16,
        '1': 18,
        '2': 22
      };

      document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';

      // Update button states
      document.querySelectorAll('.a11y-group .a11y-btn').forEach((btn, i) => {
        if (i < 3) { // Only the font size buttons
          btn.classList.toggle('active',
            (i === 0 && currentFontSize < 0) ||
            (i === 1 && currentFontSize === 0) ||
            (i === 2 && currentFontSize > 0)
          );
        }
      });

      // Save preference
      localStorage.setItem('achtung-fontSize', currentFontSize);
    }

    // High Contrast Mode
    function toggleHighContrast() {
      highContrastMode = !highContrastMode;
      document.body.classList.toggle('high-contrast', highContrastMode);
      document.getElementById('contrastToggle').classList.toggle('active', highContrastMode);

      // Save preference
      localStorage.setItem('achtung-highContrast', highContrastMode);
    }

    // Simple Language Mode
    function toggleSimpleLanguage() {
      simpleLanguageMode = !simpleLanguageMode;
      document.body.classList.toggle('simple-language', simpleLanguageMode);
      document.getElementById('simpleLangToggle').classList.toggle('active', simpleLanguageMode);

      // Show/hide simple language elements
      document.querySelectorAll('.simple-lang').forEach(el => {
        el.style.display = simpleLanguageMode ? 'block' : 'none';
      });

      // Update main claim
      document.getElementById('mainClaim').style.display = simpleLanguageMode ? 'none' : 'block';
      document.getElementById('mainClaimSimple').style.display = simpleLanguageMode ? 'block' : 'none';

      // Save preference
      localStorage.setItem('achtung-simpleLanguage', simpleLanguageMode);
    }

    // Real-Time Checking
    function toggleRealtime() {
      realtimeMode = !realtimeMode;
      document.getElementById('realtimeToggle').classList.toggle('active', realtimeMode);
      document.getElementById('liveCheckIndicator').style.display = realtimeMode ? 'flex' : 'none';
      document.getElementById('livePreview').style.display = realtimeMode ? 'block' : 'none';

      if (realtimeMode) {
        // Add input listener for real-time checking
        document.getElementById('demoText').addEventListener('input', handleRealtimeInput);
        // Initial check if there's text
        const currentText = document.getElementById('demoText').value;
        if (currentText.trim().length > 10) {
          handleRealtimeInput();
        }
      } else {
        document.getElementById('demoText').removeEventListener('input', handleRealtimeInput);
        document.getElementById('livePreviewContent').innerHTML = '';
      }

      // Save preference
      localStorage.setItem('achtung-realtime', realtimeMode);
    }

    // Debounced real-time input handler
    function handleRealtimeInput() {
      clearTimeout(realtimeTimeout);

      const text = document.getElementById('demoText').value;
      const previewContent = document.getElementById('livePreviewContent');

      if (text.trim().length < 10) {
        previewContent.innerHTML = '<span class="live-hint">Mindestens 10 Zeichen f√ºr Live-Pr√ºfung...</span>';
        return;
      }

      // Show checking indicator
      previewContent.innerHTML = '<span class="live-checking"><span class="live-spinner"></span> Pr√ºfe...</span>';

      // Debounce: Wait 800ms after typing stops
      realtimeTimeout = setTimeout(async () => {
        try {
          const response = await fetch(API_ANALYZE_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              text: text,
              context: document.getElementById('contextSelect').value,
              options: { quickCheck: true }
            })
          });

          if (!response.ok) throw new Error('API Error');

          const data = await response.json();
          renderLivePreview(data, text);

        } catch (error) {
          previewContent.innerHTML = '<span class="live-error">Pr√ºfung fehlgeschlagen</span>';
        }
      }, 800);
    }

    // Render live preview results
    function renderLivePreview(data, text) {
      const previewContent = document.getElementById('livePreviewContent');
      const normalized = normalizeApiResponse(data, text);

      if (normalized.categories.length === 0) {
        previewContent.innerHTML = `
          <div class="live-safe">
            <span class="live-safe-icon">‚úì</span>
            <span class="live-safe-text">Keine Risiken erkannt</span>
          </div>
        `;
      } else {
        const riskCount = normalized.categories.length;
        const highestSeverity = normalized.categories.reduce((highest, cat) => {
          const order = { critical: 4, high: 3, medium: 2, low: 1 };
          return order[cat.severity] > order[highest] ? cat.severity : highest;
        }, 'low');

        previewContent.innerHTML = `
          <div class="live-warning ${highestSeverity}">
            <span class="live-warning-icon">‚ö†Ô∏è</span>
            <span class="live-warning-text">${riskCount} ${riskCount === 1 ? 'Risiko' : 'Risiken'} erkannt</span>
            <div class="live-categories">
              ${normalized.categories.slice(0, 3).map(cat => {
                const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
                return `<span class="live-category ${cat.severity}">${meta.icon}</span>`;
              }).join('')}
              ${riskCount > 3 ? `<span class="live-more">+${riskCount - 3}</span>` : ''}
            </div>
          </div>
        `;
      }
    }

    // Load saved accessibility preferences
    function loadAccessibilityPreferences() {
      // Font size
      const savedFontSize = localStorage.getItem('achtung-fontSize');
      if (savedFontSize !== null) {
        currentFontSize = parseInt(savedFontSize);
        changeFontSize(0); // Apply without changing
        currentFontSize = parseInt(savedFontSize); // Restore
        const fontSizeMap = { '-2': 12, '-1': 14, '0': 16, '1': 18, '2': 22 };
        document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';
      }

      // High contrast
      if (localStorage.getItem('achtung-highContrast') === 'true') {
        toggleHighContrast();
      }

      // Simple language
      if (localStorage.getItem('achtung-simpleLanguage') === 'true') {
        toggleSimpleLanguage();
      }

      // Real-time (don't auto-enable on page load for performance)
    }

    // ========================================
    // Screen Reader Announcements
    // ========================================

    function announceToScreenReader(message) {
      const announcer = document.createElement('div');
      announcer.setAttribute('role', 'status');
      announcer.setAttribute('aria-live', 'polite');
      announcer.setAttribute('aria-atomic', 'true');
      announcer.className = 'sr-only';
      announcer.textContent = message;
      document.body.appendChild(announcer);
      setTimeout(() => announcer.remove(), 1000);
    }

    // Authentifizierung pr√ºfen und Seite initialisieren
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize Phase 2 features
      initTabs();
      initBatchAnalysis();
      checkApiHealth();

      // Initialize Phase 3 accessibility features
      loadAccessibilityPreferences();

      // Check health every 60 seconds
      setInterval(checkApiHealth, 60000);

      if (typeof achtungAuth !== 'undefined') {
        if (achtungAuth.isAuthenticated()) {
          document.querySelectorAll('.protected-content').forEach(el => {
            el.style.display = 'block';
          });
          document.querySelectorAll('.auth-required').forEach(el => {
            el.style.display = 'none';
          });
          document.getElementById('logoutBtn').style.display = 'block';
        } else {
          achtungAuth.protectPage();
        }
      }
    });
  </script>
</body>
</html>
