<!DOCTYPE html>
<html lang="de">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <meta name="description" content="Demo | achtung.live ‚Äì Teste den Airbag f√ºr digitale Kommunikation">
 <meta name="robots" content="index,follow">
 <meta name="theme-color" content="#800000">
 <meta name="apple-mobile-web-app-capable" content="yes">
 <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
 <meta name="apple-mobile-web-app-title" content="achtung.live">
 <link rel="stylesheet" href="style.css">
 <link rel="icon" type="image/x-icon" href="favicon.ico">
 <link rel="manifest" href="manifest.json">
 <link rel="apple-touch-icon" href="icons/icon-192.png">
 <title>Demo | achtung.live</title>
</head>
<body>
 <!-- PWA Install Prompt (hidden by default) -->
 <div id="pwaInstallPrompt" class="pwa-install-prompt" style="display:none;">
 <span class="pwa-text" data-i18n="pwa.installHint">App installieren f√ºr Offline-Nutzung</span>
 <button class="pwa-install-btn" onclick="installPWA()">Installieren</button>
 <button class="pwa-close-btn" onclick="dismissPWAPrompt()">&times;</button>
 </div>

 <!-- Offline Indicator -->
 <div id="offlineIndicator" class="offline-indicator" style="display:none;">
 <span class="offline-text">Offline - Eingeschr√§nkte Funktionen</span>
 </div>

 <!-- Accessibility Toolbar -->
 <div class="accessibility-toolbar" role="toolbar" aria-label="Barrierefreiheit-Einstellungen">
 <div class="a11y-group">
 <span class="a11y-label" data-i18n="a11y.font">Schrift:</span>
 <button class="a11y-btn" onclick="changeFontSize(-1)" aria-label="Schrift verkleinern" title="Kleinere Schrift">A-</button>
 <button class="a11y-btn" onclick="changeFontSize(0)" aria-label="Standard Schriftgr√∂√üe" title="Standard">A</button>
 <button class="a11y-btn" onclick="changeFontSize(1)" aria-label="Schrift vergr√∂√üern" title="Gr√∂√üere Schrift">A+</button>
 </div>
 <div class="a11y-group">
 <button class="a11y-btn" id="contrastToggle" onclick="toggleHighContrast()" aria-label="Hoher Kontrast umschalten" title="Hoher Kontrast">
 <span class="a11y-icon">‚óê</span>
 <span class="a11y-text" data-i18n="a11y.contrast">Kontrast</span>
 </button>
 </div>
 <div class="a11y-group">
 <button class="a11y-btn" id="simpleLangToggle" onclick="toggleSimpleLanguage()" aria-label="Einfache Sprache umschalten" title="Einfache Sprache f√ºr besseres Verst√§ndnis">
 <span class="a11y-text" data-i18n="a11y.simpleLang">Einfache Sprache</span>
 </button>
 </div>
 <div class="a11y-group">
 <button class="a11y-btn" id="realtimeToggle" onclick="toggleRealtime()" aria-label="Live-Pr√ºfung umschalten" title="Text wird w√§hrend des Tippens gepr√ºft">
 <span class="a11y-text" data-i18n="a11y.liveCheck">Live-Pr√ºfung</span>
 </button>
 </div>
 <!-- Language Switcher -->
 <div class="a11y-group lang-switcher">
 <button class="a11y-btn lang-btn active" data-lang="de" onclick="switchLanguage('de')" title="Deutsch">
 <span class="lang-flag"></span>
 <span class="lang-code">DE</span>
 </button>
 <button class="a11y-btn lang-btn" data-lang="en" onclick="switchLanguage('en')" title="English">
 <span class="lang-flag"></span>
 <span class="lang-code">EN</span>
 </button>
 <button class="a11y-btn lang-btn" data-lang="fr" onclick="switchLanguage('fr')" title="Fran√ßais">
 <span class="lang-flag"></span>
 <span class="lang-code">FR</span>
 </button>
 <button class="a11y-btn lang-btn" data-lang="es" onclick="switchLanguage('es')" title="Espa√±ol">
 <span class="lang-flag"></span>
 <span class="lang-code">ES</span>
 </button>
 <button class="a11y-btn lang-btn" data-lang="it" onclick="switchLanguage('it')" title="Italiano">
 <span class="lang-flag"></span>
 <span class="lang-code">IT</span>
 </button>
 </div>
 </div>

 <!-- Logout Button (nur sichtbar wenn eingeloggt) -->
 <button id="logoutBtn" class="logout-button" style="display:none;" onclick="achtungAuth.logout()" aria-label="Abmelden">Abmelden</button>

 <header role="banner">
 <h1><span class="achtung-logo">[achtung.live]</span></h1>
 <p class="claim" id="mainClaim" data-i18n="header.tagline">Der Airbag f√ºr digitale Kommunikation</p>
 <!-- Simple language version (hidden by default) -->
 <p class="claim simple-lang" id="mainClaimSimple" data-i18n="header.taglineSimple" style="display:none;">Wir helfen dir, keine privaten Daten zu teilen.</p>
 </header>


 <!-- Gesch√ºtzter Inhalt -->
 <main class="main-content protected-content" role="main">
 <!-- API Status Indicator -->
 <!-- API Status hidden from public users -->
<div id="apiStatus" class="api-status" role="status" aria-live="polite" style="display:none;"></div>

 <!-- Live Check Indicator -->
 <div id="liveCheckIndicator" class="live-check-indicator" style="display:none;" role="status" aria-live="polite">
 <span class="live-dot"></span>
 <span class="live-text">Live-Pr√ºfung aktiv</span>
 </div>

 <!-- Tab Navigation -->
 <div class="tab-nav" role="tablist" aria-label="Analyse-Modus w√§hlen">
 <button class="tab-btn active" data-tab="single" role="tab" aria-selected="true" aria-controls="singleTab" data-i18n="tabs.single">Einzeltext</button>
 <button class="tab-btn" data-tab="batch" role="tab" aria-selected="false" aria-controls="batchTab" data-i18n="tabs.batch">Batch-Analyse</button>
 <button class="tab-btn" data-tab="document" role="tab" aria-selected="false" aria-controls="documentTab" data-i18n="tabs.document">Dokument</button>
 <button class="tab-btn" data-tab="predictive" role="tab" aria-selected="false" aria-controls="predictiveTab" data-i18n="tabs.predictive"> Predictive</button>
 <button class="tab-btn" data-tab="footprint" role="tab" aria-selected="false" aria-controls="footprintTab" data-i18n="tabs.footprint"> Footprint</button>
 <button class="tab-btn" data-tab="coach" role="tab" aria-selected="false" aria-controls="coachTab" data-i18n="tabs.coach"> Coach</button>
 <button class="tab-btn" data-tab="policy" role="tab" aria-selected="false" aria-controls="policyTab" data-i18n="tabs.policy"> Policy</button>
 <button class="tab-btn" data-tab="alerts" role="tab" aria-selected="false" aria-controls="alertsTab" data-i18n="tabs.alerts"> Alerts</button>
 <button class="tab-btn" data-tab="templates" role="tab" aria-selected="false" aria-controls="templatesTab" data-i18n="tabs.templates"> Templates</button>
 </div>

 <!-- Single Text Tab -->
 <div id="singleTab" class="tab-content active" role="tabpanel" aria-labelledby="single-tab">
 <h2 id="formTitle" data-i18n="form.title">Jetzt live testen!</h2>
 <p class="simple-lang form-description" id="formDescSimple" style="display:none;">
 Schreibe deinen Text unten. Wir sagen dir, ob private Daten drin sind.
 </p>
 <form id="demoForm" aria-describedby="formTitle">
 <label for="demoText" class="sr-only">Dein Text zur Pr√ºfung</label>
 <textarea id="demoText" placeholder="Schreibe hier deinen Text und lass ihn direkt √ºberpr√ºfen..." rows="6" required aria-label="Text eingeben zur Datenschutz-Pr√ºfung"></textarea>

 <!-- Live Preview (for real-time checking) -->
 <div id="livePreview" class="live-preview" style="display:none;" role="status" aria-live="polite">
 <div class="live-preview-header">
 <span class="live-preview-title">Live-Vorschau</span>
 </div>
 <div id="livePreviewContent" class="live-preview-content"></div>
 </div>

 <!-- Kontext-Auswahl -->
 <div class="context-selector">
 <label for="contextSelect" data-i18n="form.contextLabel">Wo soll dieser Text verwendet werden?</label>
 <select id="contextSelect" aria-describedby="contextHelp">
 <option value="private" data-i18n="form.contexts.private">Privater Chat (1:1)</option>
 <option value="whatsapp" data-i18n="form.contexts.whatsapp">WhatsApp Gruppe</option>
 <option value="email" data-i18n="form.contexts.email">E-Mail</option>
 <option value="linkedin" data-i18n="form.contexts.linkedin">LinkedIn / Beruflich</option>
 <option value="public" data-i18n="form.contexts.public">√ñffentlicher Post (Social Media)</option>
 </select>
 <span id="contextHelp" class="simple-lang context-help" style="display:none;">
 W√§hle aus, wo du den Text posten m√∂chtest. Das hilft uns, besser zu pr√ºfen.
 </span>
 </div>

 <div class="datenschutz-hinweis">
 <input type="checkbox" id="privacyPolicyDemo" required aria-describedby="privacyHelp">
 <label for="privacyPolicyDemo"><span data-i18n="form.privacyAccept">Ich akzeptiere die</span> <a href="#" onclick="openModal('datenschutzModal'); return false;" data-i18n="form.privacyPolicy">Datenschutzerkl√§rung</a>.</label>
 <span id="privacyHelp" class="simple-lang" style="display:none;">Du musst das ankreuzen, damit wir deinen Text pr√ºfen d√ºrfen.</span>
 </div>
 <div class="form-buttons">
<button type="submit" aria-label="Text auf sensible Daten pr√ºfen" data-i18n="form.submit">Text analysieren</button>
<button type="button" class="spell-check-btn" onclick="checkSpelling()" data-i18n="form.spellCheck">Rechtschreibung pruefen</button>
</div>
<div id="spellCheckResults" class="spell-check-results" style="display:none;"></div>
 </form>

 <!-- Risk Dashboard -->
 <div id="riskDashboard" style="display:none;" role="region" aria-label="Analyse-Ergebnisse"></div>
 </div>

 <!-- Batch Analysis Tab -->
 <div id="batchTab" class="tab-content" role="tabpanel" aria-labelledby="batch-tab">
 <h2 data-i18n="batch.title">Batch-Analyse</h2>
 <p class="batch-description" data-i18n="batch.description">Analysiere mehrere Texte gleichzeitig (max. 20 Texte)</p>
 <p class="simple-lang batch-description-simple" style="display:none;">Pr√ºfe viele Texte auf einmal. Maximal 20 St√ºck.</p>

 <form id="batchForm">
 <div class="batch-input-area">
 <div class="batch-textarea-container">
 <textarea id="batchTexts" placeholder="F√ºge mehrere Texte ein, getrennt durch eine Leerzeile (2x Enter)..." rows="8"></textarea>
 <div class="batch-counter">
 <span id="textCount">0</span> / 20 Texte
 </div>
 </div>

 <div class="batch-divider">
 <span>oder</span>
 </div>

 <div class="batch-upload-area" id="dropZone">
 <div class="upload-icon"></div>
 <div class="upload-text">Datei hierher ziehen</div>
 <div class="upload-subtext">oder klicken zum Ausw√§hlen (.txt, .csv)</div>
 <input type="file" id="batchFile" accept=".txt,.csv" hidden>
 </div>
 </div>

 <div class="datenschutz-hinweis">
 <input type="checkbox" id="privacyPolicyBatch" required>
 <label for="privacyPolicyBatch"><span data-i18n="form.privacyAccept">Ich akzeptiere die</span> <a href="#" onclick="openModal('datenschutzModal'); return false;" data-i18n="form.privacyPolicy">Datenschutzerkl√§rung</a>.</label>
 </div>

 <button type="submit" id="batchSubmitBtn">
 <span class="btn-text">Alle Texte analysieren</span>
 <span class="btn-loading" style="display:none;">Analysiere...</span>
 </button>
 </form>

 <!-- Batch Results -->
 <div id="batchResults" style="display:none;"></div>
 </div>

 <!-- Document Analysis Tab -->
 <div id="documentTab" class="tab-content" role="tabpanel" aria-labelledby="document-tab">
 <h2 data-i18n="document.title">Dokument-Analyse</h2>
 <p class="doc-description" data-i18n="document.description">Lade ein Bild oder PDF hoch zur Analyse</p>
 <p class="simple-lang doc-description-simple" style="display:none;" data-i18n="document.descriptionSimple">Lade ein Foto oder PDF hoch. Wir pr√ºfen den Text darin.</p>

 <form id="documentForm">
 <div class="document-upload-area" id="docDropZone">
 <div class="upload-icon"></div>
 <div class="upload-text" data-i18n="document.dropzone">Bild oder PDF hierher ziehen</div>
 <div class="upload-subtext" data-i18n="document.dropzoneHint">oder klicken zum Ausw√§hlen (PNG, JPG, PDF)</div>
 <div class="upload-maxsize" data-i18n="document.maxSize">Maximal 10 MB f√ºr Bilder, 25 MB f√ºr PDFs</div>
 <input type="file" id="documentFile" accept="image/png,image/jpeg,image/webp,application/pdf" hidden>
 </div>

 <!-- Document Preview -->
 <div id="documentPreview" class="document-preview" style="display:none;">
 <div class="doc-preview-header">
 <span class="doc-preview-name" id="docFileName"></span>
 <span class="doc-preview-size" id="docFileSize"></span>
 <button type="button" class="doc-remove-btn" onclick="removeDocument()">&times;</button>
 </div>
 <div class="doc-preview-content">
 <img id="docPreviewImage" class="doc-preview-img" style="display:none;" alt="Dokument-Vorschau">
 <div id="docPreviewPdf" class="doc-preview-pdf" style="display:none;">
 <span class="pdf-text">PDF-Dokument</span>
 </div>
 </div>
 </div>

 <!-- OCR Options -->
 <div class="ocr-options" id="ocrOptions" style="display:none;">
 <label class="ocr-option">
 <input type="checkbox" id="enableOcr" checked>
 <span>Text erkennen (OCR)</span>
 </label>
 <label class="ocr-option">
 <input type="checkbox" id="enableSentiment">
 <span>Stimmungsanalyse</span>
 </label>
 </div>

 <div class="datenschutz-hinweis">
 <input type="checkbox" id="privacyPolicyDoc" required>
 <label for="privacyPolicyDoc"><span data-i18n="form.privacyAccept">Ich akzeptiere die</span> <a href="#" onclick="openModal('datenschutzModal'); return false;" data-i18n="form.privacyPolicy">Datenschutzerkl√§rung</a>.</label>
 </div>

 <button type="submit" id="docSubmitBtn" disabled>
 <span class="btn-text" data-i18n="form.submit">Dokument analysieren</span>
 <span class="btn-loading" style="display:none;" data-i18n="document.analyzing">Analysiere...</span>
 </button>
 </form>

 <!-- Document Results -->
 <div id="documentResults" style="display:none;">
 <div class="doc-results-container">
 <!-- Extracted Text Section -->
 <div class="doc-extracted-text" id="extractedTextSection" style="display:none;">
 <div class="extracted-header">
 <span class="extracted-title" data-i18n="document.extractedText">Erkannter Text</span>
 <span class="extracted-confidence" id="ocrConfidence"></span>
 </div>
 <div class="extracted-content" id="extractedText"></div>
 </div>

 <!-- Sentiment Section -->
 <div class="doc-sentiment" id="sentimentSection" style="display:none;">
 <div class="sentiment-header" data-i18n="document.sentiment">Stimmung</div>
 <div class="sentiment-result" id="sentimentResult"></div>
 </div>

 <!-- Risk Dashboard for Document -->
 <div id="docRiskDashboard"></div>
 </div>
 </div>
 </div>

 <!-- Predictive Privacy Tab (Phase 5) -->
 <div id="predictiveTab" class="tab-content" role="tabpanel" aria-labelledby="predictive-tab">
 <h2 data-i18n="predictive.title"> Predictive Privacy</h2>
 <p class="predictive-description" data-i18n="predictive.description">Analysiere zuk√ºnftige Risiken deiner Daten</p>
 <p class="simple-lang predictive-description-simple" style="display:none;" data-i18n="predictive.descriptionSimple">Wir zeigen dir, was in der Zukunft mit deinen Daten passieren k√∂nnte.</p>

 <form id="predictiveForm">
 <label for="predictiveText" class="sr-only">Text f√ºr Predictive Privacy Analyse</label>
 <textarea id="predictiveText" placeholder="Schreibe hier deinen Text... Wir zeigen dir, wie identifizierbar du bist und was in Zukunft passieren k√∂nnte." rows="6" required></textarea>

 <!-- Analysis Options -->
 <div class="predictive-options">
 <label class="predictive-option">
 <input type="checkbox" id="optDeanon" checked>
 <span class="option-text" data-i18n="predictive.optDeanon">Deanonymisierungs-Risiko</span>
 </label>
 <label class="predictive-option">
 <input type="checkbox" id="optBreach" checked>
 <span class="option-text" data-i18n="predictive.optBreach">Breach-Simulation</span>
 </label>
 <label class="predictive-option">
 <input type="checkbox" id="optFuture" checked>
 <span class="option-icon">‚è≥</span>
 <span class="option-text" data-i18n="predictive.optFuture">Zukunfts-Risiko</span>
 </label>
 <label class="predictive-option">
 <input type="checkbox" id="optCorrelation" checked>
 <span class="option-text" data-i18n="predictive.optCorrelation">Korrelations-Angriffe</span>
 </label>
 </div>

 <!-- Time Horizon Selector -->
 <div class="time-horizon-selector">
 <label data-i18n="predictive.timeHorizon">Zeithorizont:</label>
 <div class="time-horizon-buttons">
 <button type="button" class="time-btn active" data-years="1">1 Jahr</button>
 <button type="button" class="time-btn" data-years="5">5 Jahre</button>
 <button type="button" class="time-btn" data-years="10">10 Jahre</button>
 </div>
 </div>

 <div class="datenschutz-hinweis">
 <input type="checkbox" id="privacyPolicyPredictive" required>
 <label for="privacyPolicyPredictive"><span data-i18n="form.privacyAccept">Ich akzeptiere die</span> <a href="#" onclick="openModal('datenschutzModal'); return false;" data-i18n="form.privacyPolicy">Datenschutzerkl√§rung</a>.</label>
 </div>

 <button type="submit" id="predictiveSubmitBtn">
 <span class="btn-text" data-i18n="predictive.analyze"> Zukunft analysieren</span>
 <span class="btn-loading" style="display:none;">Analysiere...</span>
 </button>
 </form>

 <!-- Predictive Results -->
 <div id="predictiveResults" style="display:none;">

 <!-- Summary Card -->
 <div class="predictive-summary-card" id="predictiveSummary">
 <div class="summary-header">
 <span class="summary-title" data-i18n="predictive.summaryTitle">Zusammenfassung</span>
 </div>
 <div class="summary-content">
 <div class="summary-risk-badge" id="summaryRiskBadge"></div>
 <div class="summary-text" id="summaryText"></div>
 <div class="summary-quickfix" id="summaryQuickFix"></div>
 </div>
 </div>

 <!-- Deanonymization Risk Section -->
 <div class="predictive-section" id="deanonSection">
 <div class="section-header">
 <h3 data-i18n="predictive.deanonTitle">Deanonymisierungs-Risiko</h3>
 </div>
 <div class="deanon-content">
 <!-- k-Anonymity Gauge -->
 <div class="k-anonymity-gauge">
 <div class="gauge-circle" id="kAnonGauge">
 <svg viewBox="0 0 100 100">
 <circle cx="50" cy="50" r="45" class="gauge-bg"/>
 <circle cx="50" cy="50" r="45" class="gauge-fill" id="kAnonFill"/>
 </svg>
 <div class="gauge-value">
 <span class="gauge-k" id="kAnonValue">k=?</span>
 <span class="gauge-label" data-i18n="predictive.anonymity">Anonymit√§t</span>
 </div>
 </div>
 <div class="gauge-explanation" id="kAnonExplanation"></div>
 </div>

 <!-- Unique Data Points -->
 <div class="unique-datapoints" id="uniqueDatapoints">
 <h4 data-i18n="predictive.datapoints">Gefundene Datenpunkte</h4>
 <div class="datapoints-list" id="datapointsList"></div>
 </div>

 <!-- Combined Risk -->
 <div class="combined-risk" id="combinedRisk">
 <div class="combined-risk-header">
 <span class="combined-risk-score" id="combinedRiskScore"></span>
 <span class="combined-risk-label" data-i18n="predictive.combinedRisk">Kombiniertes Risiko</span>
 </div>
 <div class="combined-risk-explanation" id="combinedRiskExplanation"></div>
 <div class="combined-risk-recommendation" id="combinedRiskRecommendation"></div>
 </div>
 </div>
 </div>

 <!-- Breach Simulation Section -->
 <div class="predictive-section" id="breachSection">
 <div class="section-header">
 <h3 data-i18n="predictive.breachTitle">Breach-Simulation</h3>
 </div>
 <div class="breach-content">
 <div class="breach-scenarios" id="breachScenarios"></div>
 <div class="breach-overall" id="breachOverall">
 <div class="breach-overall-score" id="breachOverallScore"></div>
 <div class="breach-worst-case" id="breachWorstCase"></div>
 </div>
 </div>
 </div>

 <!-- Future Risk Timeline Section -->
 <div class="predictive-section" id="futureSection">
 <div class="section-header">
 <span class="section-icon">‚è≥</span>
 <h3 data-i18n="predictive.futureTitle">Zukunfts-Risiko</h3>
 </div>
 <div class="future-content">
 <!-- Interactive Timeline -->
 <div class="future-timeline" id="futureTimeline">
 <div class="timeline-track">
 <div class="timeline-point now" data-year="0">
 <span class="timeline-label">Jetzt</span>
 <span class="timeline-score" id="scoreNow"></span>
 </div>
 <div class="timeline-point" data-year="1">
 <span class="timeline-label">1 Jahr</span>
 <span class="timeline-score" id="score1y"></span>
 </div>
 <div class="timeline-point" data-year="5">
 <span class="timeline-label">5 Jahre</span>
 <span class="timeline-score" id="score5y"></span>
 </div>
 <div class="timeline-point" data-year="10">
 <span class="timeline-label">10 Jahre</span>
 <span class="timeline-score" id="score10y"></span>
 </div>
 </div>
 </div>

 <!-- Future Threats -->
 <div class="future-threats" id="futureThreats"></div>

 <!-- Permanent Risks -->
 <div class="permanent-risks" id="permanentRisks">
 <h4 data-i18n="predictive.permanentRisks"> Dauerhafte Risiken</h4>
 <div class="permanent-risks-list" id="permanentRisksList"></div>
 </div>
 </div>
 </div>

 <!-- Correlation Attack Section -->
 <div class="predictive-section" id="correlationSection">
 <div class="section-header">
 <h3 data-i18n="predictive.correlationTitle">Korrelations-Angriffe</h3>
 </div>
 <div class="correlation-content">
 <div class="correlation-methods" id="correlationMethods"></div>
 <div class="attack-surface" id="attackSurface">
 <div class="attack-surface-score" id="attackSurfaceScore"></div>
 <div class="attack-surface-weakest" id="attackSurfaceWeakest"></div>
 <div class="attack-surface-recommendation" id="attackSurfaceRecommendation"></div>
 </div>
 </div>
 </div>

 <!-- Privacy Lifespan -->
 <div class="privacy-lifespan" id="privacyLifespan">
 <span class="lifespan-text" id="lifespanText"></span>
 </div>

 </div>
 </div>

 <!-- Digital Footprint Scanner Tab (Phase 7) -->
 <div id="footprintTab" class="tab-content" role="tabpanel" aria-labelledby="footprint-tab">
 <h2 data-i18n="footprint.title"> Digital Footprint Scanner</h2>
 <p class="footprint-description" data-i18n="footprint.description">Finde heraus, wo deine Daten im Internet auftauchen</p>
 <p class="simple-lang footprint-description-simple" style="display:none;" data-i18n="footprint.descriptionSimple">Wir suchen nach deinen Daten im Internet und zeigen dir, wo sie sind.</p>

 <form id="footprintForm">
 <!-- Scan Type Selector -->
 <div class="footprint-scan-type">
 <label data-i18n="footprint.scanType">Scan-Typ:</label>
 <div class="scan-type-buttons">
 <button type="button" class="scan-type-btn active" data-type="quick">
 <span class="scan-type-text">Quick-Scan</span>
 </button>
 <button type="button" class="scan-type-btn" data-type="full">
 <span class="scan-type-text">Full-Scan</span>
 </button>
 </div>
 </div>

 <!-- Input Fields -->
 <div class="footprint-inputs">
 <div class="footprint-input-group">
 <label for="footprintEmail">
 <span data-i18n="footprint.email">E-Mail-Adresse</span>
 <span class="required">*</span>
 </label>
 <input type="email" id="footprintEmail" placeholder="deine@email.de" required>
 </div>

 <div class="footprint-input-group">
 <label for="footprintName">
 <span data-i18n="footprint.name">Name (optional)</span>
 </label>
 <input type="text" id="footprintName" placeholder="Max Mustermann">
 </div>

 <div class="footprint-input-group">
 <label for="footprintUsername">
 <span class="input-icon">@</span>
 <span data-i18n="footprint.username">Username (optional)</span>
 </label>
 <input type="text" id="footprintUsername" placeholder="maxmuster">
 </div>

 <div class="footprint-input-group collapsible" id="advancedInputs" style="display:none;">
 <label for="footprintPhone">
 <span data-i18n="footprint.phone">Telefon (optional)</span>
 </label>
 <input type="tel" id="footprintPhone" placeholder="+49 123 456789">
 </div>
 </div>

 <button type="button" class="toggle-advanced-btn" onclick="toggleAdvancedInputs()">
 <span class="toggle-icon">‚ñº</span>
 <span data-i18n="footprint.moreOptions">Weitere Optionen</span>
 </button>

 <!-- Scan Options -->
 <div class="footprint-options">
 <label class="footprint-option">
 <input type="checkbox" id="optBreaches" checked>
 <span class="option-text" data-i18n="footprint.optBreaches">Datenlecks pr√ºfen</span>
 </label>
 <label class="footprint-option">
 <input type="checkbox" id="optSocial" checked>
 <span class="option-text" data-i18n="footprint.optSocial">Social Media scannen</span>
 </label>
 <label class="footprint-option">
 <input type="checkbox" id="optDatabrokers" checked>
 <span class="option-text" data-i18n="footprint.optDatabrokers">Data Broker pr√ºfen</span>
 </label>
 <label class="footprint-option">
 <input type="checkbox" id="optDarkweb">
 <span class="option-text" data-i18n="footprint.optDarkweb">Dark Web (Premium)</span>
 </label>
 </div>

 <div class="datenschutz-hinweis">
 <input type="checkbox" id="privacyPolicyFootprint" required>
 <label for="privacyPolicyFootprint"><span data-i18n="form.privacyAccept">Ich akzeptiere die</span> <a href="#" onclick="openModal('datenschutzModal'); return false;" data-i18n="form.privacyPolicy">Datenschutzerkl√§rung</a>.</label>
 </div>

 <button type="submit" id="footprintSubmitBtn">
 <span class="btn-text" data-i18n="footprint.scan"> Footprint scannen</span>
 <span class="btn-loading" style="display:none;">Scanne...</span>
 </button>
 </form>

 <!-- Footprint Results -->
 <div id="footprintResults" style="display:none;">

 <!-- Summary Card -->
 <div class="footprint-summary-card" id="footprintSummary">
 <div class="summary-header">
 <span class="summary-title" data-i18n="footprint.summaryTitle">Dein digitaler Fu√üabdruck</span>
 </div>
 <div class="summary-content">
 <div class="footprint-risk-circle" id="footprintRiskCircle">
 <svg viewBox="0 0 100 100">
 <circle cx="50" cy="50" r="45" class="risk-bg"/>
 <circle cx="50" cy="50" r="45" class="risk-fill" id="footprintRiskFill"/>
 </svg>
 <div class="risk-value">
 <span class="risk-score" id="footprintRiskScore">--</span>
 <span class="risk-label">Risiko</span>
 </div>
 </div>
 <div class="summary-stats">
 <div class="stat-item">
 <span class="stat-value" id="statExposures">0</span>
 <span class="stat-label" data-i18n="footprint.exposures">Fundstellen</span>
 </div>
 <div class="stat-item critical">
 <span class="stat-value" id="statCritical">0</span>
 <span class="stat-label" data-i18n="footprint.critical">Kritisch</span>
 </div>
 <div class="stat-item">
 <span class="stat-value" id="statActions">0</span>
 <span class="stat-label" data-i18n="footprint.actions">Aktionen n√∂tig</span>
 </div>
 </div>
 </div>
 </div>

 <!-- Breach Results Section -->
 <div class="footprint-section" id="breachResultsSection" style="display:none;">
 <div class="section-header collapsible" onclick="toggleSection('breachResultsContent')">
 <h3 data-i18n="footprint.breachesTitle">Datenlecks</h3>
 <span class="section-count" id="breachCount">0</span>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="breachResultsContent">
 <div class="breach-list" id="breachList"></div>
 </div>
 </div>

 <!-- Social Media Section -->
 <div class="footprint-section" id="socialResultsSection" style="display:none;">
 <div class="section-header collapsible" onclick="toggleSection('socialResultsContent')">
 <h3 data-i18n="footprint.socialTitle">Social Media Profile</h3>
 <span class="section-count" id="socialCount">0</span>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="socialResultsContent">
 <div class="social-profiles-list" id="socialProfilesList"></div>
 </div>
 </div>

 <!-- Data Brokers Section -->
 <div class="footprint-section" id="databrokerResultsSection" style="display:none;">
 <div class="section-header collapsible" onclick="toggleSection('databrokerResultsContent')">
 <h3 data-i18n="footprint.databrokersTitle">Data Broker</h3>
 <span class="section-count" id="databrokerCount">0</span>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="databrokerResultsContent">
 <div class="databroker-list" id="databrokerList"></div>
 <div class="databroker-summary" id="databrokerSummary">
 <div class="optout-progress">
 <span class="progress-label" data-i18n="footprint.optoutProgress">Opt-out Fortschritt:</span>
 <div class="progress-bar">
 <div class="progress-fill" id="optoutProgressFill"></div>
 </div>
 <span class="progress-value" id="optoutProgressValue">0%</span>
 </div>
 <button type="button" class="bulk-optout-btn" id="bulkOptoutBtn" onclick="startBulkOptout()">
 <span data-i18n="footprint.bulkOptout">Alle Opt-outs starten</span>
 </button>
 </div>
 </div>
 </div>

 <!-- Recommendations Section -->
 <div class="footprint-section" id="recommendationsSection">
 <div class="section-header">
 <h3 data-i18n="footprint.recommendationsTitle">Empfehlungen</h3>
 </div>
 <div class="section-content">
 <div class="recommendations-list" id="recommendationsList"></div>
 </div>
 </div>

 <!-- Monitoring CTA -->
 <div class="monitoring-cta" id="monitoringCta">
 <div class="cta-icon"></div>
 <div class="cta-content">
 <h4 data-i18n="footprint.monitoringTitle">Kontinuierliches Monitoring</h4>
 <p data-i18n="footprint.monitoringDesc">Werde sofort benachrichtigt, wenn deine Daten in neuen Leaks auftauchen.</p>
 </div>
 <button type="button" class="cta-btn" onclick="setupMonitoring()">
 <span data-i18n="footprint.enableMonitoring">Aktivieren</span>
 </button>
 </div>

 </div>
 </div>

 <!-- Smart Privacy Coach Tab (Phase 10) -->
 <div id="coachTab" class="tab-content" role="tabpanel" aria-labelledby="coach-tab">
 <h2 data-i18n="coach.title"> Smart Privacy Coach</h2>
 <p class="coach-description" data-i18n="coach.description">Dein pers√∂nlicher KI-Assistent f√ºr Datenschutz-Fragen</p>

 <div class="coach-container">
 <!-- Chat Interface -->
 <div class="coach-chat-container">
 <div class="coach-chat-header">
 <div class="coach-avatar"></div>
 <div class="coach-info">
 <span class="coach-name">Privacy Coach</span>
 <span class="coach-status online">Online</span>
 </div>
 <button class="coach-menu-btn" onclick="toggleCoachMenu()" title="Men√º">‚ãÆ</button>
 </div>

 <div class="coach-chat-messages" id="coachMessages">
 <!-- Welcome message will be inserted here -->
 </div>

 <div class="coach-suggestions" id="coachSuggestions">
 <!-- Quick suggestions will be inserted here -->
 </div>

 <form class="coach-input-form" id="coachInputForm">
 <div class="coach-input-container">
 <button type="button" class="coach-attach-btn" onclick="attachTextForAnalysis()" title="Text zur Analyse anh√§ngen"></button>
 <input type="text" id="coachInput" placeholder="Stelle eine Frage zum Datenschutz..." autocomplete="off">
 <button type="submit" class="coach-send-btn" title="Senden">
 </button>
 </div>
 </form>
 </div>

 <!-- Sidebar with Topics -->
 <div class="coach-sidebar">
 <div class="coach-sidebar-section">
 <h4 data-i18n="coach.quickActions">Schnellaktionen</h4>
 <div class="coach-quick-actions">
 <button class="quick-action-btn" onclick="askCoach('Was sind personenbezogene Daten?')">
 <span>Grundlagen lernen</span>
 </button>
 <button class="quick-action-btn" onclick="askCoach('Erkl√§re mir k-Anonymit√§t einfach')">
 <span>k-Anonymit√§t</span>
 </button>
 <button class="quick-action-btn" onclick="askCoach('Wie erkenne ich Phishing?')">
 <span>Phishing erkennen</span>
 </button>
 <button class="quick-action-btn" onclick="askCoach('Welche Daten sollte ich nie teilen?')">
 <span>Risiko-Daten</span>
 </button>
 </div>
 </div>

 <div class="coach-sidebar-section">
 <h4 data-i18n="coach.learnTopics">Lern-Themen</h4>
 <div class="coach-topics-list" id="coachTopicsList">
 <!-- Topics will be loaded dynamically -->
 </div>
 </div>

 <div class="coach-sidebar-section">
 <h4 data-i18n="coach.tipOfDay">Tipp des Tages</h4>
 <div class="coach-daily-tip" id="coachDailyTip">
 <div class="tip-icon"></div>
 <div class="tip-content">
 <p>Verwende f√ºr jeden Dienst ein einzigartiges Passwort. Ein Passwort-Manager hilft dabei!</p>
 </div>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Privacy Policy Analyzer Tab (Phase 13) -->
 <div id="policyTab" class="tab-content" role="tabpanel" aria-labelledby="policy-tab">
 <h2 data-i18n="policy.title"> Privacy Policy Analyzer</h2>
 <p class="policy-description" data-i18n="policy.description">Analysiere Datenschutzerkl√§rungen und AGBs - einfach verst√§ndlich</p>

 <div class="policy-container">
 <!-- Input Section -->
 <div class="policy-input-section">
 <div class="policy-input-tabs">
 <button type="button" class="policy-input-tab active" data-input="url" onclick="switchPolicyInput('url')">
 <span>URL eingeben</span>
 </button>
 <button type="button" class="policy-input-tab" data-input="text" onclick="switchPolicyInput('text')">
 <span>Text einf√ºgen</span>
 </button>
 <button type="button" class="policy-input-tab" data-input="known" onclick="switchPolicyInput('known')">
 <span>Bekannte Dienste</span>
 </button>
 </div>

 <!-- URL Input -->
 <div class="policy-input-content" id="policyUrlInput">
 <form id="policyUrlForm">
 <div class="url-input-group">
 <span class="url-prefix">https://</span>
 <input type="text" id="policyUrl" placeholder="example.com/privacy" autocomplete="off">
 <button type="submit" class="analyze-btn">
 <span class="btn-text">Analysieren</span>
 <span class="btn-loading" style="display:none;">...</span>
 </button>
 </div>
 <div class="popular-urls">
 <span>Beliebt:</span>
 <button type="button" onclick="setPolicyUrl('facebook.com/privacy')">Facebook</button>
 <button type="button" onclick="setPolicyUrl('google.com/privacy')">Google</button>
 <button type="button" onclick="setPolicyUrl('amazon.de/privacy')">Amazon</button>
 <button type="button" onclick="setPolicyUrl('tiktok.com/privacy')">TikTok</button>
 </div>
 </form>
 </div>

 <!-- Text Input -->
 <div class="policy-input-content" id="policyTextInput" style="display:none;">
 <form id="policyTextForm">
 <textarea id="policyText" placeholder="F√ºge hier die Datenschutzerkl√§rung ein..." rows="8"></textarea>
 <button type="submit" class="analyze-btn">
 <span class="btn-text">Text analysieren</span>
 <span class="btn-loading" style="display:none;">...</span>
 </button>
 </form>
 </div>

 <!-- Known Services -->
 <div class="policy-input-content" id="policyKnownInput" style="display:none;">
 <div class="known-services-grid" id="knownServicesGrid">
 <!-- Services will be loaded dynamically -->
 </div>
 </div>
 </div>

 <!-- Results Section -->
 <div class="policy-results" id="policyResults" style="display:none;">

 <!-- Score Card -->
 <div class="policy-score-card" id="policyScoreCard">
 <div class="score-circle">
 <svg viewBox="0 0 100 100">
 <circle cx="50" cy="50" r="45" class="score-bg"/>
 <circle cx="50" cy="50" r="45" class="score-fill" id="policyScoreFill"/>
 </svg>
 <div class="score-content">
 <span class="score-value" id="policyScoreValue">--</span>
 <span class="score-grade" id="policyScoreGrade">-</span>
 </div>
 </div>
 <div class="score-details">
 <h3 id="policyServiceName">Datenschutz-Bewertung</h3>
 <p class="score-label" id="policyScoreLabel">--</p>
 <p class="score-summary" id="policyScoreSummary"></p>
 </div>
 </div>

 <!-- TLDR Summary -->
 <div class="policy-tldr" id="policyTldr">
 <div class="tldr-header">
 <h4>Zusammenfassung (TL;DR)</h4>
 </div>
 <p id="policyTldrText"></p>
 </div>

 <!-- Key Points -->
 <div class="policy-section" id="policyKeyPoints">
 <div class="section-header">
 <h4>Wichtige Punkte</h4>
 </div>
 <div class="key-points-list" id="keyPointsList"></div>
 </div>

 <!-- Red Flags -->
 <div class="policy-section" id="policyRedFlags" style="display:none;">
 <div class="section-header warning">
 <h4>Warnsignale</h4>
 </div>
 <div class="red-flags-list" id="redFlagsList"></div>
 </div>

 <!-- Score Breakdown -->
 <div class="policy-section" id="policyBreakdown">
 <div class="section-header collapsible" onclick="togglePolicySection('breakdownContent')">
 <h4>Score-Aufschl√ºsselung</h4>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="breakdownContent">
 <div class="breakdown-grid" id="breakdownGrid"></div>
 </div>
 </div>

 <!-- Data Collection -->
 <div class="policy-section" id="policyDataCollection">
 <div class="section-header collapsible" onclick="togglePolicySection('dataCollectionContent')">
 <h4>Gesammelte Daten</h4>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="dataCollectionContent" style="display:none;">
 <div class="data-collection-list" id="dataCollectionList"></div>
 </div>
 </div>

 <!-- Third Parties -->
 <div class="policy-section" id="policyThirdParties">
 <div class="section-header collapsible" onclick="togglePolicySection('thirdPartiesContent')">
 <h4>Datenweitergabe</h4>
 <span class="section-count" id="thirdPartyCount">0</span>
 <span class="section-toggle">‚ñº</span>
 </div>
 <div class="section-content" id="thirdPartiesContent" style="display:none;">
 <div class="third-parties-list" id="thirdPartiesList"></div>
 </div>
 </div>

 <!-- Recommendations -->
 <div class="policy-section" id="policyRecommendations">
 <div class="section-header">
 <h4>Empfehlungen</h4>
 </div>
 <div class="recommendations-list" id="policyRecommendationsList"></div>
 </div>

 <!-- Compare CTA -->
 <div class="policy-compare-cta">
 <div class="cta-text">
 <strong>Bessere Alternativen?</strong>
 <span id="betterAlternativesText">Vergleiche mit datenschutzfreundlicheren Diensten</span>
 </div>
 <button type="button" class="cta-btn" onclick="showBetterAlternatives()">
 Vergleichen
 </button>
 </div>

 </div>
 </div>
 </div>

 <!-- Data Breach Alerts Tab (Phase 9) -->
 <div id="alertsTab" class="tab-content" role="tabpanel" aria-labelledby="alerts-tab">
 <h2 data-i18n="alerts.title"> Data Breach Alerts</h2>
 <p class="alerts-description" data-i18n="alerts.description">Werde benachrichtigt, wenn deine E-Mail in einem Datenleck auftaucht</p>

 <div class="alerts-container">
 <!-- Subscribe Section -->
 <div class="alerts-subscribe-section">
 <div class="subscribe-card">
 <div class="subscribe-icon"></div>
 <h3>Monitoring aktivieren</h3>
 <p>Erhalte sofortige Benachrichtigungen bei neuen Datenlecks</p>
 <form id="alertsSubscribeForm" class="subscribe-form">
 <div class="input-group">
 <input type="email" id="alertsEmail" placeholder="deine@email.de" required>
 <button type="submit" class="subscribe-btn">
 <span class="btn-text">√úberwachen</span>
 <span class="btn-loading" style="display:none;">...</span>
 </button>
 </div>
 <div class="subscribe-options">
 <label class="checkbox-label">
 <input type="checkbox" id="alertsInstant" checked>
 <span>Sofort-Benachrichtigung</span>
 </label>
 <label class="checkbox-label">
 <input type="checkbox" id="alertsWeekly">
 <span>W√∂chentliche Zusammenfassung</span>
 </label>
 </div>
 </form>
 <div id="alertsSubscribeResult" class="subscribe-result" style="display:none;"></div>
 </div>

 <!-- Status Check -->
 <div class="status-check-card">
 <h4>Status pr√ºfen</h4>
 <form id="alertsStatusForm" class="status-form">
 <input type="email" id="alertsStatusEmail" placeholder="E-Mail pr√ºfen...">
 <button type="submit" class="status-btn">Pr√ºfen</button>
 </form>
 <div id="alertsStatusResult" class="status-result" style="display:none;"></div>
 </div>
 </div>

 <!-- Recent Breaches Section -->
 <div class="recent-breaches-section">
 <div class="section-header">
 <h3> Aktuelle Datenlecks</h3>
 <span class="last-updated" id="breachesLastUpdated">L√§dt...</span>
 </div>
 <div class="breaches-stats">
 <div class="stat-item">
 <span class="stat-value" id="breachesThisMonth">--</span>
 <span class="stat-label">Lecks diesen Monat</span>
 </div>
 <div class="stat-item">
 <span class="stat-value" id="breachesAffectedUsers">--</span>
 <span class="stat-label">Betroffene Nutzer</span>
 </div>
 </div>
 <div class="breaches-list" id="recentBreachesList">
 <div class="loading-placeholder">Lade aktuelle Datenlecks...</div>
 </div>
 </div>

 <!-- How It Works -->
 <div class="alerts-how-it-works">
 <h4>So funktioniert's</h4>
 <div class="steps-grid">
 <div class="step-item">
 <span class="step-number">1</span>
 <span class="step-text">E-Mail registrieren</span>
 </div>
 <div class="step-item">
 <span class="step-number">2</span>
 <span class="step-text">Best√§tigen</span>
 </div>
 <div class="step-item">
 <span class="step-number">3</span>
 <span class="step-text">24/7 Monitoring</span>
 </div>
 <div class="step-item">
 <span class="step-number">4</span>
 <span class="step-text">Sofort-Alert</span>
 </div>
 </div>
 </div>
 </div>
 </div>

 <!-- Privacy Templates Tab (Phase 11) -->
 <div id="templatesTab" class="tab-content" role="tabpanel" aria-labelledby="templates-tab">
 <h2 data-i18n="templates.title"> Privacy Templates</h2>
 <p class="templates-description" data-i18n="templates.description">Sichere Textvorlagen f√ºr Social Media, Bewerbungen und mehr</p>

 <div class="templates-container">
 <!-- Search and Actions Bar -->
 <div class="templates-toolbar">
 <div class="search-container">
 <input type="text" id="templatesSearchInput" placeholder="Templates suchen..." autocomplete="off">
 <div id="templatesSearchResults" class="search-results-dropdown" style="display:none;"></div>
 </div>
 <button class="gdpr-generator-btn" onclick="openGdprGenerator()">
 <span>DSGVO-Generator</span>
 </button>
 </div>

 <!-- Categories -->
 <div class="templates-categories" id="templatesCategoriesGrid">
 <div class="loading-placeholder">Lade Kategorien...</div>
 </div>

 <!-- Templates Browser -->
 <div class="templates-browser" id="templatesBrowser" style="display:none;">
 <div class="browser-header">
 <button class="back-btn" onclick="showTemplateCategories()">‚Üê Zur√ºck</button>
 <h3 id="templatesCategoryTitle">Kategorie</h3>
 </div>
 <div class="templates-list" id="templatesList"></div>
 </div>

 <!-- Template Detail -->
 <div class="template-detail" id="templateDetail" style="display:none;">
 <div class="detail-header">
 <button class="back-btn" onclick="backToTemplatesList()">‚Üê Zur√ºck</button>
 <h3 id="templateDetailTitle">Template</h3>
 <div class="privacy-badge" id="templatePrivacyBadge">
 <span class="badge-score">--</span>
 <span class="badge-label">Privacy Score</span>
 </div>
 </div>

 <!-- Variants -->
 <div class="template-variants" id="templateVariants"></div>

 <!-- Customizer -->
 <div class="template-customizer" id="templateCustomizer" style="display:none;">
 <h4>Anpassen</h4>
 <div class="customizer-fields" id="customizerFields"></div>
 </div>

 <!-- Preview -->
 <div class="template-preview">
 <h4>Vorschau</h4>
 <div class="preview-content" id="templatePreviewContent"></div>
 <button class="copy-btn" onclick="copyTemplateToClipboard()">
 <span> Kopieren</span>
 </button>
 </div>

 <!-- Tips -->
 <div class="template-tips" id="templateTips"></div>
 </div>

 <!-- Text Analyzer -->
 <div class="templates-analyzer">
 <div class="analyzer-header">
 <h4> Eigenen Text pr√ºfen</h4>
 <p>Lass deinen Text auf Datenschutz-Risiken analysieren</p>
 </div>
 <form id="templatesAnalyzeForm" class="analyzer-form">
 <textarea id="templatesAnalyzeText" placeholder="F√ºge deinen Text ein, z.B. deine Social Media Bio..." rows="4"></textarea>
 <div class="analyzer-context">
 <label>Kontext:</label>
 <select id="templatesAnalyzeContext">
 <option value="social_media_bio">Social Media Bio</option>
 <option value="job_application">Bewerbung</option>
 <option value="online_form">Online-Formular</option>
 <option value="email" data-i18n="form.contexts.email">E-Mail</option>
 </select>
 </div>
 <button type="submit" class="analyze-btn">Analysieren</button>
 </form>
 <div id="templatesAnalyzeResult" class="analyze-result" style="display:none;"></div>
 </div>
 </div>
 </div>

 <div style="text-align:center; margin-top:40px;">
 <button onclick="openModal('caseModal')" data-i18n="cases.viewExamples">Fallbeispiele ansehen</button>
 </div>
 </main>

 <!-- Hinweis vor Authentifizierung -->
 <main class="main-content auth-required">
 <h2>Demo-Zugang</h2>
 <p>Die Live-Demo ist passwortgesch√ºtzt.</p>
 <p>Bitte gib das Passwort ein, um fortzufahren.</p>
 </main>

 <!-- Popup f√ºr Datenschutz -->
 <div id="datenschutzModal" class="modal">
 <div class="modal-content">
 <span class="close" onclick="closeModal('datenschutzModal')">&times;</span>
 <iframe src="datenschutz-popup2.html" style="width:100%; height:400px; border:none;"></iframe>
 </div>
 </div>

 <!-- Popup f√ºr Fallbeispiele -->
 <div id="caseModal" class="modal">
 <div class="modal-content">
 <span class="close" onclick="closeModal('caseModal')">&times;</span>

 <div class="case-study-container">
 <div class="case-study-box active">
 <h3>Fallbeispiel: Kreditkartendaten unbewusst geteilt</h3>
 <div class="label">Originaltext eines Nutzers:</div>
 <div class="field">Meine Kreditkartennummer lautet: 3948673029486</div>
 <div class="label">achtung.live Feedback:</div>
 <div class="feedback">Teile sensible Bankdaten wie IBANs oder Kreditkartennummern niemals √∂ffentlich.</div>
 <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
 <div class="field">Ich sende dir meine Zahlungsdaten separat √ºber einen sicheren Kanal.</div>
 <div class="label">achtung.live Tipp:</div>
 <div class="hint">Nutze verschl√ºsselte Messenger wie Signal oder sichere Kan√§le deiner Bank.</div>
 </div>

 <div class="case-study-box">
 <h3>Fallbeispiel: Standortdaten √∂ffentlich geteilt</h3>
 <div class="label">Originaltext eines Nutzers:</div>
 <div class="field">Bin gerade im Urlaub in Italien</div>
 <div class="label">achtung.live Feedback:</div>
 <div class="feedback">Standortinformationen verraten, wo du bist - und wo nicht...</div>
 <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
 <div class="field">Bis bald ‚Äì ich melde mich wieder mit Neuigkeiten!</div>
 <div class="label">achtung.live Tipp:</div>
 <div class="hint">Poste Urlaubs-Updates erst nach deiner R√ºckkehr.</div>
 </div>

 <div class="case-study-box">
 <h3>Fallbeispiel: Screenshot mit Patientendaten</h3>
 <div class="label">Originaltext eines Nutzers:</div>
 <div class="field">(Screenshot) Diagnosebericht meiner √Ñrztin f√ºr die Krankenkasse</div>
 <div class="label">achtung.live Feedback:</div>
 <div class="feedback">Fotos von Dokumenten k√∂nnen vertrauliche Gesundheitsdaten enthalten.</div>
 <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
 <div class="field">Bitte sichere √úbertragungswege f√ºr Dokumente verwenden.</div>
 <div class="label">achtung.live Tipp:</div>
 <div class="hint">Nutze verschl√ºsselte √úbermittlung, keine Messenger-Screenshots.</div>
 </div>

 <div class="case-study-box">
 <h3>Fallbeispiel: Arbeitgeber namentlich erw√§hnt</h3>
 <div class="label">Originaltext eines Nutzers:</div>
 <div class="field">Mein Chef bei der XY AG ist total unf√§hig...</div>
 <div class="label">achtung.live Feedback:</div>
 <div class="feedback">Nennungen von Firmen und Namen k√∂nnen rechtliche Folgen haben.</div>
 <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
 <div class="field">Ich habe in meinem Job aktuell Herausforderungen mit der F√ºhrungskultur.</div>
 <div class="label">achtung.live Tipp:</div>
 <div class="hint">Personen anonymisieren ‚Äì Fokus auf die Sache!</div>
 </div>

 <div class="case-study-box">
 <h3>Fallbeispiel: Messenger-Screenshot mit Klarnamen</h3>
 <div class="label">Originaltext eines Nutzers:</div>
 <div class="field">(Screenshot) WhatsApp-Chat mit vollem Namen sichtbar</div>
 <div class="label">achtung.live Feedback:</div>
 <div class="feedback">Screenshots k√∂nnen pers√∂nliche Daten offenlegen.</div>
 <div class="label">Empfohlene Text-Alternative zum Kopieren:</div>
 <div class="field">Anonymisierte Screenshots oder Zitate verwenden.</div>
 <div class="label">achtung.live Tipp:</div>
 <div class="hint">Namen und Profilbilder vorher unkenntlich machen.</div>
 </div>
 </div>

 <div class="case-study-nav">
 <button onclick="changeCase(-1)">Zur√ºck</button>
 <button onclick="changeCase(1)">Weiter</button>
 </div>

 <div style="text-align:center; margin-top:20px;">
 <button onclick="closeModal('caseModal')">Schlie√üen</button>
 </div>
 </div>
 </div>

 <footer class="site-footer">
 <div class="europe">Aus Europa. F√ºr Alle.</div>

 <div class="schutztext">
 [<span style="color: #800000;">achtung.live</span>] sch√ºtzt, was z√§hlt: unsere digitale Kommunikation. <br> In Echtzeit. Ohne Tracking. DSGVO & EU AI-Act-konform.
 </div>

 <nav class="footer-nav">
 <a href="info.html">Info</a> ‚Ä¢
 <a href="gefahr.html">Gefahr</a> ‚Ä¢
 <a href="demo.html" class="demo-highlight">Demo</a> ‚Ä¢
 <a href="ki-hinweis.html">KI-Hinweis</a> ‚Ä¢
 <a href="datenschutz.html">Datenschutz</a> ‚Ä¢
 <a href="kontakt.html">Kontakt</a> ‚Ä¢
 <a href="impressum.html">Impressum</a>
 </nav>

 <div class="copyright">
 ¬© 2025 achtung.live
 </div>
 </footer>

 <!-- Authentifizierungs-Script -->
 <script src="auth.js"></script>

 <script>
 // ========================================
 // API Konfiguration
 // ========================================
 const API_BASE = "/.netlify/functions";
 const API_ANALYZE_URL = `${API_BASE}/analyze`;
 const API_REWRITE_URL = `${API_BASE}/rewrite`;
 const API_BATCH_URL = `${API_BASE}/analyze-batch`;
 const API_HEALTH_URL = `${API_BASE}/health`;
const API_SPELL_CHECK_URL = `${API_BASE}/spell-check`;

 // Kategorie-Metadaten f√ºr das Dashboard (Phase 2: 25+ Kategorien)
 const CATEGORY_META = {
 // Finanzen
 iban: { label: "IBAN/Bankdaten", icon: "", group: "financial" },
 credit_card: { label: "Kreditkarte", icon: "", group: "financial" },
 bic: { label: "BIC/SWIFT", icon: "", group: "financial" },
 account_number: { label: "Kontonummer", icon: "", group: "financial" },

 // Identifikation
 national_id: { label: "Personalausweis", icon: "ü™™", group: "identity" },
 passport: { label: "Reisepass", icon: "", group: "identity" },
 tax_id: { label: "Steuer-ID", icon: "", group: "identity" },
 social_security: { label: "Sozialversicherung", icon: "üÜî", group: "identity" },
 drivers_license: { label: "F√ºhrerschein", icon: "", group: "identity" },

 // Gesundheit
 health_insurance: { label: "Krankenversicherung", icon: "", group: "health" },
 medical_record: { label: "Medizinische Daten", icon: "", group: "health" },
 health: { label: "Gesundheitsdaten", icon: "ü©∫", group: "health" },

 // Digital
 ip_address: { label: "IP-Adresse", icon: "", group: "digital" },
 mac_address: { label: "MAC-Adresse", icon: "", group: "digital" },
 username: { label: "Benutzername", icon: "", group: "digital" },
 password: { label: "Passwort", icon: "", group: "digital" },
 api_key: { label: "API-Schl√ºssel", icon: "", group: "digital" },

 // Pers√∂nlich
 name: { label: "Personenname", icon: "", group: "personal" },
 phone: { label: "Telefonnummer", icon: "", group: "personal" },
 email: { label: "E-Mail-Adresse", icon: "", group: "personal" },
 address: { label: "Postadresse", icon: "", group: "personal" },
 date_of_birth: { label: "Geburtsdatum", icon: "", group: "personal" },
 age: { label: "Alter", icon: "", group: "personal" },
 gender: { label: "Geschlecht", icon: "", group: "personal" },
 religion: { label: "Religion", icon: "", group: "personal" },
 political: { label: "Politische Meinung", icon: "", group: "personal" },
 sexual_orientation: { label: "Sexuelle Orientierung", icon: "‚Äç", group: "personal" },

 // Biometrisch
 biometric: { label: "Biometrische Daten", icon: "", group: "biometric" },
 photo: { label: "Erkennbares Foto", icon: "", group: "biometric" },

 // Standort
 gps_coordinates: { label: "GPS-Koordinaten", icon: "", group: "location" },
 license_plate: { label: "Kfz-Kennzeichen", icon: "", group: "location" },
 location: { label: "Standort", icon: "", group: "location" },
 vacation: { label: "Abwesenheit/Urlaub", icon: "", group: "location" },

 // Semantisch (GPT-erkannt)
 child: { label: "Kinderdaten", icon: "", group: "semantic" },
 emotion: { label: "Emotionen", icon: "", group: "semantic" },
 employer: { label: "Arbeitgeber", icon: "", group: "semantic" },
 legal: { label: "Rechtlich heikel", icon: "", group: "semantic" },

 // Fallback
 date: { label: "Datum/Termin", icon: "", group: "other" },
 generic: { label: "Sensible Daten", icon: "", group: "other" }
 };

 // Kontext-Warnungen
 const CONTEXT_WARNINGS = {
 whatsapp: "WhatsApp-Nachrichten k√∂nnen leicht weitergeleitet oder als Screenshot geteilt werden.",
 public: "√ñffentliche Posts sind f√ºr jeden sichtbar und k√∂nnen von Suchmaschinen indexiert werden.",
 linkedin: "Berufliche Netzwerke werden oft von Arbeitgebern und Recruitern durchsucht.",
 email: "E-Mails k√∂nnen weitergeleitet werden und verbleiben oft auf Servern.",
 private: null
 };

 // ========================================
 // Modal Funktionen
 // ========================================
 function openModal(id) {
 // Update privacy policy iframe based on current language
 if (id === 'datenschutzModal') {
   const iframe = document.querySelector('#datenschutzModal iframe');
   if (iframe) {
     const langSuffix = currentLang === 'de' ? '' : '-' + currentLang;
     iframe.src = 'datenschutz-popup2' + langSuffix + '.html';
   }
 }
 document.getElementById(id).style.display = "block";
 }

 function closeModal(id) {
 document.getElementById(id).style.display = "none";
 }

 // Fallbeispiele Navigation
 let currentCase = 0;
 const cases = document.querySelectorAll('.case-study-box');

 function changeCase(dir) {
 cases[currentCase].classList.remove('active');
 currentCase = (currentCase + dir + cases.length) % cases.length;
 cases[currentCase].classList.add('active');
 }

 // ========================================
 // Risk Dashboard Rendering
 // ========================================

 // Zeigt den Loading-Zustand
 function showLoading() {
 const dashboard = document.getElementById('riskDashboard');
 dashboard.style.display = 'block';
 dashboard.innerHTML = `
 <div class="risk-dashboard">
 <div class="dashboard-loading">
 <div class="loading-spinner"></div>
 <div class="loading-text">Analysiere deinen Text...</div>
 </div>
 </div>
 `;
 }

 // Berechnet Risk Score aus Kategorien (Fallback wenn Backend alt)
 function calculateRiskScore(categories) {
 if (!categories || categories.length === 0) return 100;

 let score = 100;
 for (const cat of categories) {
 switch (cat.severity) {
 case 'critical': score -= 35; break;
 case 'high': score -= 20; break;
 case 'medium': score -= 10; break;
 case 'low': score -= 5; break;
 default: score -= 15;
 }
 }
 return Math.max(0, score);
 }

 // Ermittelt Risk Level aus Score
 function getRiskLevel(score) {
 if (score >= 80) return 'safe';
 if (score >= 50) return 'warning';
 return 'danger';
 }

 // Status-Text f√ºr Risk Level
 function getStatusText(level) {
 switch (level) {
 case 'safe': return ' SICHER';
 case 'warning': return ' ACHTUNG';
 case 'danger': return ' GEFAHR';
 default: return 'UNBEKANNT';
 }
 }

 // Markiert sensible Stellen im Text (komplett neu geschrieben)
 function markText(text, categories) {
 if (!categories || categories.length === 0) return escapeHtml(text);

 // Sammle alle Markierungen mit korrekten Positionen
 const marks = categories
 .map(cat => {
 let start, end;
 if (cat.position && typeof cat.position.start === 'number') {
 start = cat.position.start;
 end = cat.position.end;
 } else if (cat.match) {
 start = text.indexOf(cat.match);
 end = start >= 0 ? start + cat.match.length : -1;
 } else {
 return null;
 }
 if (start < 0 || end <= start || end > text.length) return null;
 return { start, end, severity: cat.severity || 'medium', message: cat.message };
 })
 .filter(m => m !== null)
 .sort((a, b) => a.start - b.start);

 // Entferne √ºberlappende Markierungen (behalte die mit h√∂herer Severity)
 const severityOrder = { critical: 4, high: 3, medium: 2, low: 1 };
 const filtered = [];
 for (const mark of marks) {
 const lastMark = filtered[filtered.length - 1];
 if (lastMark && mark.start < lastMark.end) {
 // √úberlappung: behalte die mit h√∂herer Severity
 if ((severityOrder[mark.severity] || 0) > (severityOrder[lastMark.severity] || 0)) {
 filtered[filtered.length - 1] = mark;
 }
 // Sonst ignorieren
 } else {
 filtered.push(mark);
 }
 }

 // Baue den String von links nach rechts auf
 let result = '';
 let lastEnd = 0;

 for (const mark of filtered) {
 // Text vor der Markierung (escaped)
 if (mark.start > lastEnd) {
 result += escapeHtml(text.substring(lastEnd, mark.start));
 }
 // Markierter Text
 const matchText = text.substring(mark.start, mark.end);
 result += `<span class="text-mark ${mark.severity}">${escapeHtml(matchText)}</span>`;
 lastEnd = mark.end;
 }

 // Rest des Textes nach der letzten Markierung
 if (lastEnd < text.length) {
 result += escapeHtml(text.substring(lastEnd));
 }

 return result;
 }

 // HTML Escape Helper
 function escapeHtml(text) {
 if (!text) return '';
 const div = document.createElement('div');
 div.textContent = text;
 return div.innerHTML;
 }

 // Rendert das komplette Dashboard
 function renderDashboard(data, originalText, context) {
 const dashboard = document.getElementById('riskDashboard');

 // Normalisiere Daten (unterst√ºtzt altes und neues API-Format)
 const normalized = normalizeApiResponse(data, originalText);

 // Kontext-Warnung hinzuf√ºgen
 if (!normalized.contextWarning && CONTEXT_WARNINGS[context]) {
 normalized.contextWarning = CONTEXT_WARNINGS[context];
 }

 const { riskScore, riskLevel, categories, summary, contextWarning, rewrite } = normalized;

 // Wenn alles sicher ist
 if (categories.length === 0) {
 dashboard.innerHTML = `
 <div class="risk-dashboard">
 <div class="all-safe-message">
 <div class="all-safe-icon"></div>
 <div class="all-safe-title">Alles sicher!</div>
 <div class="all-safe-text">Keine sensiblen Daten in deinem Text erkannt.<br>Du kannst ihn bedenkenlos senden.</div>
 </div>
 ${contextWarning ? `
 <div class="context-warning">
 <span>${escapeHtml(contextWarning)}</span>
 </div>
 ` : ''}
 </div>
 `;
 return;
 }

 // Vollst√§ndiges Dashboard rendern
 dashboard.innerHTML = `
 <div class="risk-dashboard">
 <!-- Privacy Score -->
 <div class="privacy-score-section">
 <div class="privacy-score-label">Privacy Score</div>
 <div class="privacy-score-circle ${riskLevel}">
 <span class="privacy-score-number">${riskScore}</span>
 <span class="privacy-score-max">/ 100</span>
 </div>
 <div class="privacy-score-status ${riskLevel}">${getStatusText(riskLevel)}</div>
 <div class="privacy-score-summary">${escapeHtml(summary)}</div>
 </div>

 <!-- Kategorie-Badges -->
 <div class="risk-categories">
 ${categories.map(cat => {
 const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
 return `<span class="risk-category-badge ${cat.severity || 'medium'}">
 ${meta.icon} ${meta.label}
 </span>`;
 }).join('')}
 </div>

 <!-- Markierter Text -->
 <div class="marked-text-section">
 <div class="marked-text-label">Dein Text mit Markierungen</div>
 <div class="marked-text-container">${markText(originalText, categories)}</div>
 </div>

 <!-- Findings Liste -->
 <div class="findings-section">
 <div class="findings-list">
 ${categories.map(cat => {
 const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
 return `
 <div class="finding-item ${cat.severity || 'medium'}">
 <div class="finding-icon">${meta.icon}</div>
 <div class="finding-content">
 <div class="finding-title">${meta.label}</div>
 ${cat.match ? `<div class="finding-match">"${escapeHtml(cat.match.substring(0, 50))}${cat.match.length > 50 ? '...' : ''}"</div>` : ''}
 <div class="finding-message">${escapeHtml(cat.message || 'Sensible Information erkannt')}</div>
 ${cat.suggestion ? `<div class="finding-suggestion">${escapeHtml(cat.suggestion)}</div>` : ''}
 </div>
 </div>
 `;
 }).join('')}
 </div>
 </div>

 <!-- Kontext-Warnung -->
 ${contextWarning ? `
 <div class="context-warning">
 <span>${escapeHtml(contextWarning)}</span>
 </div>
 ` : ''}

 <!-- Smart Rewrite Section -->
 <div class="rewrite-section">
 <div class="rewrite-header">
 <span class="rewrite-title">Smart Rewrite</span>
 </div>

 <!-- Rewrite Mode Selection -->
 <div class="rewrite-mode-selector">
 <button class="rewrite-mode-btn active" data-mode="anonymize" onclick="selectRewriteMode('anonymize')">
 <span class="mode-label">Anonymisieren</span>
 <span class="mode-desc">[NAME], [IBAN]...</span>
 </button>
 <button class="rewrite-mode-btn" data-mode="redact" onclick="selectRewriteMode('redact')">
 <span class="mode-icon">‚ñà</span>
 <span class="mode-label">Zensieren</span>
 <span class="mode-desc">[ZENSIERT]</span>
 </button>
 <button class="rewrite-mode-btn" data-mode="pseudonymize" onclick="selectRewriteMode('pseudonymize')">
 <span class="mode-label">Pseudonymisieren</span>
 <span class="mode-desc">Fake-Daten</span>
 </button>
 </div>

 <button class="rewrite-generate-btn" onclick="generateRewrite()">
 <span class="btn-text">Text neu schreiben</span>
 <span class="btn-loading" style="display:none;">Generiere...</span>
 </button>

 <!-- Rewrite Result (initially hidden, shown after generation) -->
 <div id="rewriteResult" class="rewrite-result" style="display:none;">
 <div class="rewrite-container">
 <div class="rewrite-text" id="rewriteText"></div>
 </div>
 <div class="rewrite-changes" id="rewriteChanges"></div>
 <div class="rewrite-actions">
 <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
 Text kopieren
 </button>
 <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
 ‚Ü© In Textfeld √ºbernehmen
 </button>
 </div>
 </div>

 <!-- Show existing rewrite if available from API -->
 ${rewrite ? `
 <div class="rewrite-result">
 <div class="rewrite-container">
 <div class="rewrite-text" id="rewriteTextInitial">${escapeHtml(rewrite.suggestion || rewrite.rewritten || '')}</div>
 </div>
 ${rewrite.changes && rewrite.changes.length > 0 ? `
 <div class="rewrite-changes">
 ${rewrite.changes.map(change => {
 const changeText = typeof change === 'string' ? change : `${change.original} ‚Üí ${change.replacement}`;
 return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
 }).join('')}
 </div>
 ` : ''}
 <div class="rewrite-actions">
 <button class="rewrite-btn rewrite-btn-primary" onclick="copyRewrite()">
 Text kopieren
 </button>
 <button class="rewrite-btn rewrite-btn-secondary" onclick="useRewrite()">
 ‚Ü© In Textfeld √ºbernehmen
 </button>
 </div>
 </div>
 ` : ''}
 </div>

 <!-- Provider Info (if available) -->
 ${data.meta ? `
 <div class="provider-info">
 <span class="provider-badge">${data.meta.provider || 'AI'}</span>
 <span class="provider-model">${data.meta.model || ''}</span>
 <span class="provider-time">${data.meta.processingTime ? `${data.meta.processingTime}ms` : ''}</span>
 </div>
 ` : ''}
 </div>
 `;
 }

 // Generiert korrekten deutschen Summary-Text
 function generateSummary(categories) {
 if (!categories || categories.length === 0) {
 return 'Keine Risiken erkannt';
 }

 // Z√§hle nach Severity
 const counts = { critical: 0, high: 0, medium: 0, low: 0 };
 for (const cat of categories) {
 const sev = cat.severity || 'medium';
 counts[sev] = (counts[sev] || 0) + 1;
 }

 const parts = [];
 if (counts.critical > 0) {
 parts.push(`${counts.critical} kritische${counts.critical === 1 ? 's' : ''}`);
 }
 if (counts.high > 0) {
 parts.push(`${counts.high} hohe${counts.high === 1 ? 's' : ''}`);
 }
 if (counts.medium > 0) {
 parts.push(`${counts.medium} mittlere${counts.medium === 1 ? 's' : ''}`);
 }
 if (counts.low > 0) {
 parts.push(`${counts.low} geringe${counts.low === 1 ? 's' : ''}`);
 }

 if (parts.length === 0) {
 return `${categories.length} ${categories.length === 1 ? 'Risiko' : 'Risiken'} erkannt`;
 }

 const total = categories.length;
 return `${parts.join(', ')} ${total === 1 ? 'Risiko' : 'Risiken'} erkannt`;
 }

 // Normalisiert API-Response (unterst√ºtzt altes und neues Format)
 function normalizeApiResponse(data, originalText) {
 // Neues API v2 Format
 if (data.riskScore !== undefined && data.categories) {
 // √úberschreibe Summary mit korrektem Deutsch
 return {
 ...data,
 summary: generateSummary(data.categories)
 };
 }

 // Altes Format mit feedback Array
 if (data.feedback && Array.isArray(data.feedback)) {
 const categories = data.feedback.map((msg, i) => ({
 type: detectCategoryFromMessage(msg),
 severity: 'medium',
 message: msg,
 match: extractMatchFromMessage(msg, originalText)
 }));

 const riskScore = calculateRiskScore(categories);

 return {
 riskScore,
 riskLevel: getRiskLevel(riskScore),
 categories,
 summary: generateSummary(categories),
 rewrite: null
 };
 }

 // Altes Format mit detected_data etc.
 if (data.detected_data || data.risk_level) {
 const categories = [];
 if (data.detected_data && data.detected_data !== 'Keine') {
 categories.push({
 type: 'generic',
 severity: data.risk_level === 'hoch' ? 'critical' : 'medium',
 message: data.explanation || data.detected_data,
 suggestion: data.tip
 });
 }

 const riskScore = calculateRiskScore(categories);

 return {
 riskScore,
 riskLevel: getRiskLevel(riskScore),
 categories,
 summary: data.detected_data || 'Analyse abgeschlossen',
 rewrite: null
 };
 }

 // Fallback: Keine Risiken
 return {
 riskScore: 100,
 riskLevel: 'safe',
 categories: [],
 summary: 'Keine sensiblen Daten erkannt',
 rewrite: null
 };
 }

 // Erkennt Kategorie aus Nachrichtentext
 function detectCategoryFromMessage(msg) {
 const lower = msg.toLowerCase();
 if (lower.includes('iban') || lower.includes('bank') || lower.includes('konto')) return 'iban';
 if (lower.includes('kreditkarte') || lower.includes('kartennummer')) return 'credit_card';
 if (lower.includes('telefon') || lower.includes('handy') || lower.includes('nummer')) return 'phone';
 if (lower.includes('e-mail') || lower.includes('email')) return 'email';
 if (lower.includes('adresse') || lower.includes('stra√üe') || lower.includes('wohnort')) return 'address';
 if (lower.includes('passwort') || lower.includes('kennwort')) return 'password';
 if (lower.includes('gesundheit') || lower.includes('krankheit') || lower.includes('arzt') || lower.includes('diagnose')) return 'health';
 if (lower.includes('kind') || lower.includes('sohn') || lower.includes('tochter') || lower.includes('schule')) return 'child';
 if (lower.includes('standort') || lower.includes('urlaub') || lower.includes('reise') || lower.includes('nicht zuhause')) return 'vacation';
 if (lower.includes('w√ºtend') || lower.includes('emotion') || lower.includes('√§rger') || lower.includes('hass')) return 'emotion';
 if (lower.includes('chef') || lower.includes('arbeitgeber') || lower.includes('firma') || lower.includes('kollege')) return 'employer';
 if (lower.includes('beleidigung') || lower.includes('drohung') || lower.includes('rechtlich')) return 'legal';
 if (lower.includes('name') || lower.includes('person')) return 'name';
 return 'generic';
 }

 // Extrahiert Match aus Nachricht (einfache Heuristik)
 function extractMatchFromMessage(msg, originalText) {
 // Versuche Text in Anf√ºhrungszeichen zu finden
 const quoted = msg.match(/"([^"]+)"/);
 if (quoted) return quoted[1];

 // Sonst null
 return null;
 }

 // ========================================
 // Rewrite Funktionen (Phase 2)
 // ========================================

 let currentRewriteMode = 'anonymize';
 let lastAnalyzedText = '';

 function selectRewriteMode(mode) {
 currentRewriteMode = mode;
 document.querySelectorAll('.rewrite-mode-btn').forEach(btn => {
 btn.classList.toggle('active', btn.dataset.mode === mode);
 });
 }

 async function generateRewrite(originalText) {
 const text = originalText || lastAnalyzedText || document.getElementById('demoText').value;
 if (!text) return;

 const btn = document.querySelector('.rewrite-generate-btn');
 const btnText = btn.querySelector('.btn-text');
 const btnLoading = btn.querySelector('.btn-loading');

 // Show loading state
 btnText.style.display = 'none';
 btnLoading.style.display = 'inline';
 btn.disabled = true;

 try {
 const response = await fetch(API_REWRITE_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 text: text,
 mode: currentRewriteMode
 })
 });

 if (!response.ok) {
 throw new Error(`Server-Fehler: ${response.status}`);
 }

 const data = await response.json();

 // Show result
 const resultDiv = document.getElementById('rewriteResult');
 const rewriteTextDiv = document.getElementById('rewriteText');
 const changesDiv = document.getElementById('rewriteChanges');

 if (data.rewritten) {
 rewriteTextDiv.textContent = data.rewritten;

 // Show changes
 if (data.changes && data.changes.length > 0) {
 changesDiv.innerHTML = data.changes.map(change => {
 const changeText = typeof change === 'string' ? change : `${change.original} ‚Üí ${change.replacement}`;
 return `<span class="rewrite-change-tag">${escapeHtml(changeText)}</span>`;
 }).join('');
 } else {
 changesDiv.innerHTML = '';
 }

 resultDiv.style.display = 'block';
 }

 } catch (error) {
 console.error('Rewrite error:', error);
 alert('Fehler beim Rewrite: ' + error.message);
 } finally {
 // Reset button state
 btnText.style.display = 'inline';
 btnLoading.style.display = 'none';
 btn.disabled = false;
 }
 }

 function copyRewrite() {
 const text = document.getElementById('rewriteText')?.innerText ||
 document.getElementById('rewriteTextInitial')?.innerText;
 if (text) {
 navigator.clipboard.writeText(text).then(() => {
 const btn = event.target.closest('button');
 const originalHTML = btn.innerHTML;
 btn.innerHTML = ' Kopiert!';
 btn.classList.add('copy-success');
 setTimeout(() => {
 btn.innerHTML = originalHTML;
 btn.classList.remove('copy-success');
 }, 2000);
 });
 }
 }

 function useRewrite() {
 const text = document.getElementById('rewriteText')?.innerText ||
 document.getElementById('rewriteTextInitial')?.innerText;
 if (text) {
 document.getElementById('demoText').value = text;
 // Scroll zum Textfeld
 document.getElementById('demoText').scrollIntoView({ behavior: 'smooth' });
 document.getElementById('demoText').focus();
 }
 }

 // ========================================
 // Tab Navigation
 // ========================================

 function initTabs() {
 document.querySelectorAll('.tab-btn').forEach(btn => {
 btn.addEventListener('click', () => {
 const tabId = btn.dataset.tab;

 // Update buttons
 document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
 btn.classList.add('active');

 // Update content
 document.querySelectorAll('.tab-content').forEach(content => {
 content.classList.remove('active');
 });
 document.getElementById(tabId + 'Tab').classList.add('active');
 });
 });
 }

 // ========================================
 // Batch Analyse (Phase 2)
 // ========================================

 function initBatchAnalysis() {
 const textarea = document.getElementById('batchTexts');
 const dropZone = document.getElementById('dropZone');
 const fileInput = document.getElementById('batchFile');
 const form = document.getElementById('batchForm');

 // Count texts as user types
 if (textarea) {
 textarea.addEventListener('input', () => {
 const texts = parseTexts(textarea.value);
 document.getElementById('textCount').textContent = texts.length;
 });
 }

 // Drag & Drop
 if (dropZone) {
 dropZone.addEventListener('click', () => fileInput.click());

 dropZone.addEventListener('dragover', (e) => {
 e.preventDefault();
 dropZone.classList.add('drag-over');
 });

 dropZone.addEventListener('dragleave', () => {
 dropZone.classList.remove('drag-over');
 });

 dropZone.addEventListener('drop', (e) => {
 e.preventDefault();
 dropZone.classList.remove('drag-over');
 const file = e.dataTransfer.files[0];
 if (file) handleFile(file);
 });
 }

 // File input change
 if (fileInput) {
 fileInput.addEventListener('change', (e) => {
 const file = e.target.files[0];
 if (file) handleFile(file);
 });
 }

 // Form submit
 if (form) {
 form.addEventListener('submit', handleBatchSubmit);
 }
 }

 function parseTexts(input) {
 if (!input || !input.trim()) return [];
 // Split by double newline (empty line)
 return input.split(/\n\s*\n/)
 .map(t => t.trim())
 .filter(t => t.length > 0)
 .slice(0, 20); // Max 20 texts
 }

 function handleFile(file) {
 const reader = new FileReader();
 reader.onload = (e) => {
 const content = e.target.result;
 let texts = [];

 if (file.name.endsWith('.csv')) {
 // Parse CSV (assume one text per line)
 texts = content.split('\n').filter(t => t.trim());
 } else {
 // Parse TXT (double newline separated)
 texts = parseTexts(content);
 }

 document.getElementById('batchTexts').value = texts.join('\n\n');
 document.getElementById('textCount').textContent = Math.min(texts.length, 20);
 };
 reader.readAsText(file);
 }

 async function handleBatchSubmit(e) {
 e.preventDefault();

 const texts = parseTexts(document.getElementById('batchTexts').value);
 if (texts.length === 0) {
 alert('Bitte mindestens einen Text eingeben.');
 return;
 }

 const btn = document.getElementById('batchSubmitBtn');
 const btnText = btn.querySelector('.btn-text');
 const btnLoading = btn.querySelector('.btn-loading');

 btnText.style.display = 'none';
 btnLoading.style.display = 'inline';
 btn.disabled = true;

 try {
 const response = await fetch(API_BATCH_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 texts: texts.map((text, i) => ({ id: `text-${i}`, text }))
 })
 });

 if (!response.ok) {
 throw new Error(`Server-Fehler: ${response.status}`);
 }

 const data = await response.json();
 renderBatchResults(data, texts);

 } catch (error) {
 console.error('Batch error:', error);
 document.getElementById('batchResults').innerHTML = `
 <div class="batch-error">
 <span>Fehler: ${escapeHtml(error.message)}</span>
 </div>
 `;
 document.getElementById('batchResults').style.display = 'block';
 } finally {
 btnText.style.display = 'inline';
 btnLoading.style.display = 'none';
 btn.disabled = false;
 }
 }

 function renderBatchResults(data, originalTexts) {
 const resultsDiv = document.getElementById('batchResults');

 // Calculate summary from results if not provided
 const results = data.results || [];
 const totalTexts = results.length;

 // Calculate average score
 const scores = results
 .filter(r => r.success !== false && r.analysis?.riskScore !== undefined)
 .map(r => r.analysis.riskScore);
 const averageScore = scores.length > 0
 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length)
 : 100;

 // Calculate total risks
 const totalRisks = results.reduce((sum, r) =>
 sum + (r.analysis?.categories?.length || 0), 0);

 resultsDiv.innerHTML = `
 <div class="batch-results-container">
 <!-- Summary -->
 <div class="batch-summary">
 <div class="batch-summary-item">
 <span class="summary-number">${totalTexts}</span>
 <span class="summary-label">Texte analysiert</span>
 </div>
 <div class="batch-summary-item">
 <span class="summary-number ${averageScore >= 80 ? 'safe' : averageScore >= 50 ? 'warning' : 'danger'}">
 ${averageScore}
 </span>
 <span class="summary-label">Durchschn. Score</span>
 </div>
 <div class="batch-summary-item">
 <span class="summary-number">${totalRisks}</span>
 <span class="summary-label">Risiken gesamt</span>
 </div>
 </div>

 <!-- Individual Results -->
 <div class="batch-results-list">
 ${results.map((result, i) => {
 const text = originalTexts[i] || '';
 const preview = text.substring(0, 100) + (text.length > 100 ? '...' : '');
 const analysis = result.analysis || {};
 const riskScore = analysis.riskScore ?? 100;
 const level = getRiskLevel(riskScore);
 const riskCount = analysis.categories?.length || 0;

 return `
 <div class="batch-result-item ${level}">
 <div class="result-header">
 <span class="result-number">#${i + 1}</span>
 <span class="result-score ${level}">${riskScore}/100</span>
 </div>
 <div class="result-preview">${escapeHtml(preview)}</div>
 ${riskCount > 0 ? `
 <div class="result-risks">
 ${analysis.categories.slice(0, 3).map(cat => {
 const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
 return `<span class="risk-mini-badge ${cat.severity || 'medium'}">${meta.icon}</span>`;
 }).join('')}
 ${riskCount > 3 ? `<span class="risk-more">+${riskCount - 3}</span>` : ''}
 </div>
 ` : '<div class="result-safe"> Sicher</div>'}
 </div>
 `;
 }).join('')}
 </div>
 </div>
 `;

 resultsDiv.style.display = 'block';
 resultsDiv.scrollIntoView({ behavior: 'smooth' });
 }

 // ========================================
 // Health Check & API Status
 // ========================================

 async function checkApiHealth() {
 const statusDiv = document.getElementById('apiStatus');
 if (!statusDiv) return;

 try {
 const response = await fetch(API_HEALTH_URL);
 const data = await response.json();

 // Accept various healthy status values
 const isHealthy = data.status === 'healthy' ||
 data.status === 'ok' ||
 data.status === 'up' ||
 response.ok;

 if (isHealthy) {
 const providerInfo = data.providers || {};
 const quickCheck = data.quickCheck || {};
 const openaiOk = providerInfo.openai?.status === 'ok' || providerInfo.openai?.available;
 const anthropicOk = providerInfo.anthropic?.status === 'ok' || providerInfo.anthropic?.available;

 // Build provider badges
 let providerBadges = '';
 if (openaiOk) providerBadges += '<span class="provider-badge openai">OpenAI</span>';
 if (anthropicOk) providerBadges += '<span class="provider-badge anthropic">Claude</span>';

 // Build quick check info
 let quickCheckInfo = '';
 if (quickCheck.enabled) {
 quickCheckInfo = `
 <span class="quick-check-badge" title="Live-Pr√ºfung: ${quickCheck.patternsLoaded || 27} Patterns, Cache: ${quickCheck.cacheHitRate || '0%'}">
 Live
 </span>
 `;
 }

 statusDiv.innerHTML = `
 <span class="status-dot healthy"></span>
 <span class="status-text">API v${data.version || '3.0'}</span>
 <span class="status-badges">
 ${providerBadges}
 ${quickCheckInfo}
 </span>
 `;
 statusDiv.className = 'api-status healthy';
 } else if (data.status === 'degraded') {
 statusDiv.innerHTML = `
 <span class="status-dot degraded"></span>
 <span class="status-text">Eingeschr√§nkt</span>
 `;
 statusDiv.className = 'api-status degraded';
 } else {
 statusDiv.innerHTML = `
 <span class="status-dot degraded"></span>
 <span class="status-text">Status: ${data.status || 'unbekannt'}</span>
 `;
 statusDiv.className = 'api-status degraded';
 }
 } catch (error) {
 statusDiv.innerHTML = `
 <span class="status-dot offline"></span>
 <span class="status-text">API Offline</span>
 `;
 statusDiv.className = 'api-status offline';
 }
 }

 // ========================================
 // Formular Handler

// ========================================
// Spell Check Function
// ========================================

async function checkSpelling() {
  const text = document.getElementById('demoText').value;
  const resultsDiv = document.getElementById('spellCheckResults');
  
  if (!text || text.trim().length < 3) {
    alert('Bitte gib mindestens 3 Zeichen ein.');
    return;
  }

  resultsDiv.style.display = 'block';
  resultsDiv.innerHTML = '<p style="text-align:center;">Pruefe Rechtschreibung...</p>';

  try {
    const response = await fetch(API_SPELL_CHECK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, language: currentLang || 'de' })
    });

    const data = await response.json();

    if (!data.success) {
      resultsDiv.innerHTML = '<p class="error-text">Rechtschreibpruefung nicht verfuegbar.</p>';
      return;
    }

    if (!data.hasErrors) {
      resultsDiv.innerHTML = `
        <div class="no-errors">
          <h4>Keine Fehler gefunden</h4>
          <p>Dein Text ist grammatikalisch und orthografisch korrekt.</p>
        </div>
      `;
      return;
    }

    // Store corrected text for apply function
    window.lastCorrectedText = data.correctedText;

    resultsDiv.innerHTML = `
      <div class="spell-check-header">
        <h3>Rechtschreib- und Grammatikpruefung</h3>
        <div class="spell-check-stats">
          <span class="spell-stat"><span class="count">${data.stats.spelling}</span> Rechtschreibung</span>
          <span class="spell-stat"><span class="count">${data.stats.grammar}</span> Grammatik</span>
          <span class="spell-stat"><span class="count">${data.stats.punctuation}</span> Zeichensetzung</span>
        </div>
      </div>
      <div class="correction-list">
        ${data.corrections.map(c => `
          <div class="correction-item ${c.rule.type}">
            <div>
              <span class="correction-original">${data.originalText.substring(c.offset, c.offset + c.length)}</span>
              <span class="correction-arrow">‚Üí</span>
              <span class="correction-suggestion" onclick="applySingleCorrection('${c.offset}', '${c.length}', '${c.replacements[0] || ''}')">${c.replacements[0] || '(entfernen)'}</span>
              <span class="correction-type ${c.rule.type}">${getTypeLabel(c.rule.type)}</span>
            </div>
            <div class="correction-message">${c.message}</div>
          </div>
        `).join('')}
      </div>
      <div class="spell-check-actions">
        <button class="apply-corrections-btn" onclick="applyAllCorrections()">Alle Korrekturen uebernehmen</button>
      </div>
    `;
  } catch (error) {
    console.error('Spell check error:', error);
    resultsDiv.innerHTML = '<p class="error-text">Fehler bei der Rechtschreibpruefung.</p>';
  }
}

function getTypeLabel(type) {
  const labels = {
    'spelling': 'Rechtschreibung',
    'grammar': 'Grammatik',
    'punctuation': 'Zeichensetzung',
    'style': 'Stil',
    'other': 'Sonstiges'
  };
  return labels[type] || type;
}

function applyAllCorrections() {
  if (window.lastCorrectedText) {
    document.getElementById('demoText').value = window.lastCorrectedText;
    document.getElementById('spellCheckResults').style.display = 'none';
  }
}

function applySingleCorrection(offset, length, replacement) {
  const textarea = document.getElementById('demoText');
  const text = textarea.value;
  const start = parseInt(offset);
  const end = start + parseInt(length);
  textarea.value = text.substring(0, start) + replacement + text.substring(end);
  // Re-run spell check
  checkSpelling();
}

 // ========================================

 document.getElementById("demoForm").addEventListener("submit", async function (e) {
 e.preventDefault();
 const text = document.getElementById("demoText").value;
 const context = document.getElementById("contextSelect").value;

 // Store for rewrite function
 lastAnalyzedText = text;

 showLoading();

 try {
 const response = await fetch(API_ANALYZE_URL, {
 method: "POST",
 headers: { "Content-Type": "application/json" },
 body: JSON.stringify({ text, context })
 });

 if (!response.ok) {
 throw new Error(`Server-Fehler: ${response.status}`);
 }

 const data = await response.json();
 renderDashboard(data, text, context);

 // Scroll zum Dashboard
 document.getElementById('riskDashboard').scrollIntoView({ behavior: 'smooth' });

 } catch (err) {
 const dashboard = document.getElementById('riskDashboard');
 dashboard.innerHTML = `
 <div class="risk-dashboard">
 <div style="padding: 40px 20px; text-align: center;">
 <div style="font-size: 48px; margin-bottom: 15px;"></div>
 <div style="font-size: 18px; font-weight: 600; color: #dc3545; margin-bottom: 10px;">
 Fehler bei der Analyse
 </div>
 <div style="font-size: 14px; color: #6c757d;">
 ${escapeHtml(err.message)}<br>
 <small>Bitte versuche es sp√§ter erneut.</small>
 </div>
 </div>
 </div>
 `;
 }
 });

 // ========================================
 // Event Listener
 // ========================================

 // Schlie√üen bei Klick au√üerhalb des Modals
 window.onclick = function(event) {
 if (event.target.classList.contains('modal')) {
 event.target.style.display = 'none';
 }
 };

 // ========================================
 // Phase 3: Accessibility Functions
 // ========================================

 let currentFontSize = 0; // -2 to +2 scale
 let highContrastMode = false;
 let simpleLanguageMode = false;
 let realtimeMode = false;
 let realtimeTimeout = null;

 // Font Size Control
 function changeFontSize(dir) {
 if (dir === 0) {
 currentFontSize = 0;
 } else {
 currentFontSize = Math.max(-2, Math.min(2, currentFontSize + dir));
 }

 // Base font size is 16px
 const baseFontSize = 16;
 const fontSizeMap = {
 '-2': 12,
 '-1': 14,
 '0': 16,
 '1': 18,
 '2': 22
 };

 document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';

 // Update button states
 document.querySelectorAll('.a11y-group .a11y-btn').forEach((btn, i) => {
 if (i < 3) { // Only the font size buttons
 btn.classList.toggle('active',
 (i === 0 && currentFontSize < 0) ||
 (i === 1 && currentFontSize === 0) ||
 (i === 2 && currentFontSize > 0)
 );
 }
 });

 // Save preference
 localStorage.setItem('achtung-fontSize', currentFontSize);
 }

 // High Contrast Mode
 function toggleHighContrast() {
 highContrastMode = !highContrastMode;
 document.body.classList.toggle('high-contrast', highContrastMode);
 document.getElementById('contrastToggle').classList.toggle('active', highContrastMode);

 // Save preference
 localStorage.setItem('achtung-highContrast', highContrastMode);
 }

 // Simple Language Mode
 function toggleSimpleLanguage() {
 simpleLanguageMode = !simpleLanguageMode;
 document.body.classList.toggle('simple-language', simpleLanguageMode);
 document.getElementById('simpleLangToggle').classList.toggle('active', simpleLanguageMode);

 // Show/hide simple language elements
 document.querySelectorAll('.simple-lang').forEach(el => {
 el.style.display = simpleLanguageMode ? 'block' : 'none';
 });

 // Update main claim
 document.getElementById('mainClaim').style.display = simpleLanguageMode ? 'none' : 'block';
 document.getElementById('mainClaimSimple').style.display = simpleLanguageMode ? 'block' : 'none';

 // Save preference
 localStorage.setItem('achtung-simpleLanguage', simpleLanguageMode);
 }

 // Real-Time Checking
 function toggleRealtime() {
 realtimeMode = !realtimeMode;
 document.getElementById('realtimeToggle').classList.toggle('active', realtimeMode);
 document.getElementById('liveCheckIndicator').style.display = realtimeMode ? 'flex' : 'none';
 document.getElementById('livePreview').style.display = realtimeMode ? 'block' : 'none';

 if (realtimeMode) {
 // Add input listener for real-time checking
 document.getElementById('demoText').addEventListener('input', handleRealtimeInput);
 // Initial check if there's text
 const currentText = document.getElementById('demoText').value;
 if (currentText.trim().length > 10) {
 handleRealtimeInput();
 }
 } else {
 document.getElementById('demoText').removeEventListener('input', handleRealtimeInput);
 document.getElementById('livePreviewContent').innerHTML = '';
 }

 // Save preference
 localStorage.setItem('achtung-realtime', realtimeMode);
 }

 // Debounced real-time input handler
 function handleRealtimeInput() {
 clearTimeout(realtimeTimeout);

 const text = document.getElementById('demoText').value;
 const previewContent = document.getElementById('livePreviewContent');

 if (text.trim().length < 10) {
 previewContent.innerHTML = '<span class="live-hint">Mindestens 10 Zeichen f√ºr Live-Pr√ºfung...</span>';
 return;
 }

 // Show checking indicator
 previewContent.innerHTML = '<span class="live-checking"><span class="live-spinner"></span> Pr√ºfe...</span>';

 // Debounce: Wait 800ms after typing stops
 realtimeTimeout = setTimeout(async () => {
 try {
 const response = await fetch(API_ANALYZE_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 text: text,
 context: document.getElementById('contextSelect').value,
 options: { quickCheck: true }
 })
 });

 if (!response.ok) throw new Error('API Error');

 const data = await response.json();
 renderLivePreview(data, text);

 } catch (error) {
 previewContent.innerHTML = '<span class="live-error">Pr√ºfung fehlgeschlagen</span>';
 }
 }, 800);
 }

 // Render live preview results
 function renderLivePreview(data, text) {
 const previewContent = document.getElementById('livePreviewContent');
 const normalized = normalizeApiResponse(data, text);
 const meta = data.meta || {};
 const processingTime = meta.processingTime ? `${meta.processingTime}ms` : '';
 const cached = meta.cached ? ' (cached)' : '';

 if (normalized.categories.length === 0) {
 previewContent.innerHTML = `
 <div class="live-safe">
 <span class="live-safe-text">Keine Risiken erkannt</span>
 ${processingTime ? `<span class="live-time">${processingTime}${cached}</span>` : ''}
 </div>
 `;
 } else {
 const riskCount = normalized.categories.length;
 const highestSeverity = normalized.categories.reduce((highest, cat) => {
 const order = { critical: 4, high: 3, medium: 2, low: 1 };
 return order[cat.severity] > order[highest] ? cat.severity : highest;
 }, 'low');

 previewContent.innerHTML = `
 <div class="live-warning ${highestSeverity}">
 <span class="live-warning-text">${riskCount} ${riskCount === 1 ? 'Risiko' : 'Risiken'} erkannt</span>
 ${processingTime ? `<span class="live-time">${processingTime}${cached}</span>` : ''}
 <div class="live-categories">
 ${normalized.categories.slice(0, 3).map(cat => {
 const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
 return `<span class="live-category ${cat.severity}">${meta.icon}</span>`;
 }).join('')}
 ${riskCount > 3 ? `<span class="live-more">+${riskCount - 3}</span>` : ''}
 </div>
 </div>
 `;
 }
 }

 // Load saved accessibility preferences
 function loadAccessibilityPreferences() {
 // Font size
 const savedFontSize = localStorage.getItem('achtung-fontSize');
 if (savedFontSize !== null) {
 currentFontSize = parseInt(savedFontSize);
 changeFontSize(0); // Apply without changing
 currentFontSize = parseInt(savedFontSize); // Restore
 const fontSizeMap = { '-2': 12, '-1': 14, '0': 16, '1': 18, '2': 22 };
 document.documentElement.style.fontSize = fontSizeMap[currentFontSize] + 'px';
 }

 // High contrast
 if (localStorage.getItem('achtung-highContrast') === 'true') {
 toggleHighContrast();
 }

 // Simple language
 if (localStorage.getItem('achtung-simpleLanguage') === 'true') {
 toggleSimpleLanguage();
 }

 // Real-time (don't auto-enable on page load for performance)
 }

 // ========================================
 // Screen Reader Announcements
 // ========================================

 function announceToScreenReader(message) {
 const announcer = document.createElement('div');
 announcer.setAttribute('role', 'status');
 announcer.setAttribute('aria-live', 'polite');
 announcer.setAttribute('aria-atomic', 'true');
 announcer.className = 'sr-only';
 announcer.textContent = message;
 document.body.appendChild(announcer);
 setTimeout(() => announcer.remove(), 1000);
 }

 // ========================================
 // Phase 4: Internationalization (i18n)
 // ========================================

 let currentLang = 'de';
 let translations = {};

 async function loadTranslations(lang) {
 try {
 const response = await fetch(`/locales/${lang}.json`);
 if (!response.ok) throw new Error('Translation not found');
 return await response.json();
 } catch (error) {
 console.warn(`Failed to load ${lang} translations:`, error);
 return null;
 }
 }

 async function switchLanguage(lang) {
 // Load translations if not cached
 if (!translations[lang]) {
 translations[lang] = await loadTranslations(lang);
 }

 if (!translations[lang]) {
 console.error(`Translations for ${lang} not available`);
 return;
 }

 currentLang = lang;
 document.documentElement.lang = lang;

 // Update UI with translations
 applyTranslations(translations[lang]);

 // Update language buttons
 document.querySelectorAll('.lang-btn').forEach(btn => {
 btn.classList.toggle('active', btn.dataset.lang === lang);
 });

 // Save preference
 localStorage.setItem('achtung-lang', lang);
 }

 function applyTranslations(t) {
 document.querySelectorAll('[data-i18n]').forEach(el => {
 const key = el.dataset.i18n;
 const value = getNestedValue(t, key);
 if (value) {
 el.textContent = value;
 }
 });

 // Update placeholders
 const demoText = document.getElementById('demoText');
 if (demoText && t.form?.placeholder) {
 demoText.placeholder = t.form.placeholder;
 }

 const batchTexts = document.getElementById('batchTexts');
 if (batchTexts && t.batch?.placeholder) {
 batchTexts.placeholder = t.batch.placeholder;
 }
 }

 function getNestedValue(obj, path) {
 return path.split('.').reduce((current, key) => current?.[key], obj);
 }

 function t(key, replacements = {}) {
 const lang = translations[currentLang] || translations['de'];
 let value = getNestedValue(lang, key) || key;

 // Replace placeholders like {count}
 Object.entries(replacements).forEach(([k, v]) => {
 value = value.replace(`{${k}}`, v);
 });

 return value;
 }

 // ========================================
 // Phase 4: Document Upload & Analysis
 // ========================================

 let selectedDocument = null;
 const API_DOCUMENT_URL = `${API_BASE}/analyze-document`;

 function initDocumentUpload() {
 const dropZone = document.getElementById('docDropZone');
 const fileInput = document.getElementById('documentFile');
 const form = document.getElementById('documentForm');

 if (!dropZone || !fileInput) return;

 // Click to select
 dropZone.addEventListener('click', () => fileInput.click());

 // Drag & drop
 dropZone.addEventListener('dragover', (e) => {
 e.preventDefault();
 dropZone.classList.add('drag-over');
 });

 dropZone.addEventListener('dragleave', () => {
 dropZone.classList.remove('drag-over');
 });

 dropZone.addEventListener('drop', (e) => {
 e.preventDefault();
 dropZone.classList.remove('drag-over');
 const file = e.dataTransfer.files[0];
 if (file) handleDocumentSelect(file);
 });

 // File input change
 fileInput.addEventListener('change', (e) => {
 const file = e.target.files[0];
 if (file) handleDocumentSelect(file);
 });

 // Form submit
 if (form) {
 form.addEventListener('submit', handleDocumentSubmit);
 }
 }

 function handleDocumentSelect(file) {
 const maxImageSize = 10 * 1024 * 1024; // 10 MB
 const maxPdfSize = 25 * 1024 * 1024; // 25 MB
 const isImage = file.type.startsWith('image/');
 const isPdf = file.type === 'application/pdf';

 if (!isImage && !isPdf) {
 alert('Bitte nur Bilder (PNG, JPG) oder PDFs hochladen.');
 return;
 }

 const maxSize = isImage ? maxImageSize : maxPdfSize;
 if (file.size > maxSize) {
 alert(`Datei zu gro√ü. Maximum: ${maxSize / 1024 / 1024} MB`);
 return;
 }

 selectedDocument = file;

 // Show preview
 const preview = document.getElementById('documentPreview');
 const fileName = document.getElementById('docFileName');
 const fileSize = document.getElementById('docFileSize');
 const previewImage = document.getElementById('docPreviewImage');
 const previewPdf = document.getElementById('docPreviewPdf');
 const ocrOptions = document.getElementById('ocrOptions');
 const submitBtn = document.getElementById('docSubmitBtn');

 fileName.textContent = file.name;
 fileSize.textContent = formatFileSize(file.size);

 if (isImage) {
 const reader = new FileReader();
 reader.onload = (e) => {
 previewImage.src = e.target.result;
 previewImage.style.display = 'block';
 previewPdf.style.display = 'none';
 };
 reader.readAsDataURL(file);
 } else {
 previewImage.style.display = 'none';
 previewPdf.style.display = 'flex';
 }

 preview.style.display = 'block';
 ocrOptions.style.display = 'flex';
 submitBtn.disabled = false;

 // Hide upload zone text
 document.getElementById('docDropZone').classList.add('has-file');
 }

 function removeDocument() {
 selectedDocument = null;
 document.getElementById('documentPreview').style.display = 'none';
 document.getElementById('ocrOptions').style.display = 'none';
 document.getElementById('docSubmitBtn').disabled = true;
 document.getElementById('docDropZone').classList.remove('has-file');
 document.getElementById('documentFile').value = '';
 }

 function formatFileSize(bytes) {
 if (bytes < 1024) return bytes + ' B';
 if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
 return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
 }

 async function handleDocumentSubmit(e) {
 e.preventDefault();

 if (!selectedDocument) {
 alert('Bitte zuerst ein Dokument ausw√§hlen.');
 return;
 }

 const btn = document.getElementById('docSubmitBtn');
 const btnText = btn.querySelector('.btn-text');
 const btnLoading = btn.querySelector('.btn-loading');

 btnText.style.display = 'none';
 btnLoading.style.display = 'inline';
 btn.disabled = true;

 try {
 const formData = new FormData();
 formData.append('file', selectedDocument);
 formData.append('lang', currentLang);
 formData.append('options', JSON.stringify({
 ocr: document.getElementById('enableOcr').checked,
 sentiment: document.getElementById('enableSentiment').checked
 }));

 const response = await fetch(API_DOCUMENT_URL, {
 method: 'POST',
 body: formData
 });

 if (!response.ok) {
 throw new Error(`Server-Fehler: ${response.status}`);
 }

 const data = await response.json();
 renderDocumentResults(data);

 } catch (error) {
 console.error('Document analysis error:', error);
 document.getElementById('documentResults').innerHTML = `
 <div class="doc-error">
 <span>${t('errors.analysisError')}: ${error.message}</span>
 </div>
 `;
 document.getElementById('documentResults').style.display = 'block';
 } finally {
 btnText.style.display = 'inline';
 btnLoading.style.display = 'none';
 btn.disabled = false;
 }
 }

 function renderDocumentResults(data) {
 const resultsDiv = document.getElementById('documentResults');
 const extractedSection = document.getElementById('extractedTextSection');
 const sentimentSection = document.getElementById('sentimentSection');
 const riskDashboard = document.getElementById('docRiskDashboard');

 // Show extracted text if available
 if (data.document?.extractedText) {
 document.getElementById('extractedText').textContent = data.document.extractedText;
 if (data.document.ocrConfidence) {
 document.getElementById('ocrConfidence').textContent =
 `${Math.round(data.document.ocrConfidence * 100)}% ${t('document.confidence')}`;
 }
 extractedSection.style.display = 'block';
 } else {
 extractedSection.style.display = 'none';
 }

 // Show sentiment if available
 if (data.sentiment) {
 const sentimentResult = document.getElementById('sentimentResult');
 const sentimentLabels = {
 positive: { icon: '', text: t('document.sentimentPositive'), class: 'positive' },
 neutral: { icon: '', text: t('document.sentimentNeutral'), class: 'neutral' },
 negative: { icon: '', text: t('document.sentimentNegative'), class: 'negative' }
 };
 const s = sentimentLabels[data.sentiment.label] || sentimentLabels.neutral;

 sentimentResult.innerHTML = `
 <span class="sentiment-icon">${s.icon}</span>
 <span class="sentiment-label ${s.class}">${s.text}</span>
 <span class="sentiment-score">${(data.sentiment.score * 100).toFixed(0)}%</span>
 `;
 sentimentSection.style.display = 'block';
 } else {
 sentimentSection.style.display = 'none';
 }

 // Render risk dashboard using existing function
 if (data.categories && data.categories.length > 0) {
 // Re-use existing dashboard rendering
 const dashboardHtml = generateDashboardHtml(data, data.document?.extractedText || '');
 riskDashboard.innerHTML = dashboardHtml;
 } else {
 riskDashboard.innerHTML = `
 <div class="all-safe-message">
 <div class="all-safe-icon"></div>
 <div class="all-safe-title">${t('results.safe')}</div>
 <div class="all-safe-text">${t('results.safeText')}</div>
 </div>
 `;
 }

 resultsDiv.style.display = 'block';
 resultsDiv.scrollIntoView({ behavior: 'smooth' });
 }

 function generateDashboardHtml(data, text) {
 const normalized = normalizeApiResponse(data, text);
 const { riskScore, riskLevel, categories } = normalized;

 return `
 <div class="privacy-score-section">
 <div class="privacy-score-label">${t('results.privacyScore')}</div>
 <div class="privacy-score-circle ${riskLevel}">
 <span class="privacy-score-number">${riskScore}</span>
 <span class="privacy-score-max">/ 100</span>
 </div>
 <div class="privacy-score-status ${riskLevel}">${getStatusText(riskLevel)}</div>
 </div>
 <div class="risk-categories">
 ${categories.map(cat => {
 const meta = CATEGORY_META[cat.type] || CATEGORY_META.generic;
 return `<span class="risk-category-badge ${cat.severity || 'medium'}">
 ${meta.icon} ${t('categories.' + cat.type) || meta.label}
 </span>`;
 }).join('')}
 </div>
 `;
 }

 // ========================================
 // Phase 4: PWA Support
 // ========================================

 let deferredPrompt = null;

 function initPWA() {
 // Register service worker
 if ('serviceWorker' in navigator) {
 navigator.serviceWorker.register('/service-worker.js')
 .then(registration => {
 console.log('Service Worker registered:', registration.scope);

 // Check for updates
 registration.addEventListener('updatefound', () => {
 const newWorker = registration.installing;
 newWorker.addEventListener('statechange', () => {
 if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
 showUpdatePrompt();
 }
 });
 });
 })
 .catch(error => {
 console.log('Service Worker registration failed:', error);
 });
 }

 // Listen for install prompt
 window.addEventListener('beforeinstallprompt', (e) => {
 e.preventDefault();
 deferredPrompt = e;
 showInstallPrompt();
 });

 // Track install
 window.addEventListener('appinstalled', () => {
 console.log('PWA installed');
 hideInstallPrompt();
 deferredPrompt = null;
 });

 // Online/offline detection
 window.addEventListener('online', updateOnlineStatus);
 window.addEventListener('offline', updateOnlineStatus);
 updateOnlineStatus();
 }

 function showInstallPrompt() {
 const prompt = document.getElementById('pwaInstallPrompt');
 if (prompt && !localStorage.getItem('achtung-pwa-dismissed')) {
 prompt.style.display = 'flex';
 }
 }

 function hideInstallPrompt() {
 const prompt = document.getElementById('pwaInstallPrompt');
 if (prompt) {
 prompt.style.display = 'none';
 }
 }

 function dismissPWAPrompt() {
 hideInstallPrompt();
 localStorage.setItem('achtung-pwa-dismissed', 'true');
 }

 async function installPWA() {
 if (!deferredPrompt) return;

 deferredPrompt.prompt();
 const { outcome } = await deferredPrompt.userChoice;

 if (outcome === 'accepted') {
 console.log('User accepted PWA install');
 }

 deferredPrompt = null;
 hideInstallPrompt();
 }

 function showUpdatePrompt() {
 // Could show a toast notification here
 console.log('New version available');
 }

 function updateOnlineStatus() {
 const indicator = document.getElementById('offlineIndicator');
 if (indicator) {
 indicator.style.display = navigator.onLine ? 'none' : 'flex';
 }

 // Update API status when coming back online
 if (navigator.onLine) {
 checkApiHealth();
 // Re-cache patterns when coming back online
 cacheOfflinePatterns();
 }
 }

 // ========================================
 // Offline Pattern Caching
 // ========================================

 let offlinePatterns = null;
 const API_PATTERNS_URL = `${API_BASE}/patterns-offline`;
 const API_PING_URL = `${API_BASE}/ping`;

 async function cacheOfflinePatterns() {
 try {
 const response = await fetch(`${API_PATTERNS_URL}?lang=${currentLang}`);
 if (response.ok) {
 offlinePatterns = await response.json();
 localStorage.setItem('achtung-offline-patterns', JSON.stringify(offlinePatterns));
 console.log('[PWA] Offline patterns cached:', offlinePatterns.patterns?.length || 0, 'patterns');

 // Tell service worker to cache this
 if (navigator.serviceWorker?.controller) {
 navigator.serviceWorker.controller.postMessage({
 type: 'CACHE_PATTERNS',
 payload: { url: `${API_PATTERNS_URL}?lang=${currentLang}` }
 });
 }
 }
 } catch (error) {
 console.log('[PWA] Could not cache patterns:', error.message);
 // Try to load from localStorage
 const cached = localStorage.getItem('achtung-offline-patterns');
 if (cached) {
 offlinePatterns = JSON.parse(cached);
 }
 }
 }

 // Offline analysis using cached patterns (fallback when API unavailable)
 function analyzeOffline(text) {
 if (!offlinePatterns?.patterns) {
 return { error: 'No offline patterns available' };
 }

 const categories = [];
 const patterns = offlinePatterns.patterns;

 for (const [type, config] of Object.entries(patterns)) {
 try {
 const regex = new RegExp(config.regex, config.flags || 'gi');
 const matches = text.match(regex);
 if (matches) {
 matches.forEach(match => {
 categories.push({
 type,
 severity: config.severity || 'medium',
 match,
 message: config.message || 'Sensitive data detected',
 position: {
 start: text.indexOf(match),
 end: text.indexOf(match) + match.length
 }
 });
 });
 }
 } catch (e) {
 // Skip invalid regex
 }
 }

 const riskScore = calculateRiskScore(categories);

 return {
 riskScore,
 riskLevel: getRiskLevel(riskScore),
 categories,
 summary: `${categories.length} potential risks detected (offline)`,
 meta: {
 mode: 'offline',
 patternsUsed: Object.keys(patterns).length
 }
 };
 }

 // Quick ping to check if API is reachable
 async function pingApi() {
 try {
 const controller = new AbortController();
 const timeoutId = setTimeout(() => controller.abort(), 3000);

 const response = await fetch(API_PING_URL, {
 method: 'GET',
 signal: controller.signal
 });

 clearTimeout(timeoutId);
 return response.ok;
 } catch (error) {
 return false;
 }
 }

 // ========================================
 // Phase 5: Predictive Privacy
 // ========================================

 const API_PREDICTIVE_URL = `${API_BASE}/analyze-predictive`;
 const API_BREACH_SCENARIOS_URL = `${API_BASE}/breach-scenarios`;
 let selectedTimeHorizon = 1;

 // Risk factors for client-side calculation (fallback)
 const RISK_FACTORS = {
 name: { uniqueness: 0.15, label: 'Vorname', icon: '' },
 full_name: { uniqueness: 0.95, label: 'Vollst√§ndiger Name', icon: '' },
 email: { uniqueness: 0.99, label: 'E-Mail', icon: '' },
 phone: { uniqueness: 0.98, label: 'Telefonnummer', icon: '' },
 age: { uniqueness: 0.02, label: 'Alter', icon: '' },
 birth_date: { uniqueness: 0.60, label: 'Geburtsdatum', icon: '' },
 city_small: { uniqueness: 0.70, label: 'Kleinstadt', icon: '' },
 city_large: { uniqueness: 0.20, label: 'Gro√üstadt', icon: '' },
 address: { uniqueness: 0.98, label: 'Adresse', icon: '' },
 plz: { uniqueness: 0.40, label: 'Postleitzahl', icon: '' },
 profession: { uniqueness: 0.30, label: 'Beruf', icon: '' },
 profession_specific: { uniqueness: 0.75, label: 'Spezifischer Beruf', icon: '' },
 employer: { uniqueness: 0.90, label: 'Arbeitgeber', icon: '' },
 routine: { uniqueness: 0.60, label: 'Routine/Gewohnheit', icon: '' },
 political: { uniqueness: 0.20, futureMultiplier: 3.0, label: 'Politische Meinung', icon: '' },
 health: { uniqueness: 0.40, futureMultiplier: 2.8, label: 'Gesundheitsdaten', icon: '' },
 financial: { uniqueness: 0.50, futureMultiplier: 2.0, label: 'Finanzdaten', icon: '' },
 iban: { uniqueness: 0.99, label: 'IBAN', icon: '' },
 credit_card: { uniqueness: 0.99, label: 'Kreditkarte', icon: '' }
 };

 // Breach scenario templates
 const BREACH_SCENARIOS = [
 {
 id: 'social_media_leak',
 icon: '',
 name: 'Social Media Leak',
 description: 'Eine Social-Media-Plattform wird gehackt',
 affectedTypes: ['name', 'full_name', 'email', 'city_small', 'city_large', 'profession', 'political'],
 examples: ['Facebook 2019 (533M)', 'LinkedIn 2021 (700M)']
 },
 {
 id: 'email_breach',
 icon: '',
 name: 'E-Mail Provider Hack',
 description: 'Ihr E-Mail-Anbieter wird kompromittiert',
 affectedTypes: ['email', 'name', 'full_name', 'address'],
 examples: ['Yahoo 2013 (3B)', 'Collection #1 2019 (773M)']
 },
 {
 id: 'health_data_leak',
 icon: '',
 name: 'Gesundheitsdaten-Leak',
 description: 'Gesundheitsdienstleister wird gehackt',
 affectedTypes: ['health', 'name', 'full_name', 'birth_date', 'address'],
 examples: ['Anthem 2015 (78M)', 'Medibank 2022 (9.7M)']
 },
 {
 id: 'financial_breach',
 icon: '',
 name: 'Finanzdaten-Leak',
 description: 'Bank oder Payment-Provider gehackt',
 affectedTypes: ['iban', 'credit_card', 'financial', 'name', 'full_name', 'address'],
 examples: ['Equifax 2017 (147M)', 'Capital One 2019 (100M)']
 },
 {
 id: 'employer_breach',
 icon: '',
 name: 'Arbeitgeber-Datenleck',
 description: 'HR-System Ihres Arbeitgebers gehackt',
 affectedTypes: ['employer', 'profession', 'name', 'full_name', 'email', 'address', 'financial'],
 examples: ['Sony 2014 (47K)', 'Uber 2016 (57M)']
 },
 {
 id: 'government_leak',
 icon: '',
 name: 'Beh√∂rden-Datenleck',
 description: 'Beh√∂rdliche Datenbank kompromittiert',
 affectedTypes: ['name', 'full_name', 'birth_date', 'address', 'plz'],
 examples: ['OPM 2015 (21.5M)', 'Bulgaria NRA 2019 (5M)']
 }
 ];

 // Correlation attack methods
 const CORRELATION_METHODS = [
 {
 id: 'linkedin_search',
 name: 'LinkedIn + Ort',
 dataNeeded: ['profession', 'city_small', 'employer'],
 difficulty: 'easy',
 icon: ''
 },
 {
 id: 'google_dorking',
 name: 'Google Dorking',
 dataNeeded: ['name', 'profession', 'employer'],
 difficulty: 'easy',
 icon: ''
 },
 {
 id: 'reverse_image',
 name: 'Reverse Image Search',
 dataNeeded: ['name'],
 difficulty: 'medium',
 icon: ''
 },
 {
 id: 'social_graph',
 name: 'Social Graph Analysis',
 dataNeeded: ['name', 'city_small', 'routine'],
 difficulty: 'medium',
 icon: ''
 },
 {
 id: 'public_records',
 name: '√ñffentliche Register',
 dataNeeded: ['full_name', 'address', 'employer'],
 difficulty: 'easy',
 icon: ''
 }
 ];

 function initPredictivePrivacy() {
 const form = document.getElementById('predictiveForm');
 if (!form) return;

 // Time horizon button handlers
 document.querySelectorAll('.time-btn').forEach(btn => {
 btn.addEventListener('click', function() {
 document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
 this.classList.add('active');
 selectedTimeHorizon = parseInt(this.dataset.years);
 });
 });

 // Form submission
 form.addEventListener('submit', async function(e) {
 e.preventDefault();
 await runPredictiveAnalysis();
 });
 }

 async function runPredictiveAnalysis() {
 const text = document.getElementById('predictiveText').value.trim();
 if (!text) return;

 const options = {
 deanonymization: document.getElementById('optDeanon').checked,
 breachSimulation: document.getElementById('optBreach').checked,
 futureRisk: document.getElementById('optFuture').checked,
 correlationAttack: document.getElementById('optCorrelation').checked,
 timeHorizons: [1, 5, 10]
 };

 const submitBtn = document.getElementById('predictiveSubmitBtn');
 const btnText = submitBtn.querySelector('.btn-text');
 const btnLoading = submitBtn.querySelector('.btn-loading');

 btnText.style.display = 'none';
 btnLoading.style.display = 'inline';
 submitBtn.disabled = true;

 try {
 // Try API first
 let result;
 try {
 const response = await fetch(API_PREDICTIVE_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ text, lang: currentLang, options })
 });
 if (response.ok) {
 result = await response.json();
 } else {
 throw new Error('API not available');
 }
 } catch (apiError) {
 // Fallback to client-side analysis
 console.log('[Predictive] Using client-side analysis');
 result = performClientSidePredictiveAnalysis(text, options);
 }

 displayPredictiveResults(result, options);
 } catch (error) {
 console.error('[Predictive] Error:', error);
 alert('Fehler bei der Analyse: ' + error.message);
 } finally {
 btnText.style.display = 'inline';
 btnLoading.style.display = 'none';
 submitBtn.disabled = false;
 }
 }

 // Client-side predictive analysis (fallback when API unavailable)
 function performClientSidePredictiveAnalysis(text, options) {
 const dataPoints = detectDataPoints(text);
 const deanon = calculateDeanonymization(dataPoints);
 const breach = simulateBreaches(dataPoints);
 const future = calculateFutureRisk(dataPoints, deanon.identifiabilityScore);
 const correlation = analyzeCorrelationAttacks(dataPoints);

 return {
 success: true,
 data: {
 predictive: {
 deanonymization: deanon,
 breachSimulation: breach,
 futureRisk: future,
 correlationAttack: correlation
 },
 summary: generateSummary(deanon, breach, future, correlation)
 },
 meta: { mode: 'client-side', version: '5.0.0' }
 };
 }

 // Detect data points in text
 function detectDataPoints(text) {
 const dataPoints = [];
 const textLower = text.toLowerCase();

 // Name patterns
 const nameMatch = text.match(/(?:ich bin|mein name ist|hei√üe)\s+([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)/i);
 if (nameMatch) {
 dataPoints.push({ type: 'name', value: nameMatch[1], ...RISK_FACTORS.name });
 }

 // Full name (First + Last)
 const fullNameMatch = text.match(/([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)\s+([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+)(?=\s|,|\.)/);
 if (fullNameMatch && fullNameMatch[1].length > 2 && fullNameMatch[2].length > 2) {
 dataPoints.push({ type: 'full_name', value: `${fullNameMatch[1]} ${fullNameMatch[2]}`, ...RISK_FACTORS.full_name });
 }

 // Age
 const ageMatch = text.match(/(\d{1,2})\s*(?:jahre?\s*alt|j\.?\s*a\.?|years?\s*old)/i) ||
 text.match(/(?:bin|ich bin)\s*(\d{2})/i);
 if (ageMatch) {
 dataPoints.push({ type: 'age', value: ageMatch[1], ...RISK_FACTORS.age });
 }

 // Email
 const emailMatch = text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/);
 if (emailMatch) {
 dataPoints.push({ type: 'email', value: emailMatch[0], ...RISK_FACTORS.email });
 }

 // Phone
 const phoneMatch = text.match(/(?:\+49|0049|0)\s*\d{2,4}[\s\-\/]?\d{3,}[\s\-\/]?\d{2,}/);
 if (phoneMatch) {
 dataPoints.push({ type: 'phone', value: phoneMatch[0], ...RISK_FACTORS.phone });
 }

 // Location (small town indicators)
 const smallTownPatterns = [
 /(?:in|aus|bei|wohne in)\s+([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]+(?:dorf|hausen|heim|berg|feld|bach|kirchen|hofen|ingen|burg))/i,
 /(?:in|aus)\s+([A-Z√Ñ√ñ√ú][a-z√§√∂√º√ü]{3,12})(?:\s|,|\.)/i
 ];
 for (const pattern of smallTownPatterns) {
 const match = text.match(pattern);
 if (match) {
 const town = match[1];
 // Check if it's a small town (heuristic: not a major city)
 const majorCities = ['berlin', 'hamburg', 'm√ºnchen', 'k√∂ln', 'frankfurt', 'stuttgart', 'd√ºsseldorf', 'wien', 'z√ºrich'];
 if (!majorCities.includes(town.toLowerCase())) {
 dataPoints.push({ type: 'city_small', value: town, ...RISK_FACTORS.city_small });
 } else {
 dataPoints.push({ type: 'city_large', value: town, ...RISK_FACTORS.city_large });
 }
 break;
 }
 }

 // Profession
 const professionPatterns = [
 /(?:arbeite als|bin|beruf(?:lich)?:?)\s+(?:der\s+|die\s+)?([A-Z√Ñ√ñ√úa-z√§√∂√º√ü\-]+(?:er|in|ist|ant|ent)?)/i,
 /(?:lehrer|arzt|√§rztin|anwalt|anw√§ltin|ingenieur|programmierer|entwickler|manager|chef|direktor)/i
 ];
 for (const pattern of professionPatterns) {
 const match = text.match(pattern);
 if (match) {
 const profession = match[1] || match[0];
 dataPoints.push({ type: 'profession', value: profession, ...RISK_FACTORS.profession });
 break;
 }
 }

 // Employer
 const employerMatch = text.match(/(?:bei|f√ºr|arbeite bei)\s+(?:der\s+|die\s+)?([A-Z√Ñ√ñ√ú][A-Za-z√§√∂√º√ü\s&\.]+(?:AG|GmbH|SE|Inc|Ltd|UG)?)/i);
 if (employerMatch) {
 dataPoints.push({ type: 'employer', value: employerMatch[1].trim(), ...RISK_FACTORS.employer });
 }

 // Routine/Schedule
 const routineMatch = text.match(/(?:jeden|immer)\s+(?:montag|dienstag|mittwoch|donnerstag|freitag|samstag|sonntag|tag|morgen|abend)/i);
 if (routineMatch) {
 dataPoints.push({ type: 'routine', value: routineMatch[0], ...RISK_FACTORS.routine });
 }

 // IBAN
 const ibanMatch = text.match(/[A-Z]{2}\d{2}[\s]?(?:\d{4}[\s]?){4,5}\d{0,2}/i);
 if (ibanMatch) {
 dataPoints.push({ type: 'iban', value: '[IBAN]', ...RISK_FACTORS.iban });
 }

 // Health
 if (textLower.match(/(?:diagnose|diabetes|krebs|depression|medikament|arzt|kranken|operation|therapie)/)) {
 dataPoints.push({ type: 'health', value: '[Gesundheitsdaten]', ...RISK_FACTORS.health });
 }

 // Political
 if (textLower.match(/(?:w√§hle|unterst√ºtze|partei|afd|cdu|spd|gr√ºne|linke|fdp|politisch)/)) {
 dataPoints.push({ type: 'political', value: '[Politische Meinung]', ...RISK_FACTORS.political });
 }

 return dataPoints;
 }

 // Calculate deanonymization risk
 function calculateDeanonymization(dataPoints) {
 if (dataPoints.length === 0) {
 return {
 kAnonymity: 1000,
 identifiabilityScore: 0.05,
 uniqueDataPoints: [],
 combinedRisk: {
 score: 0.05,
 explanation: 'Keine identifizierenden Datenpunkte gefunden.',
 dataPointsNeeded: 3,
 recommendation: 'Text ist relativ anonym.'
 }
 };
 }

 // Calculate combined risk
 let combinedAnonymity = 1.0;
 for (const dp of dataPoints) {
 combinedAnonymity *= (1 - dp.uniqueness);
 }

 // Bonus for specific combinations
 const hasNameAndLocation = dataPoints.some(d => d.type.includes('name')) &&
 dataPoints.some(d => d.type.includes('city'));
 const hasProfessionAndLocation = dataPoints.some(d => d.type === 'profession') &&
 dataPoints.some(d => d.type === 'city_small');

 if (hasNameAndLocation) combinedAnonymity *= 0.85;
 if (hasProfessionAndLocation) combinedAnonymity *= 0.80;
 if (dataPoints.length >= 3) combinedAnonymity *= 0.75;

 const identifiabilityScore = 1 - combinedAnonymity;

 // Estimate k-anonymity
 let kAnonymity;
 if (identifiabilityScore > 0.95) kAnonymity = 1;
 else if (identifiabilityScore > 0.90) kAnonymity = 2;
 else if (identifiabilityScore > 0.80) kAnonymity = 5;
 else if (identifiabilityScore > 0.60) kAnonymity = 20;
 else if (identifiabilityScore > 0.40) kAnonymity = 100;
 else kAnonymity = 1000;

 // Generate recommendation
 let recommendation = '';
 if (identifiabilityScore > 0.8) {
 const weakest = dataPoints.sort((a, b) => b.uniqueness - a.uniqueness)[0];
 recommendation = `Entferne oder generalisiere "${weakest.value}" f√ºr mehr Anonymit√§t.`;
 } else if (identifiabilityScore > 0.5) {
 recommendation = 'Vermeide weitere identifizierende Details.';
 } else {
 recommendation = 'Gute Anonymit√§t - achte auf weitere Datenpunkte.';
 }

 return {
 kAnonymity,
 identifiabilityScore,
 uniqueDataPoints: dataPoints.map(dp => ({
 type: dp.type,
 value: dp.value,
 uniqueness: dp.uniqueness,
 icon: dp.icon,
 label: dp.label,
 note: dp.uniqueness > 0.7 ? 'Hohe Identifikationskraft!' :
 dp.uniqueness > 0.4 ? 'Mittelhohe Identifikationskraft' : 'Geringe Identifikationskraft'
 })),
 combinedRisk: {
 score: identifiabilityScore,
 explanation: `${dataPoints.length} Datenpunkte ergeben ${Math.round(identifiabilityScore * 100)}% Identifizierbarkeit.`,
 dataPointsNeeded: Math.max(0, 3 - dataPoints.length),
 recommendation
 }
 };
 }

 // Simulate breach scenarios
 function simulateBreaches(dataPoints) {
 const dataTypes = dataPoints.map(dp => dp.type);
 const scenarios = [];

 for (const scenario of BREACH_SCENARIOS) {
 const affectedData = scenario.affectedTypes.filter(t => dataTypes.includes(t));
 if (affectedData.length === 0) continue;

 const damage = Math.min(10, Math.round(affectedData.length * 2 + Math.random() * 2));
 const probability = affectedData.length >= 2 ? 'high' : 'medium';

 scenarios.push({
 type: scenario.id,
 icon: scenario.icon,
 name: scenario.name,
 description: scenario.description,
 probability,
 affectedData: affectedData.map(t => RISK_FACTORS[t]?.label || t),
 potentialDamage: damage,
 consequences: generateConsequences(scenario.id, affectedData),
 mitigation: generateMitigation(scenario.id, affectedData),
 examples: scenario.examples
 });
 }

 // Sort by damage
 scenarios.sort((a, b) => b.potentialDamage - a.potentialDamage);

 const overallScore = scenarios.length > 0
 ? Math.min(1, scenarios.reduce((sum, s) => sum + s.potentialDamage, 0) / (scenarios.length * 10))
 : 0;

 return {
 scenarios: scenarios.slice(0, 4), // Top 4
 overallBreachRisk: {
 score: overallScore,
 worstCase: scenarios[0]?.name || 'Kein signifikantes Breach-Risiko'
 }
 };
 }

 function generateConsequences(scenarioId, affectedData) {
 const consequences = [];
 if (affectedData.includes('full_name') || affectedData.includes('name')) {
 consequences.push('Identit√§t kann mit anderen Profilen verkn√ºpft werden');
 }
 if (affectedData.includes('email')) {
 consequences.push('Phishing-Angriffe werden wahrscheinlicher');
 }
 if (affectedData.includes('address') || affectedData.includes('city_small')) {
 consequences.push('Physischer Standort wird kompromittiert');
 }
 if (affectedData.includes('employer')) {
 consequences.push('Berufliche Reputation gef√§hrdet');
 }
 if (affectedData.includes('health')) {
 consequences.push('Sensible Gesundheitsdaten √∂ffentlich');
 }
 if (consequences.length === 0) {
 consequences.push('Teilweise Identifizierung m√∂glich');
 }
 return consequences;
 }

 function generateMitigation(scenarioId, affectedData) {
 const mitigations = [];
 if (affectedData.includes('email')) {
 mitigations.push('Separate E-Mail f√ºr √∂ffentliche Dienste nutzen');
 }
 if (affectedData.includes('city_small')) {
 mitigations.push('Nur Region statt genauem Ort nennen');
 }
 if (affectedData.includes('employer')) {
 mitigations.push('Arbeitgeber nicht √∂ffentlich nennen');
 }
 if (mitigations.length === 0) {
 mitigations.push('Weniger pers√∂nliche Details teilen');
 }
 return mitigations;
 }

 // Calculate future risk
 function calculateFutureRisk(dataPoints, currentScore) {
 const multipliers = { 1: 1.2, 5: 1.8, 10: 2.5 };
 const timeline = [];

 for (const [years, baseMultiplier] of Object.entries(multipliers)) {
 let multiplier = baseMultiplier;

 // Adjust for sensitive data types
 for (const dp of dataPoints) {
 if (dp.futureMultiplier) {
 multiplier *= (1 + (dp.futureMultiplier - 1) * 0.2);
 }
 }

 const projectedScore = Math.min(200, Math.round(currentScore * 100 * multiplier));
 const newThreats = generateFutureThreats(parseInt(years), dataPoints);

 timeline.push({
 years: parseInt(years),
 riskMultiplier: multiplier,
 projectedScore,
 newThreats
 });
 }

 const permanentRisks = dataPoints
 .filter(dp => dp.type === 'political' || dp.type === 'health' || dp.type === 'profession')
 .map(dp => ({
 dataType: dp.type,
 risk: dp.type === 'political' ? 'Karriere/Visa' :
 dp.type === 'health' ? 'Versicherung' : 'Reputation',
 description: `Diese Information bleibt dauerhaft mit Ihnen verkn√ºpft`,
 icon: dp.icon
 }));

 return { timeline, permanentRisks };
 }

 function generateFutureThreats(years, dataPoints) {
 const threats = [];
 if (years >= 1) {
 threats.push('Mehr korrelierbare Daten im Internet');
 if (dataPoints.some(d => d.type === 'name')) {
 threats.push('Reverse Image Search wird besser');
 }
 }
 if (years >= 5) {
 threats.push('KI kann Schreibstil eindeutig zuordnen');
 if (dataPoints.some(d => d.type.includes('city'))) {
 threats.push('Aggregierte Standortdaten pr√§ziser');
 }
 }
 if (years >= 10) {
 threats.push('Quantencomputer-Risiko f√ºr alte Verschl√ºsselung');
 threats.push('Langzeit-Bewegungsprofile m√∂glich');
 }
 return threats;
 }

 // Analyze correlation attacks
 function analyzeCorrelationAttacks(dataPoints) {
 const dataTypes = dataPoints.map(dp => dp.type);
 const possibleCorrelations = [];

 for (const method of CORRELATION_METHODS) {
 const matchingData = method.dataNeeded.filter(t => dataTypes.includes(t));
 if (matchingData.length === 0) continue;

 const confidence = Math.min(0.95, matchingData.length / method.dataNeeded.length + 0.1);

 possibleCorrelations.push({
 method: method.name,
 icon: method.icon,
 confidence,
 steps: generateCorrelationSteps(method, dataPoints),
 difficulty: method.difficulty
 });
 }

 // Sort by confidence
 possibleCorrelations.sort((a, b) => b.confidence - a.confidence);

 const attackScore = possibleCorrelations.length > 0
 ? possibleCorrelations[0].confidence
 : 0;

 const weakestLink = dataPoints.length > 0
 ? dataPoints.sort((a, b) => b.uniqueness - a.uniqueness)[0]
 : null;

 return {
 possibleCorrelations: possibleCorrelations.slice(0, 3),
 attackSurface: {
 score: attackScore,
 weakestLink: weakestLink ? `${weakestLink.label}: "${weakestLink.value}"` : 'Keine',
 recommendation: weakestLink && weakestLink.uniqueness > 0.5
 ? `Entferne oder generalisiere "${weakestLink.value}"`
 : 'Gute Resistenz gegen Korrelationsangriffe'
 }
 };
 }

 function generateCorrelationSteps(method, dataPoints) {
 const steps = [];
 if (method.id === 'linkedin_search') {
 const profession = dataPoints.find(d => d.type === 'profession');
 const city = dataPoints.find(d => d.type.includes('city'));
 if (profession) steps.push(`LinkedIn-Suche: "${profession.value}"`);
 if (city) steps.push(`Filter nach Ort: "${city.value}"`);
 steps.push('Profilabgleich mit anderen Datenpunkten');
 } else if (method.id === 'google_dorking') {
 steps.push('Google-Suche mit Operatoren');
 steps.push('Verkn√ºpfung √∂ffentlicher Informationen');
 } else {
 steps.push('Datensammlung aus √∂ffentlichen Quellen');
 steps.push('Musterabgleich und Verkn√ºpfung');
 }
 return steps;
 }

 // Generate summary
 function generateSummary(deanon, breach, future, correlation) {
 let currentRisk = 'low';
 let futureRisk = 'low';

 if (deanon.identifiabilityScore > 0.8) currentRisk = 'critical';
 else if (deanon.identifiabilityScore > 0.6) currentRisk = 'high';
 else if (deanon.identifiabilityScore > 0.3) currentRisk = 'medium';

 const maxFutureScore = Math.max(...future.timeline.map(t => t.projectedScore));
 if (maxFutureScore > 150) futureRisk = 'critical';
 else if (maxFutureScore > 100) futureRisk = 'high';
 else if (maxFutureScore > 50) futureRisk = 'medium';

 const mainVulnerability = deanon.uniqueDataPoints.length > 0
 ? deanon.uniqueDataPoints.sort((a, b) => b.uniqueness - a.uniqueness)[0]
 : null;

 return {
 currentRisk,
 futureRisk,
 mainVulnerability: mainVulnerability
 ? `${mainVulnerability.label}: "${mainVulnerability.value}"`
 : 'Keine kritischen Datenpunkte',
 quickFix: deanon.combinedRisk.recommendation,
 privacyLifespan: deanon.identifiabilityScore > 0.5
 ? 'Diese Daten bleiben ~15-20 Jahre auffindbar'
 : 'Geringe Langzeit-Auffindbarkeit'
 };
 }

 // Display predictive results
 function displayPredictiveResults(result, options) {
 const resultsDiv = document.getElementById('predictiveResults');
 resultsDiv.style.display = 'block';

 // Handle both API response (predictiveAnalysis) and client-side (predictive)
 const data = result.predictiveAnalysis || result.data?.predictive || result.predictive;
 const standardAnalysis = result.standardAnalysis || result.data?.standardAnalysis;

 // Build summary from API response or use client-side summary
 let summary = result.data?.summary || result.summary;
 if (!summary && data?.overallAssessment) {
 // Build summary from API overallAssessment
 summary = {
 currentRisk: data.overallAssessment.level || 'medium',
 futureRisk: data.futureRisk?.timeline?.[data.futureRisk?.timeline?.length - 1]?.riskLevel || data.overallAssessment.level || 'medium',
 mainVulnerability: data.deanonymization?.contributingFactors?.[0]?.type || 'Nicht ermittelt',
 quickFix: data.overallAssessment.recommendations?.[0] || 'Weniger pers√∂nliche Details teilen.',
 privacyLifespan: data.deanonymization?.risk > 0.5 ? 'Diese Daten bleiben ~15-20 Jahre auffindbar' : 'Geringe Langzeit-Auffindbarkeit'
 };
 }

 // Summary Card
 displaySummary(summary);

 // Deanonymization Section - map API format to display format
 if (options.deanonymization && data?.deanonymization) {
 const deanonData = mapDeanonymizationData(data.deanonymization);
 displayDeanonymization(deanonData);
 document.getElementById('deanonSection').style.display = 'block';
 } else {
 document.getElementById('deanonSection').style.display = 'none';
 }

 // Breach Simulation Section - map API format
 if (options.breachSimulation && data?.breachSimulation) {
 const breachData = mapBreachSimulationData(data.breachSimulation);
 displayBreachSimulation(breachData);
 document.getElementById('breachSection').style.display = 'block';
 } else {
 document.getElementById('breachSection').style.display = 'none';
 }

 // Future Risk Section
 if (options.futureRisk && data?.futureRisk) {
 const futureData = mapFutureRiskData(data.futureRisk);
 displayFutureRisk(futureData);
 document.getElementById('futureSection').style.display = 'block';
 } else {
 document.getElementById('futureSection').style.display = 'none';
 }

 // Correlation Section - map API format (correlationRisk -> correlationAttack)
 const correlationData = data?.correlationRisk || data?.correlationAttack;
 if (options.correlationAttack && correlationData) {
 const mappedCorrelation = mapCorrelationData(correlationData);
 displayCorrelationAttack(mappedCorrelation);
 document.getElementById('correlationSection').style.display = 'block';
 } else {
 document.getElementById('correlationSection').style.display = 'none';
 }

 // Privacy Lifespan
 if (summary?.privacyLifespan) {
 document.getElementById('lifespanText').textContent = summary.privacyLifespan;
 document.getElementById('privacyLifespan').style.display = 'flex';
 }

 // Scroll to results
 resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
 }

 // Map API deanonymization response to display format
 function mapDeanonymizationData(apiData) {
 // If already in display format (client-side), return as-is
 if (apiData.uniqueDataPoints) return apiData;

 // Map from API format
 return {
 kAnonymity: apiData.kAnonymity || Math.round(1 / Math.max(0.01, apiData.risk || 0.5)),
 identifiabilityScore: apiData.risk || 0.5,
 uniqueDataPoints: (apiData.contributingFactors || []).map(f => ({
 type: f.type || f.dataType,
 value: f.value || f.matchedValue || '[Erkannt]',
 uniqueness: f.uniquenessScore || f.uniqueness || 0.5,
 icon: RISK_FACTORS[f.type]?.icon || '',
 label: RISK_FACTORS[f.type]?.label || f.type,
 note: f.uniquenessScore > 0.7 ? 'Hohe Identifikationskraft!' :
 f.uniquenessScore > 0.4 ? 'Mittelhohe Identifikationskraft' : 'Geringe Identifikationskraft'
 })),
 combinedRisk: {
 score: apiData.risk || 0.5,
 explanation: `${(apiData.contributingFactors || []).length} Datenpunkte ergeben ${Math.round((apiData.risk || 0.5) * 100)}% Identifizierbarkeit.`,
 dataPointsNeeded: Math.max(0, 3 - (apiData.contributingFactors || []).length),
 recommendation: apiData.recommendation || 'Weniger pers√∂nliche Details teilen.'
 }
 };
 }

 // Map API breach simulation response to display format
 function mapBreachSimulationData(apiData) {
 // If already in display format (client-side), return as-is
 if (apiData.scenarios) return apiData;

 // Map from API format
 const scenarios = (apiData.applicableScenarios || []).map(s => ({
 type: s.id || s.type,
 icon: s.icon || BREACH_SCENARIOS.find(b => b.id === s.id)?.icon || '',
 name: s.name || s.id,
 description: s.description || '',
 probability: s.adjustedProbability > 0.6 ? 'high' : s.adjustedProbability > 0.3 ? 'medium' : 'low',
 affectedData: s.affectedData || s.affectedTypes || [],
 potentialDamage: Math.round((s.adjustedProbability || 0.5) * 10),
 consequences: s.consequences || s.potentialConsequences || [],
 mitigation: s.mitigation || s.mitigations || [],
 examples: s.realWorldExamples || s.examples || []
 }));

 return {
 scenarios: scenarios.slice(0, 4),
 overallBreachRisk: {
 score: apiData.overallRisk || 0.5,
 worstCase: scenarios[0]?.name || 'Kein signifikantes Breach-Risiko'
 }
 };
 }

 // Map API future risk response to display format
 function mapFutureRiskData(apiData) {
 // If already in display format (client-side), return as-is
 if (apiData.timeline && apiData.timeline[0]?.newThreats) return apiData;

 // Map from API format
 const timeline = (apiData.timeline || []).map(t => ({
 years: t.period === 'immediate' ? 0 : t.period === '1_year' ? 1 : t.period === '5_years' ? 5 : 10,
 riskMultiplier: t.riskMultiplier || 1.0,
 projectedScore: Math.round((t.riskScore || t.projectedRisk || 50) * 100 / (t.riskMultiplier || 1)),
 newThreats: t.threats || t.newThreats || ['Risiko steigt mit der Zeit']
 }));

 // Ensure we have entries for 1, 5, 10 years
 const timelineMap = { 1: null, 5: null, 10: null };
 timeline.forEach(t => {
 if (t.years in timelineMap) timelineMap[t.years] = t;
 });

 const normalizedTimeline = [1, 5, 10].map(y => timelineMap[y] || {
 years: y,
 riskMultiplier: y === 1 ? 1.2 : y === 5 ? 1.8 : 2.5,
 projectedScore: 50 * (y === 1 ? 1.2 : y === 5 ? 1.8 : 2.5),
 newThreats: ['Zunehmende Datenkorrelation m√∂glich']
 });

 return {
 timeline: normalizedTimeline,
 permanentRisks: apiData.dataDecay?.permanentRisks || apiData.permanentRisks || []
 };
 }

 // Map API correlation response to display format
 function mapCorrelationData(apiData) {
 // If already in display format (client-side), return as-is
 if (apiData.possibleCorrelations) return apiData;

 // Map from API format
 const possibleCorrelations = (apiData.possibleAttacks || []).map(a => ({
 method: a.name || a.method,
 icon: a.icon || CORRELATION_METHODS.find(m => m.id === a.id)?.icon || '',
 confidence: a.confidence || a.successProbability || 0.5,
 steps: a.steps || a.attackSteps || ['Datensammlung', 'Korrelationsanalyse'],
 difficulty: a.difficulty || 'medium'
 }));

 return {
 possibleCorrelations: possibleCorrelations.slice(0, 3),
 attackSurface: {
 score: apiData.risk || apiData.overallRisk || 0.5,
 weakestLink: apiData.weakestLink || possibleCorrelations[0]?.method || 'Nicht ermittelt',
 recommendation: apiData.recommendation || 'Weniger verkn√ºpfbare Daten teilen.'
 }
 };
 }

 function displaySummary(summary) {
 if (!summary) return;

 const riskColors = {
 low: '#4caf50',
 medium: '#ff9800',
 high: '#f44336',
 critical: '#9c27b0'
 };

 const riskLabels = {
 low: 'Niedriges Risiko',
 medium: 'Mittleres Risiko',
 high: 'Hohes Risiko',
 critical: 'Kritisches Risiko'
 };

 document.getElementById('summaryRiskBadge').innerHTML = `
 <span class="risk-badge" style="background: ${riskColors[summary.currentRisk]}">
 Aktuell: ${riskLabels[summary.currentRisk]}
 </span>
 <span class="risk-badge" style="background: ${riskColors[summary.futureRisk]}">
 Zukunft: ${riskLabels[summary.futureRisk]}
 </span>
 `;
 document.getElementById('summaryText').innerHTML = `
 <strong>Hauptschwachstelle:</strong> ${summary.mainVulnerability}
 `;
 document.getElementById('summaryQuickFix').innerHTML = `
 <strong> Quick Fix:</strong> ${summary.quickFix}
 `;
 }

 function displayDeanonymization(deanon) {
 // k-Anonymity Gauge
 const kValue = document.getElementById('kAnonValue');
 const kFill = document.getElementById('kAnonFill');
 const kExplanation = document.getElementById('kAnonExplanation');

 kValue.textContent = `k=${deanon.kAnonymity}`;

 // Calculate fill percentage (inverse - lower k = more fill/danger)
 const fillPercent = deanon.kAnonymity <= 1 ? 100 :
 deanon.kAnonymity <= 5 ? 80 :
 deanon.kAnonymity <= 20 ? 60 :
 deanon.kAnonymity <= 100 ? 40 : 20;

 const circumference = 2 * Math.PI * 45;
 const offset = circumference - (fillPercent / 100 * circumference);
 kFill.style.strokeDasharray = circumference;
 kFill.style.strokeDashoffset = offset;

 // Color based on risk
 const color = deanon.kAnonymity <= 2 ? '#f44336' :
 deanon.kAnonymity <= 10 ? '#ff9800' :
 deanon.kAnonymity <= 50 ? '#ffeb3b' : '#4caf50';
 kFill.style.stroke = color;

 kExplanation.innerHTML = deanon.kAnonymity <= 2
 ? ' <strong>Sehr identifizierbar!</strong> Du bist eine von nur ~' + deanon.kAnonymity + ' Personen mit diesen Merkmalen.'
 : deanon.kAnonymity <= 20
 ? ' <strong>M√§√üig identifizierbar.</strong> Du bist eine von ~' + deanon.kAnonymity + ' Personen.'
 : ' <strong>Gute Anonymit√§t.</strong> Schwer eindeutig zu identifizieren.';

 // Data Points List
 const dpList = document.getElementById('datapointsList');
 dpList.innerHTML = deanon.uniqueDataPoints.map(dp => `
 <div class="datapoint-item" style="border-left: 4px solid ${dp.uniqueness > 0.7 ? '#f44336' : dp.uniqueness > 0.4 ? '#ff9800' : '#4caf50'}">
 <span class="dp-icon">${dp.icon || ''}</span>
 <span class="dp-label">${dp.label || dp.type}</span>
 <span class="dp-value">"${dp.value}"</span>
 <span class="dp-uniqueness">${Math.round(dp.uniqueness * 100)}%</span>
 <span class="dp-note">${dp.note}</span>
 </div>
 `).join('');

 // Combined Risk
 document.getElementById('combinedRiskScore').textContent =
 Math.round(deanon.combinedRisk.score * 100) + '%';
 document.getElementById('combinedRiskExplanation').textContent =
 deanon.combinedRisk.explanation;
 document.getElementById('combinedRiskRecommendation').innerHTML =
 ` ${deanon.combinedRisk.recommendation}`;
 }

 function displayBreachSimulation(breach) {
 const scenariosDiv = document.getElementById('breachScenarios');

 scenariosDiv.innerHTML = breach.scenarios.map(s => `
 <div class="breach-scenario-card">
 <div class="breach-header">
 <span class="breach-icon">${s.icon}</span>
 <span class="breach-name">${s.name}</span>
 <span class="breach-probability probability-${s.probability}">${s.probability}</span>
 </div>
 <div class="breach-description">${s.description}</div>
 <div class="breach-affected">
 <strong>Betroffene Daten:</strong> ${s.affectedData.join(', ')}
 </div>
 <div class="breach-damage">
 <span class="damage-label">Schadenspotenzial:</span>
 <div class="damage-bar">
 <div class="damage-fill" style="width: ${s.potentialDamage * 10}%; background: ${s.potentialDamage > 7 ? '#f44336' : s.potentialDamage > 4 ? '#ff9800' : '#4caf50'}"></div>
 </div>
 <span class="damage-value">${s.potentialDamage}/10</span>
 </div>
 <div class="breach-consequences">
 <strong>M√∂gliche Folgen:</strong>
 <ul>${s.consequences.map(c => `<li>${c}</li>`).join('')}</ul>
 </div>
 <div class="breach-examples">
 <em>Echte Beispiele: ${s.examples.join(', ')}</em>
 </div>
 </div>
 `).join('');

 // Overall risk
 const overallScore = breach.overallBreachRisk.score;
 document.getElementById('breachOverallScore').innerHTML = `
 <span class="overall-label">Gesamt-Breach-Risiko:</span>
 <span class="overall-value" style="color: ${overallScore > 0.7 ? '#f44336' : overallScore > 0.4 ? '#ff9800' : '#4caf50'}">
 ${Math.round(overallScore * 100)}%
 </span>
 `;
 document.getElementById('breachWorstCase').innerHTML = `
 <strong>Worst Case:</strong> ${breach.overallBreachRisk.worstCase}
 `;
 }

 function displayFutureRisk(future) {
 // Timeline scores
 document.getElementById('scoreNow').textContent = '‚óè';
 future.timeline.forEach(t => {
 const el = document.getElementById(`score${t.years}y`);
 if (el) {
 el.textContent = t.projectedScore;
 el.style.color = t.projectedScore > 150 ? '#9c27b0' :
 t.projectedScore > 100 ? '#f44336' :
 t.projectedScore > 50 ? '#ff9800' : '#4caf50';
 }
 });

 // Future threats
 const threatsDiv = document.getElementById('futureThreats');
 threatsDiv.innerHTML = future.timeline.map(t => `
 <div class="threat-card" data-years="${t.years}">
 <div class="threat-header">
 <span class="threat-year">In ${t.years} Jahr${t.years > 1 ? 'en' : ''}</span>
 <span class="threat-multiplier">√ó${t.riskMultiplier.toFixed(1)}</span>
 </div>
 <ul class="threat-list">
 ${t.newThreats.map(threat => `<li>${threat}</li>`).join('')}
 </ul>
 </div>
 `).join('');

 // Permanent risks
 const permList = document.getElementById('permanentRisksList');
 if (future.permanentRisks.length > 0) {
 permList.innerHTML = future.permanentRisks.map(r => `
 <div class="permanent-risk-item">
 <span class="perm-icon">${r.icon || ''}</span>
 <span class="perm-type">${r.dataType}</span>
 <span class="perm-risk">‚Üí ${r.risk}</span>
 <span class="perm-desc">${r.description}</span>
 </div>
 `).join('');
 document.getElementById('permanentRisks').style.display = 'block';
 } else {
 document.getElementById('permanentRisks').style.display = 'none';
 }
 }

 function displayCorrelationAttack(correlation) {
 const methodsDiv = document.getElementById('correlationMethods');

 methodsDiv.innerHTML = correlation.possibleCorrelations.map(c => `
 <div class="correlation-card">
 <div class="corr-header">
 <span class="corr-icon">${c.icon}</span>
 <span class="corr-name">${c.method}</span>
 <span class="corr-difficulty difficulty-${c.difficulty}">${c.difficulty}</span>
 </div>
 <div class="corr-confidence">
 <span>Erfolgswahrscheinlichkeit:</span>
 <div class="confidence-bar">
 <div class="confidence-fill" style="width: ${c.confidence * 100}%"></div>
 </div>
 <span>${Math.round(c.confidence * 100)}%</span>
 </div>
 <div class="corr-steps">
 <strong>Angriffs-Schritte:</strong>
 <ol>${c.steps.map(s => `<li>${s}</li>`).join('')}</ol>
 </div>
 </div>
 `).join('');

 // Attack surface
 const surface = correlation.attackSurface;
 document.getElementById('attackSurfaceScore').innerHTML = `
 <span>Angriffsfl√§che: </span>
 <strong style="color: ${surface.score > 0.7 ? '#f44336' : surface.score > 0.4 ? '#ff9800' : '#4caf50'}">
 ${Math.round(surface.score * 100)}%
 </strong>
 `;
 document.getElementById('attackSurfaceWeakest').innerHTML = `
 <strong>Schw√§chstes Glied:</strong> ${surface.weakestLink}
 `;
 document.getElementById('attackSurfaceRecommendation').innerHTML = `
 ${surface.recommendation}
 `;
 }

 // ========================================
 // Phase 7: Digital Footprint Scanner
 // ========================================

 const API_FOOTPRINT_URL = `${API_BASE}/footprint-scan`;
 const API_BREACH_CHECK_URL = `${API_BASE}/footprint-breach-check`;
 const API_SOCIAL_SCAN_URL = `${API_BASE}/footprint-social-scan`;
 const API_DATABROKER_URL = `${API_BASE}/footprint-databroker-scan`;

 let currentScanType = 'quick';
 let footprintScanResults = null;

 // Sample breach database for client-side fallback
 const BREACH_DATABASE = [
 { id: 'linkedin_2021', name: 'LinkedIn', date: '2021-06-22', accounts: 700000000, severity: 'high', dataTypes: ['email', 'password', 'name', 'phone'] },
 { id: 'facebook_2019', name: 'Facebook', date: '2019-04-03', accounts: 533000000, severity: 'high', dataTypes: ['email', 'phone', 'name', 'location'] },
 { id: 'twitter_2023', name: 'Twitter/X', date: '2023-01-04', accounts: 200000000, severity: 'medium', dataTypes: ['email', 'name', 'username'] },
 { id: 'adobe_2013', name: 'Adobe', date: '2013-10-04', accounts: 153000000, severity: 'high', dataTypes: ['email', 'password', 'username'] },
 { id: 'dropbox_2012', name: 'Dropbox', date: '2012-07-01', accounts: 68000000, severity: 'medium', dataTypes: ['email', 'password'] },
 { id: 'myspace_2016', name: 'MySpace', date: '2016-05-27', accounts: 360000000, severity: 'medium', dataTypes: ['email', 'password', 'username'] },
 { id: 'canva_2019', name: 'Canva', date: '2019-05-24', accounts: 137000000, severity: 'medium', dataTypes: ['email', 'name', 'username'] },
 { id: 'zynga_2019', name: 'Zynga', date: '2019-09-01', accounts: 218000000, severity: 'medium', dataTypes: ['email', 'password', 'username', 'phone'] }
 ];

 // Data broker database
 const DATABROKER_DATABASE = [
 { id: 'spokeo', name: 'Spokeo', category: 'people_search', region: 'US', difficulty: 'easy', optoutUrl: 'https://spokeo.com/optout', dataTypes: ['name', 'address', 'phone', 'email', 'relatives'] },
 { id: 'beenverified', name: 'BeenVerified', category: 'background_check', region: 'US', difficulty: 'medium', optoutUrl: 'https://beenverified.com/optout', dataTypes: ['name', 'address', 'phone', 'criminal'] },
 { id: 'whitepages', name: 'Whitepages', category: 'people_search', region: 'US', difficulty: 'easy', optoutUrl: 'https://whitepages.com/suppression', dataTypes: ['name', 'address', 'phone'] },
 { id: 'intelius', name: 'Intelius', category: 'people_search', region: 'US', difficulty: 'medium', optoutUrl: 'https://intelius.com/optout', dataTypes: ['name', 'address', 'phone', 'email'] },
 { id: 'acxiom', name: 'Acxiom', category: 'marketing', region: 'Global', difficulty: 'medium', optoutUrl: 'https://isapps.acxiom.com/optout', dataTypes: ['name', 'address', 'demographics', 'purchase_history'] },
 { id: 'oracle_datacloud', name: 'Oracle Data Cloud', category: 'marketing', region: 'Global', difficulty: 'hard', optoutUrl: 'https://datacloudoptout.oracle.com', dataTypes: ['name', 'email', 'browsing', 'interests'] },
 { id: 'experian', name: 'Experian', category: 'credit', region: 'Global', difficulty: 'medium', optoutUrl: 'https://experian.com/privacy', dataTypes: ['name', 'address', 'credit_score', 'financial'] },
 { id: 'equifax', name: 'Equifax', category: 'credit', region: 'Global', difficulty: 'medium', optoutUrl: 'https://equifax.com/personal/credit-report-services', dataTypes: ['name', 'address', 'credit_score', 'financial'] },
 { id: 'lexisnexis', name: 'LexisNexis', category: 'background_check', region: 'Global', difficulty: 'hard', optoutUrl: 'https://optout.lexisnexis.com', dataTypes: ['name', 'address', 'legal', 'employment'] },
 { id: 'peoplelooker', name: 'PeopleLooker', category: 'people_search', region: 'US', difficulty: 'easy', optoutUrl: 'https://peoplelooker.com/optout', dataTypes: ['name', 'address', 'phone', 'email'] },
 { id: 'truepeoplesearch', name: 'TruePeopleSearch', category: 'people_search', region: 'US', difficulty: 'easy', optoutUrl: 'https://truepeoplesearch.com/removal', dataTypes: ['name', 'address', 'phone'] },
 { id: 'fastpeoplesearch', name: 'FastPeopleSearch', category: 'people_search', region: 'US', difficulty: 'easy', optoutUrl: 'https://fastpeoplesearch.com/removal', dataTypes: ['name', 'address', 'phone'] }
 ];

 // Social media platforms to check
 const SOCIAL_PLATFORMS = [
 { id: 'twitter', name: 'Twitter/X', icon: '', urlPattern: 'twitter.com/' },
 { id: 'facebook', name: 'Facebook', icon: '', urlPattern: 'facebook.com/' },
 { id: 'instagram', name: 'Instagram', icon: '', urlPattern: 'instagram.com/' },
 { id: 'linkedin', name: 'LinkedIn', icon: '', urlPattern: 'linkedin.com/in/' },
 { id: 'github', name: 'GitHub', icon: '', urlPattern: 'github.com/' },
 { id: 'tiktok', name: 'TikTok', icon: '', urlPattern: 'tiktok.com/@' },
 { id: 'youtube', name: 'YouTube', icon: '‚ñ∂', urlPattern: 'youtube.com/@' },
 { id: 'reddit', name: 'Reddit', icon: '', urlPattern: 'reddit.com/user/' },
 { id: 'pinterest', name: 'Pinterest', icon: '', urlPattern: 'pinterest.com/' },
 { id: 'snapchat', name: 'Snapchat', icon: '', urlPattern: 'snapchat.com/add/' },
 { id: 'discord', name: 'Discord', icon: '', urlPattern: 'discord.com/users/' },
 { id: 'telegram', name: 'Telegram', icon: '', urlPattern: 't.me/' }
 ];

 function initFootprintScanner() {
 // Form submission
 const form = document.getElementById('footprintForm');
 if (form) {
 form.addEventListener('submit', handleFootprintSubmit);
 }

 // Scan type buttons
 document.querySelectorAll('.scan-type-btn').forEach(btn => {
 btn.addEventListener('click', function() {
 document.querySelectorAll('.scan-type-btn').forEach(b => b.classList.remove('active'));
 this.classList.add('active');
 currentScanType = this.dataset.type;
 });
 });
 }

 function toggleAdvancedInputs() {
 const advanced = document.getElementById('advancedInputs');
 const btn = document.querySelector('.toggle-advanced-btn');
 if (advanced.style.display === 'none') {
 advanced.style.display = 'block';
 btn.querySelector('.toggle-icon').textContent = '‚ñ≤';
 } else {
 advanced.style.display = 'none';
 btn.querySelector('.toggle-icon').textContent = '‚ñº';
 }
 }

 function toggleSection(sectionId) {
 const section = document.getElementById(sectionId);
 const header = section.previousElementSibling;
 if (section.style.display === 'none') {
 section.style.display = 'block';
 header.querySelector('.section-toggle').textContent = '‚ñº';
 } else {
 section.style.display = 'none';
 header.querySelector('.section-toggle').textContent = '‚ñ∂';
 }
 }

 async function handleFootprintSubmit(e) {
 e.preventDefault();

 const email = document.getElementById('footprintEmail').value.trim();
 const name = document.getElementById('footprintName').value.trim();
 const username = document.getElementById('footprintUsername').value.trim();
 const phone = document.getElementById('footprintPhone').value.trim();

 if (!email) {
 alert('Bitte gib eine E-Mail-Adresse ein.');
 return;
 }

 const btn = document.getElementById('footprintSubmitBtn');
 btn.querySelector('.btn-text').style.display = 'none';
 btn.querySelector('.btn-loading').style.display = 'inline';
 btn.disabled = true;

 const options = {
 checkBreaches: document.getElementById('optBreaches').checked,
 checkSocialMedia: document.getElementById('optSocial').checked,
 checkDataBrokers: document.getElementById('optDatabrokers').checked,
 checkDarkWeb: document.getElementById('optDarkweb').checked,
 deepScan: currentScanType === 'full'
 };

 try {
 // Try API first, fallback to client-side
 let results;
 try {
 const response = await fetch(API_FOOTPRINT_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ email, name, username, phone, options })
 });
 if (response.ok) {
 results = await response.json();
 } else {
 throw new Error('API unavailable');
 }
 } catch (apiError) {
 console.log('Using client-side footprint analysis');
 results = performClientSideFootprintScan(email, name, username, phone, options);
 }

 footprintScanResults = results;
 displayFootprintResults(results);

 } catch (error) {
 console.error('Footprint scan error:', error);
 alert('Fehler beim Scan. Bitte versuche es erneut.');
 } finally {
 btn.querySelector('.btn-text').style.display = 'inline';
 btn.querySelector('.btn-loading').style.display = 'none';
 btn.disabled = false;
 }
 }

 function performClientSideFootprintScan(email, name, username, phone, options) {
 const results = {
 scanId: 'scan_' + Date.now(),
 timestamp: new Date().toISOString(),
 summary: {
 overallRisk: 'medium',
 riskScore: 0,
 totalExposures: 0,
 criticalFindings: 0,
 actionRequired: 0
 },
 breaches: { found: false, count: 0, items: [] },
 socialMedia: { found: false, count: 0, profiles: [] },
 dataBrokers: { found: false, count: 0, items: [] },
 recommendations: { immediate: [], shortTerm: [], longTerm: [] }
 };

 // Simulate breach check
 if (options.checkBreaches) {
 const emailDomain = email.split('@')[1];
 const hash = simpleHash(email);

 // Simulate finding some breaches based on email characteristics
 const foundBreaches = BREACH_DATABASE.filter((breach, index) => {
 return (hash + index) % 3 === 0; // Randomly select ~1/3 of breaches
 }).map(breach => ({
 ...breach,
 exposedData: breach.dataTypes,
 description: `${breach.name} wurde kompromittiert mit ${formatNumber(breach.accounts)} Konten`,
 recommendations: [
 'Passwort sofort √§ndern',
 '2FA aktivieren',
 'Auf Phishing-Mails achten'
 ]
 }));

 if (foundBreaches.length > 0) {
 results.breaches = {
 found: true,
 count: foundBreaches.length,
 items: foundBreaches
 };
 results.summary.totalExposures += foundBreaches.length;
 results.summary.criticalFindings += foundBreaches.filter(b => b.severity === 'high').length;
 }
 }

 // Simulate social media scan
 if (options.checkSocialMedia && username) {
 const foundProfiles = SOCIAL_PLATFORMS.slice(0, 4 + Math.floor(Math.random() * 4)).map(platform => ({
 platform: platform.id,
 displayName: platform.name,
 icon: platform.icon,
 found: true,
 url: `https://${platform.urlPattern}${username}`,
 username: username,
 isPublic: Math.random() > 0.3,
 privacyScore: Math.floor(Math.random() * 60) + 20,
 privacyIssues: [
 'Profil ist √∂ffentlich',
 'Standort sichtbar',
 'E-Mail im Profil'
 ].slice(0, Math.floor(Math.random() * 3) + 1),
 recommendations: [
 'Profil auf privat stellen',
 'Pers√∂nliche Infos entfernen'
 ]
 }));

 results.socialMedia = {
 found: true,
 count: foundProfiles.length,
 profiles: foundProfiles
 };
 results.summary.totalExposures += foundProfiles.length;
 }

 // Simulate data broker scan
 if (options.checkDataBrokers) {
 const foundBrokers = DATABROKER_DATABASE.filter((_, index) => {
 return Math.random() > 0.4; // ~60% chance to be found
 }).map(broker => ({
 ...broker,
 confirmed: Math.random() > 0.3 ? true : 'likely',
 optOut: {
 available: true,
 url: broker.optoutUrl,
 difficulty: broker.difficulty,
 estimatedDays: broker.difficulty === 'easy' ? 3 : broker.difficulty === 'medium' ? 14 : 30
 }
 }));

 if (foundBrokers.length > 0) {
 results.dataBrokers = {
 found: true,
 count: foundBrokers.length,
 items: foundBrokers
 };
 results.summary.totalExposures += foundBrokers.length;
 results.summary.actionRequired += foundBrokers.length;
 }
 }

 // Calculate overall risk score
 results.summary.riskScore = Math.min(100,
 results.breaches.count * 15 +
 results.socialMedia.count * 5 +
 results.dataBrokers.count * 8 +
 results.summary.criticalFindings * 10
 );

 // Determine risk level
 if (results.summary.riskScore >= 70) {
 results.summary.overallRisk = 'critical';
 } else if (results.summary.riskScore >= 50) {
 results.summary.overallRisk = 'high';
 } else if (results.summary.riskScore >= 25) {
 results.summary.overallRisk = 'medium';
 } else {
 results.summary.overallRisk = 'low';
 }

 // Generate recommendations
 if (results.breaches.count > 0) {
 results.recommendations.immediate.push({
 priority: 1,
 action: 'Passw√∂rter f√ºr betroffene Dienste √§ndern',
 reason: `${results.breaches.count} Datenlecks gefunden`
 });
 results.recommendations.immediate.push({
 priority: 2,
 action: '2-Faktor-Authentifizierung aktivieren',
 reason: 'Zus√§tzlicher Schutz gegen Account-√úbernahme'
 });
 }

 if (results.dataBrokers.count > 0) {
 results.recommendations.shortTerm.push({
 priority: 3,
 action: `Opt-out bei ${results.dataBrokers.count} Data Brokern durchf√ºhren`,
 reason: 'Pers√∂nliche Daten √∂ffentlich verf√ºgbar'
 });
 }

 results.recommendations.longTerm.push({
 priority: 4,
 action: 'Regelm√§√üiges Monitoring einrichten',
 reason: 'Neue Lecks fr√ºhzeitig erkennen'
 });

 return results;
 }

 function simpleHash(str) {
 let hash = 0;
 for (let i = 0; i < str.length; i++) {
 const char = str.charCodeAt(i);
 hash = ((hash << 5) - hash) + char;
 hash = hash & hash;
 }
 return Math.abs(hash);
 }

 function formatNumber(num) {
 if (num >= 1000000000) return (num / 1000000000).toFixed(1) + 'B';
 if (num >= 1000000) return (num / 1000000).toFixed(0) + 'M';
 if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
 return num.toString();
 }

 function displayFootprintResults(results) {
 const container = document.getElementById('footprintResults');
 container.style.display = 'block';

 // Update summary
 const riskScore = results.summary.riskScore;
 document.getElementById('footprintRiskScore').textContent = riskScore;
 document.getElementById('statExposures').textContent = results.summary.totalExposures;
 document.getElementById('statCritical').textContent = results.summary.criticalFindings;
 document.getElementById('statActions').textContent = results.summary.actionRequired;

 // Update risk circle
 const riskFill = document.getElementById('footprintRiskFill');
 const circumference = 2 * Math.PI * 45;
 const offset = circumference - (riskScore / 100) * circumference;
 riskFill.style.strokeDasharray = circumference;
 riskFill.style.strokeDashoffset = offset;

 // Color based on risk
 const riskColors = {
 low: '#4caf50',
 medium: '#ff9800',
 high: '#f44336',
 critical: '#9c27b0'
 };
 riskFill.style.stroke = riskColors[results.summary.overallRisk];
 document.getElementById('footprintRiskScore').style.color = riskColors[results.summary.overallRisk];

 // Display breaches
 if (results.breaches.found) {
 displayBreachResults(results.breaches);
 }

 // Display social media
 if (results.socialMedia.found) {
 displaySocialResults(results.socialMedia);
 }

 // Display data brokers
 if (results.dataBrokers.found) {
 displayDatabrokerResults(results.dataBrokers);
 }

 // Display recommendations
 displayRecommendations(results.recommendations);

 // Scroll to results
 container.scrollIntoView({ behavior: 'smooth' });
 }

 function displayBreachResults(breaches) {
 const section = document.getElementById('breachResultsSection');
 section.style.display = 'block';
 document.getElementById('breachCount').textContent = breaches.count;

 const list = document.getElementById('breachList');
 list.innerHTML = breaches.items.map(breach => `
 <div class="breach-item severity-${breach.severity}">
 <div class="breach-header">
 <span class="breach-name">${breach.name}</span>
 <span class="breach-date">${breach.date}</span>
 <span class="breach-severity severity-badge-${breach.severity}">${breach.severity}</span>
 </div>
 <div class="breach-details">
 <div class="breach-accounts">
 <span>${formatNumber(breach.accounts)} Konten betroffen</span>
 </div>
 <div class="breach-data-types">
 <span>Exponiert: ${breach.exposedData.join(', ')}</span>
 </div>
 </div>
 <div class="breach-actions">
 ${breach.recommendations.map(rec => `<span class="action-tag"> ${rec}</span>`).join('')}
 </div>
 </div>
 `).join('');
 }

 function displaySocialResults(social) {
 const section = document.getElementById('socialResultsSection');
 section.style.display = 'block';
 document.getElementById('socialCount').textContent = social.count;

 const list = document.getElementById('socialProfilesList');
 list.innerHTML = social.profiles.map(profile => `
 <div class="social-profile-item">
 <div class="profile-header">
 <span class="profile-icon">${profile.icon}</span>
 <span class="profile-name">${profile.displayName}</span>
 <span class="profile-username">@${profile.username}</span>
 <span class="privacy-score score-${profile.privacyScore < 40 ? 'bad' : profile.privacyScore < 70 ? 'medium' : 'good'}">
 ${profile.privacyScore}%
 </span>
 </div>
 <div class="profile-status">
 <span class="status-badge ${profile.isPublic ? 'public' : 'private'}">
 ${profile.isPublic ? ' √ñffentlich' : ' Privat'}
 </span>
 </div>
 ${profile.privacyIssues.length > 0 ? `
 <div class="profile-issues">
 ${profile.privacyIssues.map(issue => `<span class="issue-tag"> ${issue}</span>`).join('')}
 </div>
 ` : ''}
 <div class="profile-link">
 <a href="${profile.url}" target="_blank" rel="noopener">Profil √∂ffnen ‚Üí</a>
 </div>
 </div>
 `).join('');
 }

 function displayDatabrokerResults(brokers) {
 const section = document.getElementById('databrokerResultsSection');
 section.style.display = 'block';
 document.getElementById('databrokerCount').textContent = brokers.count;

 const list = document.getElementById('databrokerList');
 list.innerHTML = brokers.items.map(broker => `
 <div class="databroker-item">
 <div class="broker-header">
 <span class="broker-name">${broker.name}</span>
 <span class="broker-category">${broker.category}</span>
 <span class="broker-region">${broker.region}</span>
 </div>
 <div class="broker-data">
 <span>Daten: ${broker.dataTypes.join(', ')}</span>
 </div>
 <div class="broker-optout">
 <span class="difficulty difficulty-${broker.difficulty}">${broker.difficulty}</span>
 <span class="time-estimate">~${broker.optOut.estimatedDays} Tage</span>
 <a href="${broker.optOut.url}" target="_blank" rel="noopener" class="optout-link">
 Opt-out starten ‚Üí
 </a>
 </div>
 </div>
 `).join('');

 // Update progress bar
 document.getElementById('optoutProgressFill').style.width = '0%';
 document.getElementById('optoutProgressValue').textContent = '0%';
 }

 function displayRecommendations(recommendations) {
 const list = document.getElementById('recommendationsList');
 const allRecs = [
 ...recommendations.immediate.map(r => ({ ...r, type: 'immediate' })),
 ...recommendations.shortTerm.map(r => ({ ...r, type: 'shortTerm' })),
 ...recommendations.longTerm.map(r => ({ ...r, type: 'longTerm' }))
 ];

 list.innerHTML = allRecs.map(rec => `
 <div class="recommendation-item priority-${rec.type}">
 <div class="rec-priority">
 <span class="priority-badge ${rec.type}">${
 rec.type === 'immediate' ? ' Sofort' :
 rec.type === 'shortTerm' ? ' Bald' : ' Langfristig'
 }</span>
 </div>
 <div class="rec-content">
 <div class="rec-action">${rec.action}</div>
 <div class="rec-reason">${rec.reason}</div>
 </div>
 </div>
 `).join('');
 }

 function startBulkOptout() {
 alert('Bulk Opt-out Feature wird in der n√§chsten Version verf√ºgbar sein.');
 }

 function setupMonitoring() {
 const email = document.getElementById('footprintEmail').value;
 if (email) {
 alert(`Monitoring f√ºr ${email} wird eingerichtet. Du erh√§ltst eine Best√§tigungs-E-Mail.`);
 }
 }

 // ========================================
 // Phase 10: Smart Privacy Coach
 // ========================================

 const API_COACH_URL = `${API_BASE}/coach-chat`;
 const API_COACH_TOPICS_URL = `${API_BASE}/coach-topics`;
 const API_COACH_TOPIC_DETAIL_URL = `${API_BASE}/coach-topic-detail`;
 const API_COACH_FEEDBACK_URL = `${API_BASE}/coach-feedback`;
 const API_COACH_QUICK_TIPS_URL = `${API_BASE}/coach-quick-tips`;
 let coachSessionId = null;
 let coachConversation = [];
 let currentMessageId = null;
 let isCoachTyping = false;

 // Knowledge base for client-side responses
 const COACH_KNOWLEDGE = {
 greetings: [
 "Hallo! Ich bin dein Privacy Coach. Wie kann ich dir heute helfen?",
 "Hi! Sch√∂n, dass du da bist. Frag mich alles √ºber Datenschutz!",
 "Willkommen! Ich helfe dir gerne bei Datenschutz-Fragen."
 ],
 topics: {
 pii: {
 keywords: ['personenbezogen', 'pii', 'pers√∂nliche daten', 'was sind'],
 response: `**Personenbezogene Daten (PII)** sind alle Informationen, die dich identifizieren k√∂nnen:

 **Direkte Identifikatoren:**
- Name, Adresse, Telefonnummer
- E-Mail, Geburtsdatum
- Personalausweis-/Passnummer

 **Indirekte Identifikatoren:**
- IP-Adresse, Cookies
- Standortdaten
- Ger√§tekennungen

 **Besonders sensibel:**
- Gesundheitsdaten
- Politische Meinungen
- Religi√∂se √úberzeugungen
- Sexuelle Orientierung

 **Tipp:** Auch scheinbar harmlose Daten k√∂nnen in Kombination zur Identifikation f√ºhren!`
 },
 k_anonymity: {
 keywords: ['k-anonymit√§t', 'k anonymit√§t', 'anonymit√§t', 'k='],
 response: `**k-Anonymit√§t** einfach erkl√§rt:

 Stell dir vor, du versteckst dich in einer Menschenmenge:

**k = 1** 
Du bist allein erkennbar. Sofort identifizierbar!

**k = 10** 
Du bist einer von 10 gleich aussehenden Personen. Besser!

**k = 1000** 
Du bist einer von 1000 - sehr gut versteckt!

 **Beispiel:**
"28-j√§hriger Programmierer in Berlin-Mitte"
‚Üí Vielleicht nur 5 Personen (k=5) - riskant!

"20-30 Jahre, IT-Branche, Berlin"
‚Üí Tausende Personen (k=10.000+) - sicher!

 **Merke:** Je h√∂her k, desto besser dein Datenschutz!`
 },
 phishing: {
 keywords: ['phishing', 'betrug', 'fake mail', 'spam', 'erkennen'],
 response: `**Phishing erkennen** - So sch√ºtzt du dich:

 Phishing = "Angeln" nach deinen Daten

**Typische Merkmale:**
1. **Dringlichkeit**: "Ihr Konto wird gesperrt!"
2. **Falsche Absender**: support@amaz0n-sicher.com
3. **Rechtschreibfehler**: "Bitte best√§tigen Sie Ihre Daten"
4. **Verd√§chtige Links**: Hover zeigt andere URL
5. **Gef√§hrliche Anh√§nge**: .exe, .zip, .doc mit Makros

**So pr√ºfst du:**
1. Absender-Adresse genau ansehen
2. Nie direkt auf Links klicken
3. Im Zweifel: Firma direkt kontaktieren
4. Keine Passw√∂rter per Mail senden

 **Tipp:** Echte Banken fragen NIE per Mail nach Passw√∂rtern!`
 },
 risky_data: {
 keywords: ['nie teilen', 'gef√§hrlich', 'risiko', 'welche daten', 'nicht teilen'],
 response: `**Diese Daten solltest du NIEMALS √∂ffentlich teilen:**

 **Kritisch - Nie teilen:**
- Passw√∂rter & PINs
- Vollst√§ndige Kreditkartennummern
- IBAN + Kontoinhaber zusammen
- Personalausweis-/Passnummer
- Sozialversicherungsnummer

 **Vorsicht - Nur wenn n√∂tig:**
- Vollst√§ndige Adresse
- Geburtsdatum (Tag+Monat+Jahr)
- Telefonnummer
- Arbeitgeber + Position

 **Bewusst teilen:**
- Vollst√§ndiger Name
- Wohnort (Stadt)
- Beruf (allgemein)
- Alter (ungef√§hr)

 **Goldene Regel:**
Frag dich: "W√ºrde ich das einem Fremden auf der Stra√üe erz√§hlen?"`
 },
 gdpr: {
 keywords: ['dsgvo', 'gdpr', 'rechte', 'datenschutz gesetz', 'eu'],
 response: `**DSGVO - Deine Rechte in der EU:**

 Die Datenschutz-Grundverordnung gibt dir starke Rechte:

**1. Auskunftsrecht (Art. 15)**
Du kannst fragen: "Welche Daten habt ihr √ºber mich?"

**2. Recht auf L√∂schung (Art. 17)**
"L√∂scht meine Daten!" - Unternehmen m√ºssen folgen

**3. Daten√ºbertragbarkeit (Art. 20)**
Deine Daten in maschinenlesbarem Format erhalten

**4. Widerspruchsrecht (Art. 21)**
Du kannst Datenverarbeitung widersprechen

**5. Recht auf Berichtigung (Art. 16)**
Falsche Daten m√ºssen korrigiert werden

 **Strafen f√ºr Unternehmen:**
Bis zu 20 Mio. ‚Ç¨ oder 4% des Jahresumsatzes!

 **Tipp:** Bei Verst√∂√üen: Beschwerde bei der Datenschutzbeh√∂rde einreichen!`
 },
 password: {
 keywords: ['passwort', 'kennwort', 'sicher', '2fa', 'zwei-faktor'],
 response: `**Sichere Passw√∂rter - Best Practices:**

 **Ein gutes Passwort:**
- Mindestens 12 Zeichen
- Gro√ü- & Kleinbuchstaben
- Zahlen & Sonderzeichen
- KEIN W√∂rterbuch-Wort
- NICHT: Geburtsdatum, Name, "123456"

 **Gut:** "Kx7#mP9$vL2@nQ"
 **Schlecht:** "Passwort123!"

 **2-Faktor-Authentifizierung (2FA):**
- Aktiviere 2FA √ºberall wo m√∂glich!
- App (Authenticator) > SMS
- Sch√ºtzt auch bei Passwort-Leak

 **Passwort-Manager:**
- Speichert alle Passw√∂rter sicher
- Generiert starke Passw√∂rter
- Empfehlung: Bitwarden, 1Password, KeePass

 **Goldene Regel:** Ein einzigartiges Passwort pro Dienst!`
 },
 breach: {
 keywords: ['datenleck', 'breach', 'gehackt', 'leak', 'gestohlen'],
 response: `**Was tun bei einem Datenleck?**

 **Sofort-Ma√ünahmen:**
1. **Passwort √§ndern** - beim betroffenen Dienst
2. **Gleiche Passw√∂rter** √ºberall √§ndern
3. **2FA aktivieren** - falls noch nicht aktiv
4. **Kontoausz√ºge pr√ºfen** - bei Finanzdaten

 **Pr√ºfen ob du betroffen bist:**
- haveibeenpwned.com
- Unser Footprint Scanner

 **Bei E-Mail-Leak:**
- Spam-Filter verst√§rken
- Auf Phishing achten
- Neue E-Mail f√ºr wichtige Dienste erw√§gen

 **Bei Finanzdaten-Leak:**
- Bank informieren
- Karte sperren lassen
- Abbuchungen √ºberwachen

 **Langfristig:** Regelm√§√üiges Monitoring einrichten!`
 }
 },
 fallback: [
 "Das ist eine interessante Frage! Leider bin ich mir nicht 100% sicher. Versuche es mal anders zu formulieren oder w√§hle ein Thema aus der Sidebar.",
 "Hmm, dazu habe ich keine spezifischen Informationen. Kann ich dir bei einem anderen Datenschutz-Thema helfen?",
 "Diese Frage √ºbersteigt mein aktuelles Wissen. Schau gerne in unsere Lern-Themen oder formuliere die Frage anders."
 ]
 };

 const COACH_TOPICS = [
 { id: 'basics', icon: '', title: 'Grundlagen', description: 'Was ist Datenschutz?' },
 { id: 'gdpr', icon: '', title: 'DSGVO', description: 'Deine Rechte in der EU' },
 { id: 'phishing', icon: '', title: 'Phishing', description: 'Betrug erkennen' },
 { id: 'passwords', icon: '', title: 'Passw√∂rter', description: 'Sichere Passw√∂rter & 2FA' },
 { id: 'social', icon: '', title: 'Social Media', description: 'Privacy-Einstellungen' },
 { id: 'breaches', icon: '', title: 'Datenlecks', description: 'Was tun bei Leaks?' }
 ];

 function initPrivacyCoach() {
 const form = document.getElementById('coachInputForm');
 if (form) {
 form.addEventListener('submit', handleCoachSubmit);
 }

 // Initialize session
 coachSessionId = 'session_' + Date.now();

 // Show welcome message
 showWelcomeMessage();

 // Load topics from API
 loadCoachTopicsFromAPI();

 // Load quick tips
 loadQuickTips();
 }

 function showWelcomeMessage() {
 const messagesDiv = document.getElementById('coachMessages');
 if (!messagesDiv) return;

 const welcomeMsg = COACH_KNOWLEDGE.greetings[Math.floor(Math.random() * COACH_KNOWLEDGE.greetings.length)];

 messagesDiv.innerHTML = '';
 addCoachMessage(welcomeMsg, 'coach');

 // Add initial suggestions
 showSuggestions([
 { text: 'Was sind personenbezogene Daten?', action: 'ask' },
 { text: 'Erkl√§re k-Anonymit√§t', action: 'ask' },
 { text: 'Wie erstelle ich sichere Passw√∂rter?', action: 'ask' }
 ]);
 }

 function loadCoachTopics() {
 const topicsList = document.getElementById('coachTopicsList');
 if (!topicsList) return;

 topicsList.innerHTML = COACH_TOPICS.map(topic => `
 <button class="coach-topic-btn" onclick="selectCoachTopic('${topic.id}')">
 <span class="topic-icon">${topic.icon}</span>
 <div class="topic-info">
 <span class="topic-title">${topic.title}</span>
 <span class="topic-desc">${topic.description}</span>
 </div>
 </button>
 `).join('');
 }

 async function loadCoachTopicsFromAPI() {
 const topicsList = document.getElementById('coachTopicsList');
 if (!topicsList) return;

 try {
 const response = await fetch(API_COACH_TOPICS_URL);
 if (response.ok) {
 const data = await response.json();
 if (data.success && data.categories) {
 // Flatten topics from all categories
 const allTopics = data.categories.flatMap(cat =>
 cat.topics.map(t => ({ ...t, category: cat.id, categoryIcon: cat.icon }))
 );

 topicsList.innerHTML = allTopics.slice(0, 6).map(topic => `
 <button class="coach-topic-btn" onclick="openTopicDetail('${topic.id}')" title="${topic.description}">
 <span class="topic-icon">${topic.icon}</span>
 <div class="topic-info">
 <span class="topic-title">${topic.title}</span>
 <span class="topic-desc">${topic.description}</span>
 </div>
 <span class="topic-duration">${topic.duration || ''}</span>
 </button>
 `).join('');

 // Store topics for later use
 window.coachTopicsData = data;
 return;
 }
 }
 } catch (error) {
 console.log('Using fallback topics:', error.message);
 }

 // Fallback to local topics
 loadCoachTopics();
 }

 async function openTopicDetail(topicId) {
 // Show loading state
 showTopicModal(topicId, null, true);

 try {
 const response = await fetch(`${API_COACH_TOPIC_DETAIL_URL}?topicId=${topicId}`);
 if (response.ok) {
 const data = await response.json();
 if (data.success) {
 showTopicModal(topicId, data, false);
 return;
 }
 }
 } catch (error) {
 console.log('Error loading topic:', error.message);
 }

 // Fallback: ask coach about the topic
 closeTopicModal();
 const topicQuestions = {
 what_is_privacy: 'Was ist Datenschutz?',
 gdpr_basics: 'Erkl√§re mir die DSGVO',
 pii_explained: 'Was sind personenbezogene Daten?',
 financial_data: 'Wie sch√ºtze ich meine Finanzdaten?',
 phishing: 'Wie erkenne ich Phishing?',
 identity_theft: 'Was ist Identit√§tsdiebstahl?',
 deanonymization: 'Was ist Deanonymisierung?',
 password_security: 'Wie erstelle ich sichere Passw√∂rter?',
 social_media_privacy: 'Wie sch√ºtze ich meine Social Media Profile?'
 };
 askCoach(topicQuestions[topicId] || `Erz√§hl mir mehr √ºber ${topicId}`);
 }

 function showTopicModal(topicId, data, isLoading) {
 let modal = document.getElementById('topicDetailModal');
 if (!modal) {
 modal = document.createElement('div');
 modal.id = 'topicDetailModal';
 modal.className = 'topic-modal-overlay';
 document.body.appendChild(modal);
 }

 if (isLoading) {
 modal.innerHTML = `
 <div class="topic-modal">
 <div class="topic-modal-header">
 <h3>Lade Thema...</h3>
 <button class="topic-modal-close" onclick="closeTopicModal()"></button>
 </div>
 <div class="topic-modal-content">
 <div class="topic-loading">
 <div class="loading-spinner"></div>
 <p>Inhalte werden geladen...</p>
 </div>
 </div>
 </div>
 `;
 } else if (data && data.topic && data.content) {
 const topic = data.topic;
 const content = data.content;

 modal.innerHTML = `
 <div class="topic-modal">
 <div class="topic-modal-header">
 <div class="topic-modal-title">
 <span class="topic-icon-large">${topic.icon}</span>
 <div>
 <h3>${topic.title}</h3>
 <span class="topic-meta">${topic.difficulty || 'beginner'} ‚Ä¢ ${topic.duration || '5 min'}</span>
 </div>
 </div>
 <button class="topic-modal-close" onclick="closeTopicModal()"></button>
 </div>
 <div class="topic-modal-content">
 <div class="topic-introduction">
 <p>${content.introduction}</p>
 </div>
 ${content.sections ? content.sections.map(section => `
 <div class="topic-section">
 <h4>${section.title}</h4>
 ${section.content ? `<p>${section.content}</p>` : ''}
 ${section.bulletPoints ? `
 <ul class="topic-bullets">
 ${section.bulletPoints.map(bp => `<li>${bp}</li>`).join('')}
 </ul>
 ` : ''}
 ${section.type === 'interactive' && section.quiz ? `
 <div class="topic-quiz" data-quiz='${JSON.stringify(section.quiz)}'>
 ${section.quiz.map((q, i) => `
 <div class="quiz-question" id="quiz-${topicId}-${i}">
 <p><strong>Quiz:</strong> ${q.question}</p>
 <div class="quiz-options">
 ${q.options.map((opt, j) => `
 <button class="quiz-option" onclick="checkQuizAnswer('${topicId}', ${i}, ${j}, ${q.correct})">
 ${opt}
 </button>
 `).join('')}
 </div>
 <div class="quiz-explanation" style="display: none;">
 <p>${q.explanation}</p>
 </div>
 </div>
 `).join('')}
 </div>
 ` : ''}
 </div>
 `).join('') : ''}
 ${content.keyTakeaways ? `
 <div class="topic-takeaways">
 <h4> Wichtige Erkenntnisse</h4>
 <ul>
 ${content.keyTakeaways.map(t => `<li>${t}</li>`).join('')}
 </ul>
 </div>
 ` : ''}
 ${content.relatedTopics ? `
 <div class="topic-related">
 <h4>Verwandte Themen</h4>
 <div class="related-topics-list">
 ${content.relatedTopics.map(rt => `
 <button class="related-topic-btn" onclick="closeTopicModal(); openTopicDetail('${rt}')">
 ${rt.replace(/_/g, ' ')}
 </button>
 `).join('')}
 </div>
 </div>
 ` : ''}
 </div>
 <div class="topic-modal-footer">
 <button class="topic-ask-btn" onclick="closeTopicModal(); askCoach('Ich habe eine Frage zu ${topic.title}')">
 Frage stellen
 </button>
 </div>
 </div>
 `;
 }

 modal.style.display = 'flex';
 document.body.style.overflow = 'hidden';
 }

 function closeTopicModal() {
 const modal = document.getElementById('topicDetailModal');
 if (modal) {
 modal.style.display = 'none';
 document.body.style.overflow = '';
 }
 }

 function checkQuizAnswer(topicId, questionIndex, selectedAnswer, correctAnswer) {
 const quizDiv = document.getElementById(`quiz-${topicId}-${questionIndex}`);
 if (!quizDiv) return;

 const options = quizDiv.querySelectorAll('.quiz-option');
 const explanation = quizDiv.querySelector('.quiz-explanation');

 options.forEach((opt, i) => {
 opt.disabled = true;
 if (i === correctAnswer) {
 opt.classList.add('correct');
 } else if (i === selectedAnswer && selectedAnswer !== correctAnswer) {
 opt.classList.add('incorrect');
 }
 });

 if (explanation) {
 explanation.style.display = 'block';
 }
 }

 function selectCoachTopic(topicId) {
 const topicQuestions = {
 basics: 'Was sind personenbezogene Daten?',
 gdpr: 'Erkl√§re mir die DSGVO',
 phishing: 'Wie erkenne ich Phishing?',
 passwords: 'Wie erstelle ich sichere Passw√∂rter?',
 social: 'Wie sch√ºtze ich meine Social Media Profile?',
 breaches: 'Was tun bei einem Datenleck?'
 };

 if (topicQuestions[topicId]) {
 askCoach(topicQuestions[topicId]);
 }
 }

 async function loadQuickTips() {
 const tipContainer = document.getElementById('coachDailyTip');
 if (!tipContainer) return;

 try {
 const response = await fetch(API_COACH_QUICK_TIPS_URL);
 if (response.ok) {
 const data = await response.json();
 if (data.success && data.tips && data.tips.length > 0) {
 const tip = data.tips[0];
 const challenge = data.dailyChallenge;

 tipContainer.innerHTML = `
 <div class="tip-icon">${tip.icon}</div>
 <div class="tip-content">
 <p>${tip.content}</p>
 ${tip.actionButton ? `
 <button class="tip-action-btn" onclick="openTopicDetail('${tip.actionButton.params?.topicId || 'password_security'}')">
 ${tip.actionButton.text}
 </button>
 ` : ''}
 </div>
 ${challenge ? `
 <div class="daily-challenge">
 <div class="challenge-header">
 <span class="challenge-icon">${challenge.icon || ''}</span>
 <span class="challenge-title">${challenge.title}</span>
 </div>
 <p class="challenge-desc">${challenge.description}</p>
 <span class="challenge-reward">${challenge.reward}</span>
 </div>
 ` : ''}
 `;
 return;
 }
 }
 } catch (error) {
 console.log('Using fallback tip:', error.message);
 }

 // Fallback - already has static content in HTML
 }

 async function handleCoachSubmit(e) {
 e.preventDefault();

 const input = document.getElementById('coachInput');
 const message = input.value.trim();

 if (!message) return;

 input.value = '';
 await askCoach(message);
 }

 async function askCoach(message) {
 // Add user message
 addCoachMessage(message, 'user');

 // Show typing indicator
 showTypingIndicator();

 // Hide suggestions while processing
 document.getElementById('coachSuggestions').innerHTML = '';

 try {
 // Try API first, fallback to client-side
 let response;
 try {
 const apiResponse = await fetch(API_COACH_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 sessionId: coachSessionId,
 message: message
 })
 });

 if (apiResponse.ok) {
 response = await apiResponse.json();
 } else {
 throw new Error('API unavailable');
 }
 } catch (apiError) {
 console.log('Using client-side coach');
 response = generateClientSideResponse(message);
 }

 // Remove typing indicator
 hideTypingIndicator();

 // Add coach response
 addCoachMessage(response.message || response, 'coach');

 // Show follow-up suggestions
 if (response.suggestions) {
 showSuggestions(response.suggestions);
 } else {
 showDefaultSuggestions();
 }

 } catch (error) {
 console.error('Coach error:', error);
 hideTypingIndicator();
 addCoachMessage('Entschuldigung, da ist etwas schiefgelaufen. Bitte versuche es erneut.', 'coach');
 }
 }

 function generateClientSideResponse(message) {
 const lowerMessage = message.toLowerCase();

 // Check each topic for matching keywords
 for (const [topicId, topic] of Object.entries(COACH_KNOWLEDGE.topics)) {
 for (const keyword of topic.keywords) {
 if (lowerMessage.includes(keyword)) {
 return {
 message: topic.response,
 suggestions: [
 { text: 'Noch eine Frage stellen', action: 'ask' },
 { text: 'Anderes Thema w√§hlen', action: 'topics' }
 ]
 };
 }
 }
 }

 // Fallback response
 return {
 message: COACH_KNOWLEDGE.fallback[Math.floor(Math.random() * COACH_KNOWLEDGE.fallback.length)],
 suggestions: [
 { text: 'Was sind personenbezogene Daten?', action: 'ask' },
 { text: 'Wie erkenne ich Phishing?', action: 'ask' },
 { text: 'DSGVO Rechte erkl√§ren', action: 'ask' }
 ]
 };
 }

 function addCoachMessage(content, role) {
 const messagesDiv = document.getElementById('coachMessages');
 if (!messagesDiv) return;

 const messageEl = document.createElement('div');
 messageEl.className = `coach-message ${role}`;
 const messageId = 'msg_' + Date.now();
 messageEl.id = messageId;

 const avatar = role === 'coach' ? '' : '';
 const formattedContent = formatCoachMessage(content);

 // Add feedback buttons for coach messages
 const feedbackHtml = role === 'coach' ? `
 <div class="message-feedback" data-message-id="${messageId}">
 <button class="feedback-btn helpful" onclick="submitFeedback('${messageId}', 'helpful')" title="Hilfreich">
 <span></span>
 </button>
 <button class="feedback-btn not-helpful" onclick="submitFeedback('${messageId}', 'not_helpful')" title="Nicht hilfreich">
 <span></span>
 </button>
 </div>
 ` : '';

 messageEl.innerHTML = `
 <div class="message-avatar">${avatar}</div>
 <div class="message-content">
 <div class="message-bubble">${formattedContent}</div>
 <div class="message-meta">
 <span class="message-time">${new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}</span>
 ${feedbackHtml}
 </div>
 </div>
 `;

 messagesDiv.appendChild(messageEl);
 messagesDiv.scrollTop = messagesDiv.scrollHeight;

 // Update current message ID for feedback
 if (role === 'coach') {
 currentMessageId = messageId;
 }

 // Store in conversation history
 coachConversation.push({ id: messageId, role, content, timestamp: new Date().toISOString() });
 }

 async function submitFeedback(messageId, rating) {
 const feedbackDiv = document.querySelector(`[data-message-id="${messageId}"]`);
 if (!feedbackDiv) return;

 // Disable buttons and show selected state
 const buttons = feedbackDiv.querySelectorAll('.feedback-btn');
 buttons.forEach(btn => {
 btn.disabled = true;
 if (btn.classList.contains(rating === 'helpful' ? 'helpful' : 'not-helpful')) {
 btn.classList.add('selected');
 }
 });

 try {
 await fetch(API_COACH_FEEDBACK_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 sessionId: coachSessionId,
 messageId: messageId,
 rating: rating
 })
 });

 // Show thank you message
 feedbackDiv.innerHTML = `<span class="feedback-thanks">Danke f√ºr dein Feedback!</span>`;
 } catch (error) {
 console.log('Feedback error:', error.message);
 feedbackDiv.innerHTML = `<span class="feedback-thanks">Danke!</span>`;
 }
 }

 function formatCoachMessage(content) {
 // Convert markdown-like formatting to HTML
 return content
 .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
 .replace(/\n\n/g, '</p><p>')
 .replace(/\n/g, '<br>')
 .replace(/^/, '<p>')
 .replace(/$/, '</p>');
 }

 function showTypingIndicator() {
 isCoachTyping = true;
 const messagesDiv = document.getElementById('coachMessages');
 if (!messagesDiv) return;

 const typingEl = document.createElement('div');
 typingEl.className = 'coach-message coach typing-indicator';
 typingEl.id = 'coachTyping';
 typingEl.innerHTML = `
 <div class="message-avatar"></div>
 <div class="message-content">
 <div class="message-bubble typing">
 <span class="dot"></span>
 <span class="dot"></span>
 <span class="dot"></span>
 </div>
 </div>
 `;

 messagesDiv.appendChild(typingEl);
 messagesDiv.scrollTop = messagesDiv.scrollHeight;
 }

 function hideTypingIndicator() {
 isCoachTyping = false;
 const typingEl = document.getElementById('coachTyping');
 if (typingEl) {
 typingEl.remove();
 }
 }

 function showSuggestions(suggestions) {
 const suggestionsDiv = document.getElementById('coachSuggestions');
 if (!suggestionsDiv) return;

 suggestionsDiv.innerHTML = suggestions.map(s => `
 <button class="coach-suggestion-btn" onclick="askCoach('${s.text.replace(/'/g, "\\'")}')">
 ${s.text}
 </button>
 `).join('');
 }

 function showDefaultSuggestions() {
 showSuggestions([
 { text: 'Erz√§hl mir mehr', action: 'ask' },
 { text: 'Anderes Thema', action: 'topics' },
 { text: 'Danke, das hilft!', action: 'end' }
 ]);
 }

 function toggleCoachMenu() {
 let menu = document.getElementById('coachMenuDropdown');

 if (menu) {
 // Toggle existing menu
 menu.classList.toggle('show');
 return;
 }

 // Create menu
 menu = document.createElement('div');
 menu.id = 'coachMenuDropdown';
 menu.className = 'coach-menu-dropdown show';
 menu.innerHTML = `
 <button class="coach-menu-item" onclick="clearCoachHistory()">
 <span>Chat l√∂schen</span>
 </button>
 <button class="coach-menu-item" onclick="exportCoachHistory()">
 <span>Chat exportieren</span>
 </button>
 <button class="coach-menu-item" onclick="openAllTopics()">
 <span>Alle Themen</span>
 </button>
 <div class="coach-menu-divider"></div>
 <button class="coach-menu-item" onclick="showCoachHelp()">
 <span>Hilfe</span>
 </button>
 `;

 // Add menu to header
 const header = document.querySelector('.coach-chat-header');
 if (header) {
 header.style.position = 'relative';
 header.appendChild(menu);
 }

 // Close menu when clicking outside
 document.addEventListener('click', function closeMenu(e) {
 if (!e.target.closest('.coach-menu-dropdown') && !e.target.closest('.coach-menu-btn')) {
 const dropdown = document.getElementById('coachMenuDropdown');
 if (dropdown) {
 dropdown.classList.remove('show');
 }
 document.removeEventListener('click', closeMenu);
 }
 });
 }

 function clearCoachHistory() {
 coachConversation = [];
 const messagesDiv = document.getElementById('coachMessages');
 if (messagesDiv) {
 messagesDiv.innerHTML = '';
 }
 showWelcomeMessage();
 toggleCoachMenu();
 }

 function exportCoachHistory() {
 if (coachConversation.length === 0) {
 alert('Keine Nachrichten zum Exportieren vorhanden.');
 return;
 }

 const exportData = {
 sessionId: coachSessionId,
 exportedAt: new Date().toISOString(),
 messages: coachConversation.map(msg => ({
 role: msg.role === 'coach' ? 'Privacy Coach' : 'Du',
 message: msg.content,
 time: msg.timestamp
 }))
 };

 const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `privacy-coach-chat-${new Date().toISOString().split('T')[0]}.json`;
 a.click();
 URL.revokeObjectURL(url);

 toggleCoachMenu();
 }

 function openAllTopics() {
 toggleCoachMenu();

 // Create topics overview modal
 let modal = document.getElementById('topicsOverviewModal');
 if (!modal) {
 modal = document.createElement('div');
 modal.id = 'topicsOverviewModal';
 modal.className = 'topic-modal-overlay';
 document.body.appendChild(modal);
 }

 const topicsData = window.coachTopicsData;
 let topicsHtml = '';

 if (topicsData && topicsData.categories) {
 topicsHtml = topicsData.categories.map(cat => `
 <div class="topics-category">
 <h4>${cat.icon} ${cat.name}</h4>
 <div class="topics-grid">
 ${cat.topics.map(topic => `
 <button class="topic-card" onclick="closeTopicsOverview(); openTopicDetail('${topic.id}')">
 <span class="topic-card-icon">${topic.icon}</span>
 <span class="topic-card-title">${topic.title}</span>
 <span class="topic-card-meta">${topic.difficulty} ‚Ä¢ ${topic.duration}</span>
 </button>
 `).join('')}
 </div>
 </div>
 `).join('');
 } else {
 // Fallback
 topicsHtml = COACH_TOPICS.map(topic => `
 <button class="topic-card" onclick="closeTopicsOverview(); selectCoachTopic('${topic.id}')">
 <span class="topic-card-icon">${topic.icon}</span>
 <span class="topic-card-title">${topic.title}</span>
 <span class="topic-card-desc">${topic.description}</span>
 </button>
 `).join('');
 }

 modal.innerHTML = `
 <div class="topic-modal large">
 <div class="topic-modal-header">
 <h3> Alle Lern-Themen</h3>
 <button class="topic-modal-close" onclick="closeTopicsOverview()"></button>
 </div>
 <div class="topic-modal-content">
 ${topicsHtml}
 </div>
 </div>
 `;

 modal.style.display = 'flex';
 document.body.style.overflow = 'hidden';
 }

 function closeTopicsOverview() {
 const modal = document.getElementById('topicsOverviewModal');
 if (modal) {
 modal.style.display = 'none';
 document.body.style.overflow = '';
 }
 }

 function showCoachHelp() {
 toggleCoachMenu();
 askCoach('Wie kann ich den Privacy Coach am besten nutzen? Zeige mir was du kannst!');
 }

 function attachTextForAnalysis() {
 const demoText = document.getElementById('demoText');
 if (demoText && demoText.value.trim()) {
 askCoach(`Analysiere diesen Text und erkl√§re die Risiken: "${demoText.value.trim().substring(0, 200)}..."`);
 } else {
 askCoach('Ich m√∂chte einen Text analysieren lassen. Wie funktioniert das?');
 }
 }

 // ========================================
 // Phase 13: Privacy Policy Analyzer
 // ========================================

 const API_POLICY_URL = `${API_BASE}/policy-analyze`;
 const API_POLICY_QUICK_URL = `${API_BASE}/policy-quick-check`;
 const API_POLICY_KNOWN_URL = `${API_BASE}/policy-known`;

 let currentPolicyInput = 'url';
 let lastPolicyResults = null;

 // Known services database for client-side fallback
 const KNOWN_SERVICES_DB = [
 { domain: 'facebook.com', name: 'Facebook', icon: '', score: 35, grade: 'D', category: 'social' },
 { domain: 'google.com', name: 'Google', icon: '', score: 45, grade: 'C', category: 'tech' },
 { domain: 'amazon.de', name: 'Amazon', icon: '', score: 40, grade: 'C', category: 'shopping' },
 { domain: 'tiktok.com', name: 'TikTok', icon: '', score: 25, grade: 'D', category: 'social' },
 { domain: 'twitter.com', name: 'X/Twitter', icon: '', score: 38, grade: 'D', category: 'social' },
 { domain: 'instagram.com', name: 'Instagram', icon: '', score: 32, grade: 'D', category: 'social' },
 { domain: 'whatsapp.com', name: 'WhatsApp', icon: '', score: 50, grade: 'C', category: 'messaging' },
 { domain: 'signal.org', name: 'Signal', icon: '', score: 92, grade: 'A', category: 'messaging' },
 { domain: 'proton.me', name: 'Proton', icon: '', score: 95, grade: 'A', category: 'privacy' },
 { domain: 'duckduckgo.com', name: 'DuckDuckGo', icon: '', score: 90, grade: 'A', category: 'search' },
 { domain: 'linkedin.com', name: 'LinkedIn', icon: '', score: 42, grade: 'C', category: 'professional' },
 { domain: 'spotify.com', name: 'Spotify', icon: '', score: 55, grade: 'C', category: 'entertainment' },
 { domain: 'netflix.com', name: 'Netflix', icon: '', score: 60, grade: 'B', category: 'entertainment' },
 { domain: 'zoom.us', name: 'Zoom', icon: '', score: 48, grade: 'C', category: 'communication' },
 { domain: 'microsoft.com', name: 'Microsoft', icon: 'ü™ü', score: 52, grade: 'C', category: 'tech' },
 { domain: 'apple.com', name: 'Apple', icon: '', score: 70, grade: 'B', category: 'tech' }
 ];

 // Red flags database
 const RED_FLAGS_DB = {
 'unlimited_sharing': { text: 'Unbegrenzte Datenweitergabe an Dritte', severity: 'high', icon: '' },
 'sell_data': { text: 'Verkauf personenbezogener Daten m√∂glich', severity: 'high', icon: '' },
 'no_deletion': { text: 'Keine garantierte Datenl√∂schung', severity: 'high', icon: '' },
 'vague_purposes': { text: 'Vage Zweckangaben bei Datennutzung', severity: 'medium', icon: '' },
 'third_party_tracking': { text: 'Tracking durch Drittanbieter', severity: 'medium', icon: '' },
 'location_tracking': { text: 'Permanente Standortverfolgung', severity: 'medium', icon: '' },
 'data_retention': { text: 'Unbegrenzte Speicherdauer', severity: 'medium', icon: '‚è∞' },
 'profiling': { text: 'Automatisierte Profilerstellung', severity: 'medium', icon: '' },
 'change_without_notice': { text: '√Ñnderungen ohne Benachrichtigung', severity: 'low', icon: '' },
 'forced_consent': { text: 'Erzwungene Zustimmung f√ºr Nutzung', severity: 'high', icon: '' }
 };

 // Data categories
 const DATA_CATEGORIES = {
 'personal_info': { label: 'Pers√∂nliche Daten', icon: '', examples: ['Name', 'E-Mail', 'Telefon', 'Adresse'] },
 'device_info': { label: 'Ger√§tedaten', icon: '', examples: ['IP-Adresse', 'Browser', 'Betriebssystem', 'Ger√§tekennungen'] },
 'location': { label: 'Standortdaten', icon: '', examples: ['GPS', 'Netzwerkbasiert', 'Zeitzone'] },
 'financial': { label: 'Finanzdaten', icon: '', examples: ['Zahlungsdaten', 'Kaufhistorie', 'Kontodaten'] },
 'behavioral': { label: 'Verhaltensdaten', icon: '', examples: ['Klickverhalten', 'Nutzungsdauer', 'Interessen'] },
 'social': { label: 'Soziale Daten', icon: '', examples: ['Kontakte', 'Follower', 'Interaktionen'] },
 'content': { label: 'Nutzungsinhalte', icon: '', examples: ['Nachrichten', 'Uploads', 'Kommentare'] },
 'biometric': { label: 'Biometrische Daten', icon: '', examples: ['Gesichtserkennung', 'Stimme', 'Fingerabdruck'] }
 };

 function initPolicyAnalyzer() {
 // URL form submission
 const urlForm = document.getElementById('policyUrlForm');
 if (urlForm) {
 urlForm.addEventListener('submit', handlePolicyUrlSubmit);
 }

 // Text form submission
 const textForm = document.getElementById('policyTextForm');
 if (textForm) {
 textForm.addEventListener('submit', handlePolicyTextSubmit);
 }

 // Load known services grid
 loadKnownServicesGrid();
 }

 function switchPolicyInput(inputType) {
 currentPolicyInput = inputType;

 // Update tabs
 document.querySelectorAll('.policy-input-tab').forEach(tab => {
 tab.classList.toggle('active', tab.dataset.input === inputType);
 });

 // Show/hide content sections
 document.getElementById('policyUrlInput').style.display = inputType === 'url' ? 'block' : 'none';
 document.getElementById('policyTextInput').style.display = inputType === 'text' ? 'block' : 'none';
 document.getElementById('policyKnownInput').style.display = inputType === 'known' ? 'block' : 'none';
 }

 function setPolicyUrl(url) {
 document.getElementById('policyUrl').value = url;
 document.getElementById('policyUrlForm').dispatchEvent(new Event('submit'));
 }

 function loadKnownServicesGrid() {
 const grid = document.getElementById('knownServicesGrid');
 if (!grid) return;

 grid.innerHTML = KNOWN_SERVICES_DB.map(service => `
 <div class="known-service-card grade-${service.grade.toLowerCase()}" onclick="analyzeKnownService('${service.domain}')">
 <span class="service-icon">${service.icon}</span>
 <span class="service-name">${service.name}</span>
 <span class="service-grade grade-badge-${service.grade.toLowerCase()}">${service.grade}</span>
 </div>
 `).join('');
 }

 async function handlePolicyUrlSubmit(e) {
 e.preventDefault();
 let url = document.getElementById('policyUrl').value.trim();

 if (!url) {
 alert('Bitte gib eine URL ein.');
 return;
 }

 // Add https:// if not present
 if (!url.startsWith('http')) {
 url = 'https://' + url;
 }

 await analyzePolicy({ type: 'url', value: url });
 }

 async function handlePolicyTextSubmit(e) {
 e.preventDefault();
 const text = document.getElementById('policyText').value.trim();

 if (!text) {
 alert('Bitte f√ºge einen Text ein.');
 return;
 }

 if (text.length < 100) {
 alert('Der Text ist zu kurz f√ºr eine Analyse. Bitte f√ºge die vollst√§ndige Datenschutzerkl√§rung ein.');
 return;
 }

 await analyzePolicy({ type: 'text', value: text });
 }

 async function analyzeKnownService(domain) {
 await analyzePolicy({ type: 'known', value: domain });
 }

 async function analyzePolicy(input) {
 // Show loading state
 const submitBtn = document.querySelector('.policy-input-content:not([style*="display: none"]) .analyze-btn');
 if (submitBtn) {
 submitBtn.querySelector('.btn-text').style.display = 'none';
 submitBtn.querySelector('.btn-loading').style.display = 'inline';
 submitBtn.disabled = true;
 }

 try {
 let results;

 // Try API first
 try {
 const endpoint = input.type === 'known' ? API_POLICY_KNOWN_URL : API_POLICY_URL;
 const response = await fetch(endpoint, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify(input.type === 'known' ? { domain: input.value } : input)
 });

 if (response.ok) {
 results = await response.json();
 } else {
 throw new Error('API unavailable');
 }
 } catch (apiError) {
 console.log('Using client-side policy analysis');
 results = performClientSidePolicyAnalysis(input);
 }

 lastPolicyResults = results;
 displayPolicyResults(results);

 } catch (error) {
 console.error('Policy analysis error:', error);
 alert('Fehler bei der Analyse. Bitte versuche es erneut.');
 } finally {
 if (submitBtn) {
 submitBtn.querySelector('.btn-text').style.display = 'inline';
 submitBtn.querySelector('.btn-loading').style.display = 'none';
 submitBtn.disabled = false;
 }
 }
 }

 function performClientSidePolicyAnalysis(input) {
 // Check if known service
 if (input.type === 'known' || input.type === 'url') {
 let domain = input.value;
 if (input.type === 'url') {
 try {
 domain = new URL(input.value.startsWith('http') ? input.value : 'https://' + input.value).hostname;
 } catch (e) {
 domain = input.value;
 }
 }

 // Find known service
 const knownService = KNOWN_SERVICES_DB.find(s =>
 domain.includes(s.domain) || s.domain.includes(domain.replace('www.', ''))
 );

 if (knownService) {
 return generateKnownServiceResults(knownService);
 }
 }

 // Client-side text analysis
 return generateTextAnalysisResults(input.value);
 }

 function generateKnownServiceResults(service) {
 const isGood = service.score >= 70;
 const isBad = service.score < 40;

 // Generate red flags based on score
 const redFlags = [];
 if (isBad) {
 const flagKeys = Object.keys(RED_FLAGS_DB);
 const numFlags = Math.floor(4 + Math.random() * 3);
 for (let i = 0; i < numFlags && i < flagKeys.length; i++) {
 redFlags.push({
 ...RED_FLAGS_DB[flagKeys[i]],
 id: flagKeys[i]
 });
 }
 } else if (!isGood) {
 const mediumFlags = ['vague_purposes', 'third_party_tracking', 'data_retention'];
 mediumFlags.slice(0, 2).forEach(key => {
 redFlags.push({ ...RED_FLAGS_DB[key], id: key });
 });
 }

 // Generate data collection info
 const dataCategories = Object.keys(DATA_CATEGORIES);
 const collectedData = dataCategories
 .filter(() => Math.random() > (isGood ? 0.6 : 0.2))
 .map(key => ({
 category: key,
 ...DATA_CATEGORIES[key],
 purpose: getPurposeForCategory(key)
 }));

 // Generate third parties
 const thirdParties = generateThirdParties(service.score);

 return {
 service: {
 name: service.name,
 domain: service.domain,
 icon: service.icon
 },
 score: service.score,
 grade: service.grade,
 gradeLabel: getGradeLabel(service.grade),
 tldr: generateTldr(service),
 keyPoints: generateKeyPoints(service, redFlags.length),
 redFlags: redFlags,
 breakdown: generateBreakdown(service.score),
 dataCollection: collectedData,
 thirdParties: thirdParties,
 recommendations: generateRecommendations(service, redFlags),
 alternatives: getAlternatives(service)
 };
 }

 function generateTextAnalysisResults(text) {
 // Simple keyword analysis
 const lowerText = text.toLowerCase();

 // Calculate score based on keywords
 let score = 50;
 const redFlags = [];

 // Negative keywords
 const negativeKeywords = {
 'dritte': -5, 'weitergabe': -5, 'verkauf': -10, 'werbung': -5,
 'tracking': -8, 'partner': -3, 'affiliate': -5, 'marketing': -5,
 'unbegrenzt': -7, 'permanent': -5
 };

 // Positive keywords
 const positiveKeywords = {
 'verschl√ºssel': 5, 'l√∂sch': 5, 'auskunft': 5, 'widerruf': 5,
 'gdpr': 8, 'dsgvo': 8, 'datenschutzbeauftragter': 5,
 'minimierung': 5, 'anonymisier': 8
 };

 for (const [word, impact] of Object.entries(negativeKeywords)) {
 if (lowerText.includes(word)) {
 score += impact;
 if (impact <= -7) {
 redFlags.push({
 text: `Kritischer Begriff gefunden: "${word}"`,
 severity: 'medium',
 icon: ''
 });
 }
 }
 }

 for (const [word, impact] of Object.entries(positiveKeywords)) {
 if (lowerText.includes(word)) {
 score += impact;
 }
 }

 score = Math.max(0, Math.min(100, score));
 const grade = scoreToGrade(score);

 return {
 service: {
 name: 'Benutzerdefinierte Analyse',
 domain: 'text-analyse',
 icon: ''
 },
 score: score,
 grade: grade,
 gradeLabel: getGradeLabel(grade),
 tldr: `Diese Datenschutzerkl√§rung erh√§lt einen Score von ${score}/100 (${grade}). ${score < 50 ? 'Es wurden einige bedenkliche Formulierungen gefunden.' : 'Die Richtlinie enth√§lt grundlegende Datenschutzprinzipien.'}`,
 keyPoints: [
 { type: 'info', text: `Text mit ${text.length} Zeichen analysiert` },
 { type: score >= 50 ? 'positive' : 'negative', text: score >= 50 ? 'Grundlegende DSGVO-Konformit√§t erkennbar' : 'M√∂glicherweise DSGVO-kritische Formulierungen' }
 ],
 redFlags: redFlags,
 breakdown: generateBreakdown(score),
 dataCollection: [],
 thirdParties: [],
 recommendations: [
 { priority: 1, text: 'Vollst√§ndige Analyse mit Backend f√ºr detaillierte Ergebnisse' }
 ],
 alternatives: []
 };
 }

 function scoreToGrade(score) {
 if (score >= 85) return 'A';
 if (score >= 70) return 'B';
 if (score >= 50) return 'C';
 if (score >= 30) return 'D';
 return 'F';
 }

 function getGradeLabel(grade) {
 const labels = {
 'A': 'Ausgezeichnet',
 'B': 'Gut',
 'C': 'Akzeptabel',
 'D': 'Mangelhaft',
 'F': 'Ungen√ºgend'
 };
 return labels[grade] || 'Unbekannt';
 }

 function generateTldr(service) {
 const tldrs = {
 'A': `${service.name} bietet eine vorbildliche Datenschutzrichtlinie mit klaren Angaben, minimaler Datensammlung und starkem Nutzerschutz. Empfehlenswert!`,
 'B': `${service.name} hat eine solide Datenschutzrichtlinie mit guten Grundprinzipien. Einige Bereiche k√∂nnten transparenter sein.`,
 'C': `${service.name} erf√ºllt grundlegende Datenschutzanforderungen, aber es gibt Verbesserungspotential bei Transparenz und Datenminimierung.`,
 'D': `${service.name} sammelt umfangreiche Daten und teilt diese mit vielen Partnern. Die Richtlinie ist wenig nutzerfreundlich.`,
 'F': `Vorsicht: ${service.name} hat erhebliche Datenschutzm√§ngel. Umfangreiche Datensammlung, vage Formulierungen und weitreichende Datenweitergabe.`
 };
 return tldrs[service.grade] || tldrs['C'];
 }

 function generateKeyPoints(service, numRedFlags) {
 const points = [];

 if (service.score >= 70) {
 points.push({ type: 'positive', text: 'Transparente Datennutzung' });
 points.push({ type: 'positive', text: 'Starke Nutzerkontrolle' });
 points.push({ type: 'positive', text: 'Datenminimierung beachtet' });
 } else if (service.score >= 50) {
 points.push({ type: 'neutral', text: 'Grundlegende Transparenz vorhanden' });
 points.push({ type: 'negative', text: 'Tracking durch Drittanbieter' });
 points.push({ type: 'info', text: 'DSGVO-Rechte werden erw√§hnt' });
 } else {
 points.push({ type: 'negative', text: 'Umfangreiche Datensammlung' });
 points.push({ type: 'negative', text: 'Weitergabe an viele Partner' });
 points.push({ type: 'negative', text: 'Wenig Transparenz √ºber Verwendung' });
 }

 if (numRedFlags > 3) {
 points.push({ type: 'negative', text: `${numRedFlags} kritische Warnsignale gefunden` });
 }

 return points;
 }

 function generateBreakdown(overallScore) {
 // Generate sub-scores based on overall score with some variance
 const variance = () => Math.floor(Math.random() * 20) - 10;

 return {
 transparency: Math.max(0, Math.min(100, overallScore + variance())),
 dataMinimization: Math.max(0, Math.min(100, overallScore + variance())),
 userControl: Math.max(0, Math.min(100, overallScore + variance())),
 security: Math.max(0, Math.min(100, overallScore + variance() + 10)),
 thirdPartySharing: Math.max(0, Math.min(100, overallScore + variance() - 5)),
 gdprCompliance: Math.max(0, Math.min(100, overallScore + variance() + 5))
 };
 }

 function getPurposeForCategory(category) {
 const purposes = {
 'personal_info': 'Kontoverwaltung, Kundenservice',
 'device_info': 'Sicherheit, Fehlerbehebung, Analyse',
 'location': 'Lokalisierte Dienste, Werbung',
 'financial': 'Zahlungsabwicklung, Betrugspr√§vention',
 'behavioral': 'Personalisierung, Werbung, Analyse',
 'social': 'Empfehlungen, soziale Funktionen',
 'content': 'Bereitstellung des Dienstes',
 'biometric': 'Authentifizierung, Sicherheit'
 };
 return purposes[category] || 'Dienstbereitstellung';
 }

 function generateThirdParties(score) {
 const allParties = [
 { name: 'Google Analytics', category: 'Analyse', risk: 'medium' },
 { name: 'Facebook Pixel', category: 'Werbung', risk: 'high' },
 { name: 'Stripe', category: 'Zahlung', risk: 'low' },
 { name: 'CloudFlare', category: 'Sicherheit', risk: 'low' },
 { name: 'Hotjar', category: 'Analyse', risk: 'medium' },
 { name: 'DoubleClick', category: 'Werbung', risk: 'high' },
 { name: 'Amazon AWS', category: 'Hosting', risk: 'low' },
 { name: 'Mixpanel', category: 'Analyse', risk: 'medium' },
 { name: 'Criteo', category: 'Werbung', risk: 'high' },
 { name: 'Salesforce', category: 'CRM', risk: 'medium' }
 ];

 // Lower score = more third parties
 const numParties = score >= 70 ? 2 : score >= 50 ? 5 : 8;
 return allParties.slice(0, numParties);
 }

 function generateRecommendations(service, redFlags) {
 const recs = [];

 if (service.score < 50) {
 recs.push({ priority: 1, text: `Erw√§ge datenschutzfreundlichere Alternativen zu ${service.name}` });
 }

 if (redFlags.length > 0) {
 recs.push({ priority: 2, text: '√úberpr√ºfe die Datenschutzeinstellungen im Dienst' });
 }

 recs.push({ priority: 3, text: 'Nutze nur notwendige Funktionen' });

 if (service.score < 70) {
 recs.push({ priority: 4, text: 'Gib nur minimal notwendige Daten preis' });
 recs.push({ priority: 5, text: 'Pr√ºfe regelm√§√üig gespeicherte Daten und fordere L√∂schung an' });
 }

 return recs;
 }

 function getAlternatives(service) {
 const alternatives = {
 'facebook.com': ['Mastodon', 'Diaspora'],
 'google.com': ['DuckDuckGo', 'Startpage'],
 'whatsapp.com': ['Signal', 'Threema'],
 'instagram.com': ['Pixelfed'],
 'twitter.com': ['Mastodon', 'Bluesky'],
 'tiktok.com': ['BeReal'],
 'zoom.us': ['Jitsi Meet'],
 'amazon.de': ['lokale H√§ndler']
 };
 return alternatives[service.domain] || [];
 }

 function displayPolicyResults(results) {
 const container = document.getElementById('policyResults');
 container.style.display = 'block';

 // Update score circle
 const scoreValue = document.getElementById('policyScoreValue');
 const scoreFill = document.getElementById('policyScoreFill');
 const scoreGrade = document.getElementById('policyScoreGrade');
 const scoreLabel = document.getElementById('policyScoreLabel');
 const serviceName = document.getElementById('policyServiceName');
 const scoreSummary = document.getElementById('policyScoreSummary');

 scoreValue.textContent = results.score;
 scoreGrade.textContent = results.grade;
 scoreLabel.textContent = results.gradeLabel;
 serviceName.textContent = results.service.icon + ' ' + results.service.name;

 // Animate score circle
 const circumference = 2 * Math.PI * 45;
 const offset = circumference - (results.score / 100) * circumference;
 scoreFill.style.strokeDasharray = circumference;
 scoreFill.style.strokeDashoffset = offset;

 // Color based on grade
 const colors = { A: '#4caf50', B: '#8bc34a', C: '#ff9800', D: '#f44336', F: '#9c27b0' };
 const color = colors[results.grade] || '#ff9800';
 scoreFill.style.stroke = color;
 scoreGrade.style.color = color;

 // TLDR
 document.getElementById('policyTldrText').textContent = results.tldr;

 // Key Points
 const keyPointsList = document.getElementById('keyPointsList');
 keyPointsList.innerHTML = results.keyPoints.map(point => `
 <div class="key-point ${point.type}">
 <span class="point-icon">${point.type === 'positive' ? '' : point.type === 'negative' ? '' : '‚Ñπ'}</span>
 <span class="point-text">${point.text}</span>
 </div>
 `).join('');

 // Red Flags
 const redFlagsSection = document.getElementById('policyRedFlags');
 const redFlagsList = document.getElementById('redFlagsList');
 if (results.redFlags && results.redFlags.length > 0) {
 redFlagsSection.style.display = 'block';
 redFlagsList.innerHTML = results.redFlags.map(flag => `
 <div class="red-flag-item severity-${flag.severity}">
 <span class="flag-icon">${flag.icon}</span>
 <span class="flag-text">${flag.text}</span>
 <span class="severity-badge">${flag.severity}</span>
 </div>
 `).join('');
 } else {
 redFlagsSection.style.display = 'none';
 }

 // Breakdown
 const breakdownGrid = document.getElementById('breakdownGrid');
 if (results.breakdown) {
 const labels = {
 transparency: 'Transparenz',
 dataMinimization: 'Datenminimierung',
 userControl: 'Nutzerkontrolle',
 security: 'Sicherheit',
 thirdPartySharing: 'Datenweitergabe',
 gdprCompliance: 'DSGVO-Konformit√§t'
 };
 breakdownGrid.innerHTML = Object.entries(results.breakdown).map(([key, value]) => `
 <div class="breakdown-item">
 <span class="breakdown-label">${labels[key] || key}</span>
 <div class="breakdown-bar">
 <div class="breakdown-fill" style="width: ${value}%; background: ${value >= 70 ? '#4caf50' : value >= 50 ? '#ff9800' : '#f44336'}"></div>
 </div>
 <span class="breakdown-value">${value}%</span>
 </div>
 `).join('');
 }

 // Data Collection
 const dataList = document.getElementById('dataCollectionList');
 if (results.dataCollection && results.dataCollection.length > 0) {
 dataList.innerHTML = results.dataCollection.map(data => `
 <div class="data-category-item">
 <span class="data-icon">${data.icon}</span>
 <div class="data-info">
 <strong>${data.label}</strong>
 <span class="data-examples">${data.examples.join(', ')}</span>
 <span class="data-purpose">Zweck: ${data.purpose}</span>
 </div>
 </div>
 `).join('');
 } else {
 dataList.innerHTML = '<p class="no-data">Keine detaillierten Informationen zur Datensammlung verf√ºgbar.</p>';
 }

 // Third Parties
 document.getElementById('thirdPartyCount').textContent = results.thirdParties?.length || 0;
 const thirdPartiesList = document.getElementById('thirdPartiesList');
 if (results.thirdParties && results.thirdParties.length > 0) {
 thirdPartiesList.innerHTML = results.thirdParties.map(party => `
 <div class="third-party-item risk-${party.risk}">
 <span class="party-name">${party.name}</span>
 <span class="party-category">${party.category}</span>
 <span class="party-risk risk-badge-${party.risk}">${party.risk}</span>
 </div>
 `).join('');
 } else {
 thirdPartiesList.innerHTML = '<p class="no-data">Keine Drittanbieter-Informationen verf√ºgbar.</p>';
 }

 // Recommendations
 const recsList = document.getElementById('policyRecommendationsList');
 if (results.recommendations && results.recommendations.length > 0) {
 recsList.innerHTML = results.recommendations.map(rec => `
 <div class="policy-recommendation-item priority-${rec.priority}">
 <span class="rec-priority">${rec.priority}</span>
 <span class="rec-text">${rec.text}</span>
 </div>
 `).join('');
 }

 // Alternatives
 if (results.alternatives && results.alternatives.length > 0) {
 document.getElementById('betterAlternativesText').textContent =
 `Bessere Alternativen: ${results.alternatives.join(', ')}`;
 }

 // Scroll to results
 container.scrollIntoView({ behavior: 'smooth' });
 }

 function togglePolicySection(sectionId) {
 const section = document.getElementById(sectionId);
 const header = section.previousElementSibling;
 const toggle = header.querySelector('.section-toggle');

 if (section.style.display === 'none') {
 section.style.display = 'block';
 toggle.textContent = '‚ñº';
 } else {
 section.style.display = 'none';
 toggle.textContent = '‚ñ∂';
 }
 }

 function showBetterAlternatives() {
 if (!lastPolicyResults || !lastPolicyResults.alternatives || lastPolicyResults.alternatives.length === 0) {
 alert('Keine alternativen Dienste bekannt. Nutze die Suchfunktion f√ºr datenschutzfreundliche Alternativen.');
 return;
 }

 const alternatives = lastPolicyResults.alternatives;
 const altServices = KNOWN_SERVICES_DB.filter(s =>
 alternatives.some(alt => s.name.toLowerCase().includes(alt.toLowerCase()))
 );

 if (altServices.length > 0) {
 switchPolicyInput('known');
 setTimeout(() => {
 const grid = document.getElementById('knownServicesGrid');
 grid.innerHTML = altServices.map(service => `
 <div class="known-service-card grade-${service.grade.toLowerCase()} highlighted" onclick="analyzeKnownService('${service.domain}')">
 <span class="service-icon">${service.icon}</span>
 <span class="service-name">${service.name}</span>
 <span class="service-grade grade-badge-${service.grade.toLowerCase()}">${service.grade}</span>
 <span class="service-recommended"> Empfohlen</span>
 </div>
 `).join('') + `
 <button class="show-all-btn" onclick="loadKnownServicesGrid()">Alle Dienste anzeigen</button>
 `;
 }, 100);
 } else {
 alert(`Empfohlene Alternativen: ${alternatives.join(', ')}`);
 }
 }

 // ========================================
 // Phase 9: Data Breach Alerts
 // ========================================

 const API_ALERTS_SUBSCRIBE_URL = `${API_BASE}/alerts-subscribe`;
 const API_ALERTS_STATUS_URL = `${API_BASE}/alerts-status`;
 const API_ALERTS_RECENT_URL = `${API_BASE}/alerts-recent`;

 function initDataBreachAlerts() {
 const subscribeForm = document.getElementById('alertsSubscribeForm');
 const statusForm = document.getElementById('alertsStatusForm');

 if (subscribeForm) {
 subscribeForm.addEventListener('submit', handleAlertsSubscribe);
 }

 if (statusForm) {
 statusForm.addEventListener('submit', handleAlertsStatus);
 }

 // Load recent breaches
 loadRecentBreaches();
 }

 async function handleAlertsSubscribe(e) {
 e.preventDefault();

 const email = document.getElementById('alertsEmail').value.trim();
 const instant = document.getElementById('alertsInstant').checked;
 const weekly = document.getElementById('alertsWeekly').checked;
 const resultDiv = document.getElementById('alertsSubscribeResult');
 const btn = e.target.querySelector('.subscribe-btn');

 if (!email) return;

 btn.querySelector('.btn-text').style.display = 'none';
 btn.querySelector('.btn-loading').style.display = 'inline';
 btn.disabled = true;

 try {
 const response = await fetch(API_ALERTS_SUBSCRIBE_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 email: email,
 notificationPreferences: {
 instant: instant,
 weekly_digest: weekly,
 severity_threshold: 'medium'
 }
 })
 });

 const data = await response.json();

 if (data.success) {
 resultDiv.innerHTML = `
 <div class="result-success">
 <div>
 <strong>${data.message}</strong>
 ${data.note ? `<p class="result-note">${data.note}</p>` : ''}
 </div>
 </div>
 `;
 document.getElementById('alertsEmail').value = '';
 } else {
 throw new Error(data.error || 'Registrierung fehlgeschlagen');
 }

 } catch (error) {
 resultDiv.innerHTML = `
 <div class="result-error">
 <span>${error.message}</span>
 </div>
 `;
 }

 resultDiv.style.display = 'block';
 btn.querySelector('.btn-text').style.display = 'inline';
 btn.querySelector('.btn-loading').style.display = 'none';
 btn.disabled = false;
 }

 async function handleAlertsStatus(e) {
 e.preventDefault();

 const email = document.getElementById('alertsStatusEmail').value.trim();
 const resultDiv = document.getElementById('alertsStatusResult');

 if (!email) return;

 resultDiv.innerHTML = '<span class="loading-text">Pr√ºfe...</span>';
 resultDiv.style.display = 'block';

 try {
 const response = await fetch(`${API_ALERTS_STATUS_URL}?email=${encodeURIComponent(email)}`);
 const data = await response.json();

 if (data.success) {
 if (data.status === 'active') {
 resultDiv.innerHTML = `
 <div class="status-active">
 <div>
 <strong>Monitoring aktiv</strong>
 <p>Seit: ${new Date(data.subscribedAt).toLocaleDateString('de-DE')}</p>
 ${data.breachesFound > 0 ? `<p class="breach-count"> ${data.breachesFound} Datenleck(s) gefunden</p>` : '<p class="no-breaches"> Keine Datenlecks gefunden</p>'}
 </div>
 </div>
 `;
 } else {
 resultDiv.innerHTML = `
 <div class="status-inactive">
 <span>${data.message}</span>
 </div>
 `;
 }
 }

 } catch (error) {
 resultDiv.innerHTML = `<span class="error-text">Fehler bei der Abfrage</span>`;
 }
 }

 async function loadRecentBreaches() {
 const listDiv = document.getElementById('recentBreachesList');
 const lastUpdatedSpan = document.getElementById('breachesLastUpdated');
 const thisMonthSpan = document.getElementById('breachesThisMonth');
 const affectedSpan = document.getElementById('breachesAffectedUsers');

 try {
 const response = await fetch(API_ALERTS_RECENT_URL);
 const data = await response.json();

 if (data.success && data.breaches) {
 thisMonthSpan.textContent = data.totalBreachesThisMonth || data.breaches.length;
 affectedSpan.textContent = data.totalAffectedUsers || '--';
 lastUpdatedSpan.textContent = `Aktualisiert: ${new Date(data.lastUpdated).toLocaleString('de-DE')}`;

 listDiv.innerHTML = data.breaches.map(breach => `
 <div class="breach-card severity-${breach.severity}">
 <div class="breach-header">
 <span class="breach-icon">${breach.icon || ''}</span>
 <div class="breach-info">
 <h4>${breach.name}</h4>
 <span class="breach-date">${new Date(breach.date).toLocaleDateString('de-DE')}</span>
 </div>
 <span class="severity-badge ${breach.severity}">${breach.severityInfo?.label || breach.severity}</span>
 </div>
 <div class="breach-details">
 <p class="breach-description">${breach.description || ''}</p>
 <div class="breach-stats">
 <span class="affected-users"> ${(breach.affectedUsers / 1000000).toFixed(1)}M betroffen</span>
 </div>
 <div class="breach-data-types">
 ${(breach.dataTypes || []).map(dt => `<span class="data-type-tag">${breach.dataTypesInfo?.find(d => d.label)?.icon || ''} ${breach.dataTypesInfo?.find(d => d.label)?.label || dt}</span>`).join('')}
 </div>
 </div>
 </div>
 `).join('');
 }

 } catch (error) {
 console.log('Error loading breaches:', error);
 listDiv.innerHTML = '<p class="error-text">Fehler beim Laden der Datenlecks</p>';
 }
 }

 // ========================================
 // Phase 11: Privacy Templates
 // ========================================

 const API_TEMPLATES_CATEGORIES_URL = `${API_BASE}/templates-categories`;
 const API_TEMPLATES_LIST_URL = `${API_BASE}/templates-list`;
 const API_TEMPLATES_DETAIL_URL = `${API_BASE}/templates-detail`;
 const API_TEMPLATES_ANALYZE_URL = `${API_BASE}/templates-analyze`;
 const API_TEMPLATES_GDPR_URL = `${API_BASE}/templates-gdpr`;
 const API_TEMPLATES_SEARCH_URL = `${API_BASE}/templates-search`;
 const API_TEMPLATES_FAVORITES_URL = `${API_BASE}/templates-favorites`;
 const API_TEMPLATES_CUSTOMIZE_URL = `${API_BASE}/templates-customize`;

 let currentTemplateCategory = null;
 let currentTemplate = null;
 let currentVariant = null;
 let templateFavorites = JSON.parse(localStorage.getItem('templateFavorites') || '[]');

 function initPrivacyTemplates() {
 const analyzeForm = document.getElementById('templatesAnalyzeForm');
 if (analyzeForm) {
 analyzeForm.addEventListener('submit', handleTemplateAnalyze);
 }

 const searchInput = document.getElementById('templatesSearchInput');
 if (searchInput) {
 searchInput.addEventListener('input', debounce(handleTemplateSearch, 300));
 }

 // Load categories
 loadTemplateCategories();
 }

 function debounce(func, wait) {
 let timeout;
 return function executedFunction(...args) {
 clearTimeout(timeout);
 timeout = setTimeout(() => func.apply(this, args), wait);
 };
 }

 async function loadTemplateCategories() {
 const grid = document.getElementById('templatesCategoriesGrid');

 try {
 const response = await fetch(API_TEMPLATES_CATEGORIES_URL);
 const data = await response.json();

 if (data.success && data.categories) {
 grid.innerHTML = data.categories.map(cat => `
 <button class="template-category-card" onclick="selectTemplateCategory('${cat.id}')" style="--cat-color: ${cat.color || '#2196f3'}">
 <span class="category-icon">${cat.icon}</span>
 <h4>${cat.name}</h4>
 <p>${cat.description}</p>
 <span class="template-count">${cat.templateCount} Templates</span>
 </button>
 `).join('');
 }

 } catch (error) {
 console.log('Error loading categories:', error);
 grid.innerHTML = '<p class="error-text">Fehler beim Laden der Kategorien</p>';
 }
 }

 async function selectTemplateCategory(categoryId) {
 currentTemplateCategory = categoryId;

 const categoriesGrid = document.getElementById('templatesCategoriesGrid');
 const browser = document.getElementById('templatesBrowser');
 const list = document.getElementById('templatesList');
 const title = document.getElementById('templatesCategoryTitle');

 categoriesGrid.style.display = 'none';
 browser.style.display = 'block';
 list.innerHTML = '<div class="loading-placeholder">Lade Templates...</div>';

 try {
 const response = await fetch(`${API_TEMPLATES_LIST_URL}?categoryId=${categoryId}`);
 const data = await response.json();

 if (data.success) {
 title.innerHTML = `${data.category.icon} ${data.category.name}`;

 list.innerHTML = data.templates.map(t => `
 <button class="template-list-item" onclick="selectTemplate('${t.id}')">
 <div class="template-item-info">
 <h4>${t.name}</h4>
 <p>${t.description}</p>
 <div class="template-tags">
 ${t.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
 </div>
 </div>
 <div class="template-item-meta">
 <div class="privacy-score-mini" style="--score: ${t.privacyScore}%">
 <span class="score-value">${t.privacyScore}</span>
 </div>
 <span class="popularity"> ${t.popularity}</span>
 </div>
 </button>
 `).join('');
 }

 } catch (error) {
 list.innerHTML = '<p class="error-text">Fehler beim Laden</p>';
 }
 }

 function showTemplateCategories() {
 document.getElementById('templatesCategoriesGrid').style.display = 'grid';
 document.getElementById('templatesBrowser').style.display = 'none';
 document.getElementById('templateDetail').style.display = 'none';
 }

 function backToTemplatesList() {
 document.getElementById('templatesBrowser').style.display = 'block';
 document.getElementById('templateDetail').style.display = 'none';
 }

 async function selectTemplate(templateId) {
 const browser = document.getElementById('templatesBrowser');
 const detail = document.getElementById('templateDetail');
 const title = document.getElementById('templateDetailTitle');
 const badge = document.getElementById('templatePrivacyBadge');
 const variantsDiv = document.getElementById('templateVariants');
 const tipsDiv = document.getElementById('templateTips');
 const preview = document.getElementById('templatePreviewContent');
 const customizer = document.getElementById('templateCustomizer');

 browser.style.display = 'none';
 detail.style.display = 'block';

 try {
 const response = await fetch(`${API_TEMPLATES_DETAIL_URL}?templateId=${templateId}`);
 const data = await response.json();

 if (data.success && data.template) {
 currentTemplate = data.template;

 title.textContent = data.template.name;
 badge.querySelector('.badge-score').textContent = data.template.privacyScore;

 // Render variants
 variantsDiv.innerHTML = `
 <h4>Varianten w√§hlen</h4>
 <div class="variants-grid">
 ${data.template.variants.map((v, i) => `
 <button class="variant-btn ${i === 0 ? 'active' : ''}" onclick="selectVariant('${v.id}', this)">
 <span class="variant-name">${v.name}</span>
 <span class="variant-tone">${v.tone}</span>
 </button>
 `).join('')}
 </div>
 `;

 // Select first variant
 if (data.template.variants.length > 0) {
 currentVariant = data.template.variants[0];
 preview.textContent = currentVariant.content;
 }

 // Render placeholders if customizable
 if (data.template.customizable && data.template.placeholders) {
 customizer.style.display = 'block';
 const fieldsDiv = document.getElementById('customizerFields');
 fieldsDiv.innerHTML = data.template.placeholders.map(p => `
 <div class="customizer-field">
 <label>${p.key.replace(/\{\{|\}\}/g, '')}</label>
 <input type="text" data-placeholder="${p.key}" placeholder="${p.examples ? p.examples[0] : ''}" oninput="updateTemplatePreview()">
 <span class="field-hint">${p.description}</span>
 </div>
 `).join('');
 } else {
 customizer.style.display = 'none';
 }

 // Render tips
 if (data.template.tips || data.template.doNot) {
 tipsDiv.innerHTML = `
 ${data.template.tips ? `
 <div class="tips-section tips-do">
 <h5> Tipps</h5>
 <ul>${data.template.tips.map(t => `<li>${t}</li>`).join('')}</ul>
 </div>
 ` : ''}
 ${data.template.doNot ? `
 <div class="tips-section tips-dont">
 <h5> Vermeide</h5>
 <ul>${data.template.doNot.map(t => `<li>${t}</li>`).join('')}</ul>
 </div>
 ` : ''}
 `;
 }
 }

 } catch (error) {
 detail.innerHTML = '<p class="error-text">Fehler beim Laden des Templates</p>';
 }
 }

 function selectVariant(variantId, btn) {
 if (!currentTemplate) return;

 currentVariant = currentTemplate.variants.find(v => v.id === variantId);
 if (!currentVariant) return;

 // Update active state
 document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
 btn.classList.add('active');

 // Update preview
 updateTemplatePreview();
 }

 function updateTemplatePreview() {
 if (!currentVariant) return;

 let content = currentVariant.content;

 // Replace placeholders with user input
 document.querySelectorAll('#customizerFields input').forEach(input => {
 const placeholder = input.dataset.placeholder;
 const value = input.value || placeholder.replace(/\{\{|\}\}/g, '');
 content = content.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
 });

 document.getElementById('templatePreviewContent').textContent = content;
 }

 function copyTemplateToClipboard() {
 const content = document.getElementById('templatePreviewContent').textContent;
 navigator.clipboard.writeText(content).then(() => {
 const btn = document.querySelector('.copy-btn');
 const originalText = btn.innerHTML;
 btn.innerHTML = '<span> Kopiert!</span>';
 setTimeout(() => {
 btn.innerHTML = originalText;
 }, 2000);
 });
 }

 async function handleTemplateAnalyze(e) {
 e.preventDefault();

 const text = document.getElementById('templatesAnalyzeText').value.trim();
 const context = document.getElementById('templatesAnalyzeContext').value;
 const resultDiv = document.getElementById('templatesAnalyzeResult');

 if (!text) return;

 resultDiv.innerHTML = '<div class="loading-text">Analysiere...</div>';
 resultDiv.style.display = 'block';

 try {
 const response = await fetch(API_TEMPLATES_ANALYZE_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({ text, context })
 });

 const data = await response.json();

 if (data.success && data.analysis) {
 const a = data.analysis;
 const gradeColor = a.grade === 'A' ? '#4caf50' : a.grade === 'B' ? '#8bc34a' : a.grade === 'C' ? '#ffc107' : a.grade === 'D' ? '#ff9800' : '#f44336';

 resultDiv.innerHTML = `
 <div class="analyze-result-card">
 <div class="result-header">
 <div class="result-score" style="--grade-color: ${gradeColor}">
 <span class="score-value">${a.privacyScore}</span>
 <span class="score-grade">${a.grade}</span>
 </div>
 <div class="result-summary">
 <h4>Privacy Score</h4>
 <p>${a.issues.length === 0 ? 'Keine Datenschutz-Probleme gefunden!' : `${a.issues.length} Problem(e) gefunden`}</p>
 </div>
 </div>

 ${a.issues.length > 0 ? `
 <div class="result-issues">
 <h5>Gefundene Probleme:</h5>
 ${a.issues.map(issue => `
 <div class="issue-item severity-${issue.severity}">
 <span class="issue-found">"${issue.found}"</span>
 <span class="issue-suggestion">${issue.suggestion}</span>
 </div>
 `).join('')}
 </div>
 ` : ''}

 ${a.suggestedVersion && a.suggestedVersion !== text ? `
 <div class="result-suggestion">
 <h5> Verbesserter Text:</h5>
 <div class="suggested-text">${a.suggestedVersion}</div>
 <button class="copy-suggestion-btn" onclick="navigator.clipboard.writeText('${a.suggestedVersion.replace(/'/g, "\\'")}'); this.textContent = ' Kopiert!'">
 Kopieren
 </button>
 </div>
 ` : ''}
 </div>
 `;
 }

 } catch (error) {
 resultDiv.innerHTML = '<p class="error-text">Fehler bei der Analyse</p>';
 }
 }

 // DSGVO Generator Functions
 async function openGdprGenerator(requestType = 'access') {
 const gdprTypes = [
 { id: 'access', name: 'Auskunft', icon: '', description: 'Erfahre welche Daten gespeichert sind' },
 { id: 'deletion', name: 'L√∂schung', icon: '', description: 'Fordere die L√∂schung deiner Daten' },
 { id: 'rectification', name: 'Berichtigung', icon: '', description: 'Korrigiere falsche Daten' },
 { id: 'portability', name: 'Daten√ºbertragung', icon: '', description: 'Erhalte deine Daten zum Mitnehmen' },
 { id: 'objection', name: 'Widerspruch', icon: '', description: 'Widerspreche der Datenverarbeitung' }
 ];

 let modal = document.getElementById('gdprGeneratorModal');
 if (!modal) {
 modal = document.createElement('div');
 modal.id = 'gdprGeneratorModal';
 modal.className = 'topic-modal-overlay';
 document.body.appendChild(modal);
 }

 modal.innerHTML = `
 <div class="topic-modal large">
 <div class="topic-modal-header">
 <h3> DSGVO-Anfrage Generator</h3>
 <button class="topic-modal-close" onclick="closeGdprGenerator()"></button>
 </div>
 <div class="topic-modal-content">
 <div class="gdpr-type-selector">
 <h4>Welche Anfrage m√∂chtest du stellen?</h4>
 <div class="gdpr-types-grid">
 ${gdprTypes.map(t => `
 <button class="gdpr-type-btn ${t.id === requestType ? 'active' : ''}" onclick="loadGdprTemplate('${t.id}')">
 <span class="type-icon">${t.icon}</span>
 <span class="type-name">${t.name}</span>
 <span class="type-desc">${t.description}</span>
 </button>
 `).join('')}
 </div>
 </div>
 <div id="gdprTemplateContent" class="gdpr-template-content">
 <div class="loading-placeholder">W√§hle eine Anfrageart...</div>
 </div>
 </div>
 </div>
 `;

 modal.style.display = 'flex';
 document.body.style.overflow = 'hidden';

 // Load default template
 loadGdprTemplate(requestType);
 }

 async function loadGdprTemplate(requestType) {
 const contentDiv = document.getElementById('gdprTemplateContent');
 contentDiv.innerHTML = '<div class="loading-placeholder">Lade Template...</div>';

 // Update active state
 document.querySelectorAll('.gdpr-type-btn').forEach(btn => {
 btn.classList.toggle('active', btn.textContent.toLowerCase().includes(requestType));
 });

 try {
 const response = await fetch(`${API_TEMPLATES_GDPR_URL}?requestType=${requestType}`);
 const data = await response.json();

 if (data.success && data.template) {
 const t = data.template;
 contentDiv.innerHTML = `
 <div class="gdpr-template-header">
 <div class="template-info">
 <h4>${t.icon} ${t.name}</h4>
 <span class="legal-basis">${t.legalBasis}</span>
 <span class="response-deadline">‚è± Frist: ${t.responseDeadline}</span>
 </div>
 </div>

 <div class="gdpr-form">
 <div class="form-group">
 <label>Betreff:</label>
 <input type="text" id="gdprSubject" value="${t.subject}" class="gdpr-input">
 </div>

 ${t.placeholders ? t.placeholders.map(p => `
 <div class="form-group">
 <label>${p.key.replace(/\{\{|\}\}/g, '')}${p.required ? ' *' : ''}:</label>
 <input type="text"
 data-placeholder="${p.key}"
 placeholder="${p.description}"
 class="gdpr-input gdpr-placeholder-input"
 oninput="updateGdprPreview()">
 </div>
 `).join('') : ''}

 <div class="form-group">
 <label>Vorschau:</label>
 <textarea id="gdprPreview" class="gdpr-preview" rows="12" readonly>${t.body}</textarea>
 </div>

 <div class="gdpr-tips">
 <h5> Tipps:</h5>
 <ul>
 ${t.tips.map(tip => `<li>${tip}</li>`).join('')}
 </ul>
 </div>

 <div class="gdpr-actions">
 <button class="copy-btn" onclick="copyGdprTemplate()"> Text kopieren</button>
 <button class="download-btn" onclick="downloadGdprTemplate('${t.name}')"> Als TXT herunterladen</button>
 </div>
 </div>
 `;

 // Store template body for updates
 window.currentGdprTemplate = t.body;
 }

 } catch (error) {
 contentDiv.innerHTML = '<p class="error-text">Fehler beim Laden des Templates</p>';
 }
 }

 function updateGdprPreview() {
 if (!window.currentGdprTemplate) return;

 let preview = window.currentGdprTemplate;
 document.querySelectorAll('.gdpr-placeholder-input').forEach(input => {
 const placeholder = input.dataset.placeholder;
 const value = input.value || placeholder;
 preview = preview.replace(new RegExp(placeholder.replace(/[{}]/g, '\\$&'), 'g'), value);
 });

 document.getElementById('gdprPreview').value = preview;
 }

 function copyGdprTemplate() {
 const subject = document.getElementById('gdprSubject').value;
 const body = document.getElementById('gdprPreview').value;
 const fullText = `Betreff: ${subject}\n\n${body}`;

 navigator.clipboard.writeText(fullText).then(() => {
 const btn = document.querySelector('.gdpr-actions .copy-btn');
 btn.innerHTML = ' Kopiert!';
 setTimeout(() => btn.innerHTML = ' Text kopieren', 2000);
 });
 }

 function downloadGdprTemplate(name) {
 const subject = document.getElementById('gdprSubject').value;
 const body = document.getElementById('gdprPreview').value;
 const fullText = `Betreff: ${subject}\n\n${body}`;

 const blob = new Blob([fullText], { type: 'text/plain;charset=utf-8' });
 const url = URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `DSGVO-${name}-${new Date().toISOString().split('T')[0]}.txt`;
 a.click();
 URL.revokeObjectURL(url);
 }

 function closeGdprGenerator() {
 const modal = document.getElementById('gdprGeneratorModal');
 if (modal) {
 modal.style.display = 'none';
 document.body.style.overflow = '';
 }
 }

 // Template Search Functions
 async function handleTemplateSearch(e) {
 const query = e.target.value.trim();
 const resultsDiv = document.getElementById('templatesSearchResults');

 if (query.length < 2) {
 resultsDiv.style.display = 'none';
 return;
 }

 resultsDiv.innerHTML = '<div class="search-loading">Suche...</div>';
 resultsDiv.style.display = 'block';

 try {
 const response = await fetch(`${API_TEMPLATES_SEARCH_URL}?q=${encodeURIComponent(query)}`);
 const data = await response.json();

 if (data.success && data.results) {
 if (data.results.length === 0) {
 resultsDiv.innerHTML = '<div class="search-no-results">Keine Ergebnisse gefunden</div>';
 } else {
 resultsDiv.innerHTML = `
 <div class="search-results-list">
 ${data.results.map(r => `
 <button class="search-result-item" onclick="selectSearchResult('${r.id}', '${r.category}')">
 <span class="result-name">${r.name}</span>
 <span class="result-category">${r.category.replace(/_/g, ' ')}</span>
 </button>
 `).join('')}
 </div>
 `;
 }
 }

 } catch (error) {
 resultsDiv.innerHTML = '<div class="search-error">Fehler bei der Suche</div>';
 }
 }

 function selectSearchResult(templateId, categoryId) {
 document.getElementById('templatesSearchResults').style.display = 'none';
 document.getElementById('templatesSearchInput').value = '';
 currentTemplateCategory = categoryId;
 selectTemplate(templateId);
 }

 // Favorites Functions
 function toggleFavorite(templateId) {
 const index = templateFavorites.indexOf(templateId);
 if (index === -1) {
 templateFavorites.push(templateId);
 } else {
 templateFavorites.splice(index, 1);
 }

 localStorage.setItem('templateFavorites', JSON.stringify(templateFavorites));
 updateFavoriteButtons();

 // Sync with backend (non-blocking)
 fetch(API_TEMPLATES_FAVORITES_URL, {
 method: 'POST',
 headers: { 'Content-Type': 'application/json' },
 body: JSON.stringify({
 templateId: templateId,
 action: index === -1 ? 'add' : 'remove',
 sessionId: coachSessionId
 })
 }).catch(() => {});
 }

 function isFavorite(templateId) {
 return templateFavorites.includes(templateId);
 }

 function updateFavoriteButtons() {
 document.querySelectorAll('.favorite-btn').forEach(btn => {
 const templateId = btn.dataset.templateId;
 const isFav = isFavorite(templateId);
 btn.innerHTML = isFav ? '' : '';
 btn.classList.toggle('active', isFav);
 });
 }

 // ========================================
 // Initialize Everything
 // ========================================

 document.addEventListener('DOMContentLoaded', async function() {
 // Initialize Phase 2 features
 initTabs();
 initBatchAnalysis();
 checkApiHealth();

 // Initialize Phase 3 accessibility features
 loadAccessibilityPreferences();

 // Initialize Phase 4 features
 initDocumentUpload();
 initPWA();

 // Initialize Phase 5 features
 initPredictivePrivacy();

 // Initialize Phase 7 features
 initFootprintScanner();

 // Initialize Phase 10 features
 initPrivacyCoach();

 // Initialize Phase 13 features
 initPolicyAnalyzer();

 // Initialize Phase 9 features
 initDataBreachAlerts();

 // Initialize Phase 11 features
 initPrivacyTemplates();

 // Load saved language preference
 const savedLang = localStorage.getItem('achtung-lang') || 'de';
 translations[savedLang] = await loadTranslations(savedLang);
 if (savedLang !== 'de') {
 switchLanguage(savedLang);
 } else {
 // Load DE translations for t() function
 translations['de'] = await loadTranslations('de');
 }

 // Cache offline patterns for PWA
 cacheOfflinePatterns();

 // Check health every 60 seconds
 setInterval(checkApiHealth, 60000);

 if (typeof achtungAuth !== 'undefined') {
 if (achtungAuth.isAuthenticated()) {
 document.querySelectorAll('.protected-content').forEach(el => {
 el.style.display = 'block';
 });
 document.querySelectorAll('.auth-required').forEach(el => {
 el.style.display = 'none';
 });
 document.getElementById('logoutBtn').style.display = 'block';
 } else {
 achtungAuth.protectPage();
 }
 }
 });
 </script>
</body>
</html>
